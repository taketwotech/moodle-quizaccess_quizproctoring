!function(){let a,i=[],e,c,t,u=!1,s=null,l=null,d=!1,m=!1,p=!1;const g="audioChunks";let h;var n;function f(){a&&"recording"===a.state&&a.stop()}function b(r=!1,a=!1){return!h||m?Promise.resolve():new Promise((t,n)=>{const o=h.transaction([g],"readonly").objectStore(g).getAll();o.onsuccess=function(){var e=o.result;5<=e.length||r&&0<e.length?(console.log(`Uploading ${e.length} chunks from IndexedDB`),function(e,t=!1){if(m||0===e.length)return Promise.resolve();m=!0;const n=new FormData,o=document.querySelector('input[name="attempt"]')?.value||"",r=localStorage.getItem("quizid"),a=[],i=(e.forEach((e,t)=>{n.append("audio"+t,e.blob,`audio${t}.webm`),a.push(e.timestamp)}),n.append("attemptid",o),n.append("quizid",r),n.append("timestamps",JSON.stringify(a)),M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/upload_audio.php");return fetch(i,{method:"POST",body:n,keepalive:t}).then(e=>e.json()).then(e=>{var t;return console.log("Uploaded chunks:",e),t=h.transaction([g],"readwrite"),t.objectStore(g).clear(),t.oncomplete=()=>{console.log("IndexedDB cleared after upload")},m=!1,e}).catch(e=>{throw console.error("Upload error:",e),m=!1,e})}(e,a).then(t).catch(n)):(r&&0===e.length&&console.log("No chunks to upload"),t())},o.onerror=function(){n(new Error("Failed to read from IndexedDB"))}})}function y(){return p?(console.log("Upload already in progress, skipping duplicate call..."),Promise.resolve()):(p=!0,new Promise(e=>{console.log("Navigation action detected — checking for chunks to upload");const t=()=>{p=!1,e()};a&&"recording"===a.state?(a.onstop=function(){if(d)b(!0,!1).then(t).catch(()=>t());else{var e=[];for(const n of i)e.push(new Promise(e=>{var t=h.transaction([g],"readwrite").objectStore(g).add({blob:n.blob,timestamp:n.timestamp});t.onsuccess=()=>e(),t.onerror=()=>e()}));Promise.all(e).then(()=>{d=!0,i=[],setTimeout(()=>{b(!0,!1).then(t).catch(()=>t())},200)})}},a.stop()):b(!0,!1).then(t).catch(()=>t())}))}(n=indexedDB.open("audioRecordingsDB",1)).onupgradeneeded=function(e){(h=e.target.result).objectStoreNames.contains(g)||h.createObjectStore(g,{autoIncrement:!0})},n.onsuccess=function(e){h=e.target.result,console.log("IndexedDB initialized"),(window.location.href.includes("/review.php")||window.location.href.includes("/summary.php"))&&b(!0)},n.onerror=function(e){console.error("IndexedDB error:",e.target.errorCode)},window.useraudiorecord=function(n){console.log("Audio monitoring started"),e=new(window.AudioContext||window.webkitAudioContext),c=e.createAnalyser(),(t=e.createMediaStreamSource(n)).connect(c),c.fftSize=256;const o=c.frequencyBinCount,r=new Uint8Array(o);setInterval(function(){c.getByteFrequencyData(r);let t=0;for(let e=0;e<o;e++)t+=r[e];var e;30<t/o?u?s&&(clearTimeout(s),s=null):(console.log("Sound detected — starting recording"),e=(e=n).getAudioTracks(),e=new MediaStream(e),a=new MediaRecorder(e),i=[],d=!1,u=!0,a.ondataavailable=function(e){0<e.data.size&&i.push({blob:e.data,timestamp:Math.floor(Date.now()/1e3)})},a.onstop=function(){if(!d){for(const o of i)e=o.blob,t=o.timestamp,n=void 0,n=h.transaction([g],"readwrite"),n.objectStore(g).add({blob:e,timestamp:t}),n.oncomplete=()=>{console.log("Audio chunk with timestamp saved to IndexedDB"),b()},n.onerror=e=>{console.error("IndexedDB error:",e.target.error)};d=!0,i=[]}var e,t,n;u=!1,s=null,clearTimeout(l)},a.start(),l=setTimeout(()=>{console.log("Max duration reached — stopping recording"),f()},6e4)):u&&!s&&(s=setTimeout(()=>{console.log("Silence detected — stopping recording"),f()},5e3))},500)};let v=null;document.addEventListener("click",function(e){var t,e=e.target;("INPUT"===e.tagName&&"submit"===e.type||"BUTTON"===e.tagName&&("submit"===e.type||!e.type))&&(t=e.closest("form"))&&("responseform"===t.id||t.classList.contains("quizform")||t.querySelector('input[name="next"]')||t.querySelector('input[name="previous"]')||t.querySelector('input[name="back"]')||t.querySelector('input[name="finishattempt"]'))&&(v=e)},!0),document.addEventListener("submit",function(e){const t=e.target;if(!p&&"true"!==t.dataset.programmaticSubmit&&"FORM"===t.tagName&&(t.querySelector('input[name="next"]')||t.querySelector('input[name="previous"]')||t.querySelector('input[name="back"]')||t.querySelector('input[name="finishattempt"]')||t.querySelector('button[name="next"]')||t.querySelector('button[name="previous"]')||t.querySelector('button[name="back"]')||t.querySelector('button[name="finishattempt"]')||"responseform"===t.id||t.classList.contains("quizform"))){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const n=v||e.submitter||t.querySelector('input[type="submit"]:focus, button[type="submit"]:focus')||t.querySelector('input[name="next"], input[name="previous"], input[name="back"], input[name="finishattempt"]')||t.querySelector('button[name="next"], button[name="previous"], button[name="back"], button[name="finishattempt"]')||t.querySelector('input[type="submit"], button[type="submit"]'),o=n?n.name:"",r=n?n.value:"";v=null,n&&(n.disabled=!0),y().then(()=>{var e;n&&(n.disabled=!1),t.dataset.programmaticSubmit="true",o&&((e=t.querySelector(`input[type="hidden"][name="${o}"]`))&&e.remove(),(e=document.createElement("input")).type="hidden",e.name=o,r&&(e.value=r),t.appendChild(e)),o&&!(e=t.querySelector(`input[type="hidden"][name="${o}"]`))&&((e=document.createElement("input")).type="hidden",e.name=o,r&&(e.value=r),t.appendChild(e)),setTimeout(()=>{HTMLFormElement.prototype.submit.call(t)},50)}).catch(()=>{var e;n&&(n.disabled=!1),t.dataset.programmaticSubmit="true",o&&((e=t.querySelector(`input[type="hidden"][name="${o}"]`))&&e.remove(),(e=document.createElement("input")).type="hidden",e.name=o,r&&(e.value=r),t.appendChild(e)),o&&!(e=t.querySelector(`input[type="hidden"][name="${o}"]`))&&((e=document.createElement("input")).type="hidden",e.name=o,r&&(e.value=r),t.appendChild(e)),setTimeout(()=>{HTMLFormElement.prototype.submit.call(t)},50)})}},!0),document.addEventListener("click",function(t){if(!p){const a=t.target;var n=a.name||a.getAttribute("name")||"",o=a.value||a.textContent||"",r=a.id||"";let e=!1;("BUTTON"===a.tagName&&"submit"!==a.type||"INPUT"===a.tagName&&"submit"!==a.type)&&("next"===n||"previous"===n||"back"===n||"finishattempt"===n||o.toLowerCase().includes("next")||o.toLowerCase().includes("previous")||o.toLowerCase().includes("back")||o.toLowerCase().includes("finish")||r.includes("next")||r.includes("previous")||r.includes("back")||r.includes("finish"))&&(e=!0),(e="A"===a.tagName&&(a.href.includes("attempt.php")||a.href.includes("summary.php")||a.href.includes("review.php"))?!0:e)&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),"BUTTON"!==a.tagName&&"INPUT"!==a.tagName||(a.disabled=!0),y().then(()=>{"BUTTON"===a.tagName||"INPUT"===a.tagName?(a.disabled=!1,setTimeout(()=>{a.click()},50)):"A"===a.tagName&&(window.location.href=a.href)}).catch(()=>{"BUTTON"===a.tagName||"INPUT"===a.tagName?(a.disabled=!1,setTimeout(()=>{a.click()},50)):"A"===a.tagName&&(window.location.href=a.href)}))}},!0),window.addEventListener("beforeunload",function(e){a&&"recording"===a.state?(console.log("Page is refreshing — stopping current recording and saving..."),a.onstop=function(){if(d)b(!0,!0);else{var e=[];for(const n of i)e.push(new Promise(e=>{var t=h.transaction([g],"readwrite").objectStore(g).add({blob:n.blob,timestamp:n.timestamp});t.onsuccess=()=>e(),t.onerror=()=>e()}));Promise.all(e).then(()=>{d=!0,i=[],setTimeout(()=>{b(!0,!0)},100)})}},a.stop()):b(!0,!0)})}();