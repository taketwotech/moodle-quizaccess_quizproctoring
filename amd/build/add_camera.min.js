/**
 * JavaScript class for Camera
 *
 * @subpackage quizproctoring
 * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
window.addEventListener("beforeunload",(function(event){event.stopImmediatePropagation(),event.returnValue=""})),define("quizaccess_quizproctoring/add_camera",["jquery","core/str","core/modal_factory","core/ajax"],(function($,str,ModalFactory,ajax){var Camera=function(cmid){let mainimage=arguments.length>1&&void 0!==arguments[1]&&arguments[1],attemptid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,quizid=arguments.length>3?arguments[3]:void 0;var docElement=$(document);this.video=document.getElementById(this.videoid),this.canvas=document.getElementById(this.canvasid),this.cmid=cmid,this.quizid=quizid,this.mainimage=mainimage,this.attemptid=attemptid,$("#id_submitbutton").prop("disabled",!0),docElement.on("popup",this.showpopup.bind(this)),setTimeout(navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then((function(stream){return!this.video||(this.video.srcObject=stream,this.video.muted=!0,local_media_stream=stream,startRecording(),this.video.play(),!0)})).catch((function(){})),1e4)};Camera.prototype.video=!1,Camera.prototype.videoid="video",Camera.prototype.canvas=!1,Camera.prototype.canvasid="canvas",Camera.prototype.width=320,Camera.prototype.height=240,Camera.prototype.takepictureid="takepicture",Camera.prototype.retakeid="retake",Camera.prototype.cmid=!1,Camera.prototype.mainimage=!1,Camera.prototype.attemptid=!1,Camera.prototype.quizid=!1,Camera.prototype.takepicture=function(){this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);var data=this.canvas.toDataURL("image/png");$("#"+this.videoid).hide(),$("#"+this.takepictureid).hide(),$("#"+this.canvasid).show(),$("#"+this.retakeid).show(),$("input[name='userimg']").val(data),$("#id_submitbutton").prop("disabled",!0),$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:{imgBase64:data,cmid:this.cmid,attemptid:this.attemptid,mainimage:this.mainimage},success:function(response){response&&response.errorcode?($("input[name='userimg']").val(""),$(document).trigger("popup",response.error)):$("#id_submitbutton").prop("disabled",!1)}})},Camera.prototype.proctoringimage=function(){this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);var data=this.canvas.toDataURL("image/png"),quizid=this.quizid,cmid=this.cmid,attemptid=this.attemptid;$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:{imgBase64:data,cmid:this.cmid,attemptid:this.attemptid,mainimage:this.mainimage},success:function(response){response&&response.errorcode?(console.log(response.errorcode),response.errorcode.length>35?stopRecording(quizid,attemptid,cmid,"Finish attempt ..."):$(document).trigger("popup",response.error)):response.redirect&&response.url&&(window.onbeforeunload=null,window.location.href=encodeURI(response.url))}})};var recordRTC,signaling_socket=null,local_media_stream=null,peers={},peer_media_elements={},connectedPeers={},ICE_SERVERS=[{urls:"stun:stun.l.google.com:19302"}];Camera.prototype.retake=function(){$("input[name='userimg']").val(""),$("#"+this.videoid).show(this.cmid),$("#"+this.takepictureid).show(),$("#"+this.canvasid).hide(),$("#"+this.retakeid).hide()},Camera.prototype.showpopup=function(event,message){return ModalFactory.create({body:message}).then((function(modal){return modal.show(),null}))};return{init:function(cmid,mainimage){let verifyduringattempt=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],attemptid=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,teacher=arguments.length>4?arguments[4]:void 0,quizid=arguments.length>5?arguments[5]:void 0,externalserver=arguments.length>6?arguments[6]:void 0,serviceoption=arguments.length>7?arguments[7]:void 0,proctoringrecording=arguments.length>8?arguments[8]:void 0,browsersecurity=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,setinterval=arguments.length>10&&void 0!==arguments[10]?arguments[10]:300;if(verifyduringattempt){function adjustLayout(){var videoElements=$("#region-main").children("video"),totalVideos=videoElements.length;if(totalVideos>1){var rows=Math.ceil(Math.sqrt(totalVideos)),cols=Math.ceil(totalVideos/rows);videoElements.each((function(index){var row=Math.floor(index/cols),col=index%cols;$(this).css({position:"absolute",top:240*row+"px",left:320*col+"px"})}))}}function restoreSessionState(sessionState){for(var peer_id in sessionState.connectedPeers){var peer=sessionState.connectedPeers[peer_id],peer_connection=new RTCPeerConnection({iceServers:ICE_SERVERS},{optional:[{DtlsSrtpKeyAgreement:!0}]});for(var track of(peers[peer_id]=peer_connection,peer_connection.onicecandidate=function(event){event.candidate&&signaling_socket.emit("relayICECandidate",{peer_id:peer_id,ice_candidate:{sdpMLineIndex:event.candidate.sdpMLineIndex,candidate:event.candidate.candidate}})},peer_connection.ontrack=function(event){var remote_media;(peer.stream.addTrack(event.track),peer_media_elements[peer_id])?remote_media=peer_media_elements[peer_id]:((remote_media=$("<video>")).attr("autoplay","autoplay"),remote_media.attr("muted","true"),remote_media.attr("controls",""),peer_media_elements[peer_id]=remote_media,"teacher"===getTeacherroom()&&($("#region-main-box").append(remote_media),attachMediaStream(remote_media[0],stream)));attachMediaStream(remote_media[0],peer.stream)},peer_connection.addStream(local_media_stream),peer.stream.getTracks()))peer_connection.addTrack(track,peer.stream);peer_connection.createOffer((function(local_description){peer_connection.setLocalDescription(local_description,(function(){signaling_socket.emit("relaySessionDescription",{peer_id:peer_id,session_description:local_description})}),(function(){console.error("Offer setLocalDescription failed!")}))}),(function(error){console.error("Error creating offer: ",error)}))}}"securewindow"===browsersecurity&&(document.onkeydown=function(e){return!1},document.addEventListener("keyup",(e=>{"PrintScreen"==e.key&&(e.preventDefault(),navigator.clipboard.writeText("")),18===e.keyCode&&e.preventDefault()})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"p"==e.key&&(e.cancelBubble=!0,e.preventDefault(),e.stopImmediatePropagation())}))),(signaling_socket=io(externalserver)).on("connect",(function(){console.log("Connected to signaling server..");var storedSession=localStorage.getItem("sessionState"),sessionState=storedSession?JSON.parse(storedSession):null;setup_local_media(cmid,mainimage,verifyduringattempt,attemptid,teacher,browsersecurity,setinterval,serviceoption,proctoringrecording,quizid,(function(){var room=getRoomFromQuery(quizid),teacherroom=getTeacherroom();join_chat_channel(room,{quizid:quizid,type:{type:"teacher"===teacherroom?"teacher":"student"}}),sessionState&&restoreSessionState(sessionState)}))})),signaling_socket.on("disconnect",(function(){for(peer_id in console.log("Disconnected from signaling server"),peer_media_elements)peer_media_elements[peer_id].remove();for(peer_id in peers)peers[peer_id].close();peers={},peer_media_elements={}})),signaling_socket.on("addPeer",(function(config){console.log("Signaling server said to add peer:",config);var peer_id=config.peer_id;if(peer_id in peers)console.log("Already connected to peer ",peer_id);else{var peer_connection=new RTCPeerConnection({iceServers:ICE_SERVERS},{optional:[{DtlsSrtpKeyAgreement:!0}]});peers[peer_id]=peer_connection,connectedPeers[peer_id]={stream:new MediaStream,recordRTC:null},peer_connection.onicecandidate=function(event){event.candidate&&signaling_socket.emit("relayICECandidate",{peer_id:peer_id,ice_candidate:{sdpMLineIndex:event.candidate.sdpMLineIndex,candidate:event.candidate.candidate}})},peer_connection.ontrack=function(event){var remote_media;(console.log("ontrack",event),connectedPeers[peer_id].stream.addTrack(event.track),peer_media_elements[peer_id])?remote_media=peer_media_elements[peer_id]:((remote_media=$("<video>")).attr("autoplay","autoplay"),remote_media.attr("muted","true"),remote_media.attr("controls",""),remote_media.attr("class","quizaccess_quizproctoring"),remote_media.attr("muted","true"),remote_media.attr("controls",""),peer_media_elements[peer_id]=remote_media,"teacher"===getTeacherroom()&&($("#region-main-box").append(remote_media),attachMediaStream(remote_media[0],connectedPeers[peer_id].stream)))},peer_connection.addStream(local_media_stream),config.should_create_offer&&(console.log("Creating RTC offer to ",peer_id),peer_connection.createOffer((function(local_description){console.log("Local offer description is: ",local_description),peer_connection.setLocalDescription(local_description,(function(){signaling_socket.emit("relaySessionDescription",{peer_id:peer_id,session_description:local_description}),console.log("Offer setLocalDescription succeeded")}),(function(){Alert("Offer setLocalDescription failed!")}))}),(function(error){console.log("Error sending offer: ",error)})))}})),signaling_socket.on("sessionDescription",(function(config){console.log("Remote description received: ",config);var peer_id=config.peer_id,peer=peers[peer_id],remote_description=config.session_description;console.log(config.session_description);var desc=new RTCSessionDescription(remote_description);peer.setRemoteDescription(desc,(function(){console.log("setRemoteDescription succeeded"),"offer"==remote_description.type&&(console.log("Creating answer"),peer.createAnswer((function(local_description){console.log("Answer description is: ",local_description),peer.setLocalDescription(local_description,(function(){signaling_socket.emit("relaySessionDescription",{peer_id:peer_id,session_description:local_description}),console.log("Answer setLocalDescription succeeded")}),(function(){Alert("Answer setLocalDescription failed!")}))}),(function(error){console.log("Error creating answer: ",error),console.log(peer)})))}),(function(error){console.log("setRemoteDescription error: ",error)}));console.log("Description Object: ",desc)})),signaling_socket.on("iceCandidate",(function(config){var peer=peers[config.peer_id],ice_candidate=config.ice_candidate;peer.addIceCandidate(new RTCIceCandidate(ice_candidate))})),signaling_socket.on("removePeer",(function(config){console.log("Signaling server said to remove peer:",config);var peer_id=config.peer_id;if(peer_id in peers){peers[peer_id].removeStream(connectedPeers[peer_id].stream),peers[peer_id].close(),delete connectedPeers[peer_id];var remote_media=peer_media_elements[peer_id];remote_media&&(remote_media.remove(),adjustLayout()),delete peers[peer_id],delete peer_media_elements[peer_id]}else console.log("["+socket.id+"] ERROR: peer_id does not exist",peer_id)})),$("#mod_quiz-next-nav").click((function(event){$("#responseform").append('<input type="hidden" name="next" value="Next page">'),event.preventDefault(),$("#page-wrapper").append('<img src="/mod/quiz/accessrule/quizproctoring/pix/loading.gif" id="loading">'),$("#loading").show(),$("#mod_quiz-prev-nav").prop("disabled",!0),$("#mod_quiz-next-nav").prop("disabled",!0),stopRecording(quizid,attemptid,cmid)})),$("#mod_quiz-prev-nav").click((function(event){$("#responseform").append('<input type="hidden" name="previous" value="Previous page">'),event.preventDefault(),$("#page-wrapper").append('<img src="/mod/quiz/accessrule/quizproctoring/pix/loading.gif" id="loading">'),$("#loading").show(),$("#mod_quiz-prev-nav").prop("disabled",!0),$("#mod_quiz-next-nav").prop("disabled",!0),stopRecording(quizid,attemptid,cmid)})),$("#endtestlink").click((function(event){var text=document.getElementById("endtestlink").innerHTML;console.log(text),event.preventDefault(),$("#page-wrapper").append('<img src="/mod/quiz/accessrule/quizproctoring/pix/loading.gif" id="loading">'),$("#loading").show(),$("#endtestlink").prop("disabled",!0),stopRecording(quizid,attemptid,cmid,text)}))}else{var camera;camera=new Camera(cmid,mainimage,attemptid,quizid),$("#"+camera.takepictureid).on("click",(function(e){e.preventDefault(),camera.takepicture()})),$("#"+camera.retakeid).on("click",(function(e){e.preventDefault(),camera.retake()}))}}};function startRecording(){(recordRTC=RecordRTC(local_media_stream,{type:"video"})).startRecording(),!0}function stopRecording(quizid,attemptid,cmid){let text=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";function uploadToServer(recordRTC,quizid,attemptid,cmid,callback){var blob=recordRTC instanceof Blob?recordRTC:recordRTC.blob,fileType=blob.type.split("/")[0]||"audio",fileName=(1e3*Math.random()).toString().replace(".","");fileName+="audio"===fileType?"."+(navigator.mozGetUserMedia?"ogg":"wav"):".webm";var formData=new FormData;formData.append(fileType+"-filename",fileName),formData.append(fileType+"-blob",blob),formData.append("cmid",cmid),formData.append("quizid",quizid),formData.append("attemptid",attemptid),callback("Uploading "+fileType+" recording to server.");makeXMLHttpRequest("/mod/quiz/accessrule/quizproctoring/save.php",formData,(function(progress){"upload-ended"===progress?callback("ended",fileName):callback(progress)}))}function makeXMLHttpRequest(url,data,callback){var request=new XMLHttpRequest;request.onreadystatechange=function(){4==request.readyState&&200==request.status&&callback("upload-ended")},request.upload.onloadstart=function(){callback("Upload started...")},request.upload.onprogress=function(event){callback("Upload Progress "+Math.round(event.loaded/event.total*100)+"%")},request.upload.onload=function(){callback("progress-about-to-end")},request.upload.onload=function(){callback("progress-ended")},request.upload.onerror=function(error){callback("Failed to upload to server"),console.error("XMLHttpRequest failed",error)},request.upload.onabort=function(error){callback("Upload aborted."),console.error("XMLHttpRequest aborted",error)},request.open("POST",url),request.send(data)}require(["core/ajax"],(function(ajax){recordRTC&&recordRTC.stopRecording((function(videoURL){console.log(videoURL);$("<video controls>").attr("src",videoURL);uploadToServer(recordRTC,quizid,attemptid,cmid,(function(progress,fileURL){if("ended"===progress){console.log("save successfully"),console.log(quizid),videopath=fileURL;const requestvideo={methodname:"quizaccess_quizproctoring_save_video_recording",args:{videoURL:fileURL,quizid:quizid,attemptid:attemptid,text:text,currenturl:window.location.href}};ajax.call([requestvideo])[0].done((function(result){!0===result.success&&(console.log(result),$("#loading").hide(),result.url?window.location.href=result.url:$("#responseform").submit())}))}}))}))})),!1}function setup_local_media(cmid,mainimage,verifyduringattempt,attemptid,teacher,browsersecurity,setinterval,serviceoption,proctoringrecording,quizid,callback,errorback){require(["core/ajax"],(function(ajax){null==local_media_stream?(console.log("Requesting access to local audio/video i/p"),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,attachMediaStream=function(element,stream){console.log("DEPRECATED, attachMediaStream will soon be removed."),element.srcObject=stream},navigator.mediaDevices.getUserMedia({audio:true,video:true}).then((function(stream){var camera;console.log("Access granted to audio/video"),local_media_stream=stream;(console.log(browsersecurity),verifyduringattempt)&&("teacher"!==getTeacherroom()&&($("<canvas>").attr({id:"canvas",width:"280",height:"240",style:"display: none;"}).appendTo("body"),$("<video>").attr({id:"video",class:"quizaccess_quizproctoring-video",width:"280",height:"240",autoplay:"autoplay"}).appendTo("body"),teacher||"securewindow"!==browsersecurity||window.addEventListener("blur",(function(){1;const request={methodname:"quizaccess_quizproctoring_save_threshold_warning",args:{quizid:quizid,attemptid:attemptid,serviceoption:serviceoption}};ajax.call([request])[0].done((function(result){result.finish?stopRecording(quizid,attemptid,cmid,"Finish attempt ..."):$(document).trigger("popup",result.warning)}))}),!1),camera=new Camera(cmid,mainimage,attemptid,quizid),setInterval(camera.proctoringimage.bind(camera),1e3*setinterval)));callback&&callback()}))):callback&&callback()}))}function getRoomFromQuery(room){return console.log("Room from URL:",room),room||DEFAULT_CHANNEL}function getTeacherroom(){var teacher=new URLSearchParams(window.location.search).get("teacher");return console.log("teacher from URL:",teacher),teacher}function join_chat_channel(room,userdata){console.log("Join room"),signaling_socket.emit("join",{room:room,userdata:userdata})}}));

//# sourceMappingURL=add_camera.min.js.map