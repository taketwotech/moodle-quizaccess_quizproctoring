{"version":3,"file":"add_camera.min.js","sources":["../src/add_camera.js"],"sourcesContent":["/**\n * JavaScript class for Camera\n *\n * @subpackage quizproctoring\n * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nwindow.addEventListener('beforeunload', function(event) {\n    event.stopImmediatePropagation();\n    event.returnValue = '';\n});\ndefine(['jquery', 'core/str', 'core/modal_factory'],\nfunction($, str, ModalFactory) {\n    $('.quizstartbuttondiv [type=submit]').prop(\"disabled\", true);\n    var Camera = function(cmid, mainimage = false, attemptid = null, quizid) {\n        var docElement = $(document);\n        this.video = document.getElementById(this.videoid);\n        this.canvas = document.getElementById(this.canvasid);\n        this.cmid = cmid;\n        this.quizid = quizid;\n        this.mainimage = mainimage;\n        this.attemptid = attemptid;\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n        docElement.on('popup', this.showpopup.bind(this));\n    };\n\n    $('#id_consentcheckbox').on('change', function() {\n        if (!$(this).is(':checked')) {\n            $(\"#id_submitbutton\").prop(\"disabled\", true);\n        } else if ($(this).is(':checked') && $('#userimageset').val() == 0) {\n            $(\"#id_submitbutton\").prop(\"disabled\", true);\n        } else if ($(this).is(':checked') && $('#userimageset').val() == 1) {\n            $(\"#id_submitbutton\").prop(\"disabled\", false);\n        }\n    });\n\n    /** @type Tag element contain video. */\n    Camera.prototype.video = false;\n    /** @type String video elemend id. */\n    Camera.prototype.videoid = 'video';\n    /** @type Tag element contain canvas. */\n    Camera.prototype.canvas = false;\n    /** @type String video elemend id. */\n    Camera.prototype.canvasid = 'canvas';\n    /** @type int width of canvas object. */\n    Camera.prototype.width = 320;\n    /** @type int width of canvas object. */\n    Camera.prototype.height = 240;\n    /** @type String element contain takepicture button. */\n    Camera.prototype.takepictureid = 'takepicture';\n    /** @type String element contain retake button. */\n    Camera.prototype.retakeid = 'retake';\n    /** @type int course module id. */\n    Camera.prototype.cmid = false;\n    /** @type bool whether a main image or compare against an image. */\n    Camera.prototype.mainimage = false;\n     /** @type int attempt id. */\n    Camera.prototype.attemptid = false;\n     /** @type int quiz id. */\n    Camera.prototype.quizid = false;\n\n    Camera.prototype.startcamera = function() {\n        const takePictureButton = $('#' + this.takepictureid);\n        takePictureButton.prop('disabled', true);\n        return navigator.mediaDevices.getUserMedia({video: true, audio: true})\n            .then(function(stream) {\n                const videoElement = document.getElementById('video');\n                if (videoElement) {\n                    videoElement.srcObject = stream;\n                    videoElement.muted = true;\n                    videoElement.playsinline = true;\n                    localMediaStream = stream;\n                    videoElement.play();\n\n                    videoElement.addEventListener('contextmenu', function(e) {\n                        e.preventDefault();\n                    });\n\n                    stream.getVideoTracks()[0].onended = function() {\n                        takePictureButton.prop('disabled', true);\n                        $(document).trigger('popup', 'Camera or microphone is disabled. Please enable both to continue.');\n                    };\n\n                    const audioTrack = stream.getAudioTracks()[0];\n                    if (audioTrack) {\n                        audioTrack.onended = function() {\n                            $(document).trigger('popup', 'Camera or microphone is disabled. Please enable both to continue.');\n                        };\n                    } else {\n                        $(document).trigger('popup', 'Camera or microphone is disabled. Please enable both to continue.');\n                    }\n                    restoreVideoPosition(videoElement);\n                    makeDraggable(videoElement);\n                    takePictureButton.prop('disabled', false);\n                }\n                return videoElement;\n            })\n            .catch(function() {\n                takePictureButton.prop('disabled', true);\n            });\n    };\n\n    Camera.prototype.takepicture = function() {\n        var context = this.canvas.getContext('2d');\n        context.drawImage(this.video, 0, 0, this.width, this.height);\n        var data = this.canvas.toDataURL('image/png');\n        $('#' + this.videoid).hide();\n        $('#' + this.takepictureid).hide();\n        $('#' + this.canvasid).show();\n        $('#' + this.retakeid).show();\n        $('#userimageset').val(1);\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n        $.ajax({\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n            method: 'POST',\n            data: {imgBase64: data, cmid: this.cmid, attemptid: this.attemptid, mainimage: this.mainimage},\n            success: function(response) {\n                if (response && response.errorcode) {\n                    $('#userimageset').val(0);\n                    $(document).trigger('popup', response.error);\n                } else {\n                    if ($('#id_consentcheckbox').is(':checked')) {\n                        $(\"#id_submitbutton\").prop(\"disabled\", false);\n                    }\n                }\n            }\n        });\n    };\n    Camera.prototype.proctoringimage = function() {\n        var requestData = {\n            cmid: this.cmid,\n            attemptid: this.attemptid,\n            mainimage: this.mainimage\n        };\n        if (this.canvas) {\n            var context = this.canvas.getContext('2d');\n            context.drawImage(this.video, 0, 0, this.width, this.height);\n            var data = this.canvas.toDataURL('image/png');\n            requestData.imgBase64 = data;\n        }\n        $.ajax({\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n            method: 'POST',\n            data: requestData,\n            success: function(response) {\n                if (response && response.errorcode) {\n                    var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                    var leftwarnings = Math.max(warningsl - 1, 0);\n                    localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                    $(document).trigger('popup', response.error);\n                } else {\n                    if (response.redirect && response.url) {\n                        window.onbeforeunload = null;\n                        $(document).trigger('popup', response.msg);\n                        setTimeout(function() {\n                            window.location.href = encodeURI(response.url);\n                        }, 3000);\n                    }\n                }\n            }\n        });\n    };\n\n    Camera.prototype.resetcamera = function() {\n        var context = this.canvas.getContext('2d');\n        context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n        $('#' + this.canvasid).hide();\n        $('#' + this.retakeid).hide();\n        $('#' + this.videoid).show();\n        $('#' + this.takepictureid).show();\n        $('#userimageset').val(0);\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n    };\n\n    var signalingSocket = null;\n    var externalserver = 'https://proctoring.taketwotechnologies.com';\n    var localMediaStream = null;\n    var peers = {};\n    var peerId = null;\n    var peerMediaElements = {};\n    var connectedPeers = {};\n    var USE_AUDIO = true;\n    var USE_VIDEO = true;\n    var MUTE_AUDIO_BY_DEFAULT = true;\n    var attachMediaStream = null;\n    var stream = null;\n    var total = 0;\n    let cachedStudentData = null;\n    var ICE_SERVERS = [{urls: \"stun:stun.l.google.com:19302\"}];\n\n    Camera.prototype.retake = function() {\n        $('#userimageset').val(0);\n        $('#' + this.videoid).show(this.cmid);\n        $('#' + this.takepictureid).show();\n        $('#' + this.canvasid).hide();\n        $('#' + this.retakeid).hide();\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n    };\n    Camera.prototype.showpopup = function(event, message) {\n        if (this.activeModal) {\n            this.activeModal.hide();\n            this.activeModal.destroy();\n        }\n        return ModalFactory.create({\n            body: message,\n        }).then((modal) => {\n            this.activeModal = modal;\n            modal.show();\n            return null;\n        }).catch(() => {\n            showCustomModal(message);\n        });\n    };\n\n    Camera.prototype.stopcamera = function() {\n        if (localMediaStream) {\n            localMediaStream.getTracks().forEach(function(track) {\n                track.stop();\n            });\n            localMediaStream = null;\n        }\n    };\n\n    var init = function(cmid, mainimage, verifyduringattempt = true, attemptid = null,\n        teacher, quizid, serviceoption, studenthexstring, onlinestudent = 0, securewindow = null, userfullname,\n        enablestudentvideo = 1, setinterval = 300,\n        warnings = 0) {\n        const noStudentOnlineDiv = document.getElementById('nostudentonline');\n        if (!verifyduringattempt) {\n            var camera;\n            if (document.readyState === 'complete') {\n                $('.quizstartbuttondiv [type=submit]').prop(\"disabled\", false);\n            } else {\n                $(window).on('load', function() {\n                    $('.quizstartbuttondiv [type=submit]').prop(\"disabled\", false);\n                });\n            }\n            camera = new Camera(cmid, mainimage, attemptid, quizid);\n            $('.quizstartbuttondiv [type=submit]').on('click', function() {\n                localStorage.removeItem('videoPosition');\n                camera.startcamera();\n            });\n            // Take picture on button click\n            $('#' + camera.takepictureid).on('click', function(e) {\n                e.preventDefault();\n                camera.takepicture();\n            });\n            // Show video again when retake\n            $('#' + camera.retakeid).on('click', function(e) {\n                e.preventDefault();\n                camera.retake();\n            });\n            $('#id_cancel').on('click', function() {\n                camera.stopcamera();\n                camera.resetcamera();\n                $(\"#id_submitbutton\").prop(\"disabled\", true);\n                localStorage.removeItem('videoPosition');\n            });\n            $(document).on('click', '.closebutton', function() {\n                if (typeof camera !== 'undefined' && typeof camera.stopcamera === 'function') {\n                    camera.stopcamera();\n                    camera.resetcamera();\n                    $(\"#id_submitbutton\").prop(\"disabled\", true);\n                    localStorage.removeItem('videoPosition');\n                }\n            });\n            document.addEventListener('keydown', function(event) {\n                if (event.key === 'Escape') {\n                    camera.stopcamera();\n                    camera.resetcamera();\n                    $(\"#id_submitbutton\").prop(\"disabled\", true);\n                    localStorage.removeItem('videoPosition');\n                }\n            });\n            if (securewindow === 'securewindow') {\n                const currentUrl = window.location.href;\n                if (currentUrl.includes('startattempt.php')) {\n                    camera.startcamera();\n                }\n            }\n        } else {\n            localStorage.setItem('warningThreshold', JSON.stringify(warnings));\n            document.addEventListener('keydown', function(event) {\n                if ((event.ctrlKey || event.metaKey) && (event.key === 'c' || event.key === 'v')) {\n                    event.preventDefault();\n                }\n            });\n            document.addEventListener('dragstart', function(event) {\n                event.preventDefault();\n            });\n\n            document.addEventListener('drop', function(event) {\n                event.preventDefault();\n            });\n\n            document.addEventListener('contextmenu', function(event) {\n                event.preventDefault();\n            });\n            const waitForElements = setInterval(() => {\n                const vElement = document.getElementById('video');\n                const cElement = document.getElementById('canvas');\n\n                if (vElement && cElement) {\n                    clearInterval(waitForElements);\n                    if (typeof setupFaceMesh !== 'undefined') {\n                        // eslint-disable-next-line no-undef\n                        setupFaceMesh(function(result) {\n                            if (result.status) {\n                                realtimeDetection(cmid, attemptid, mainimage,\n                                    result.status, result.data);\n                            }\n                        });\n                    }\n                }\n            }, 500);\n            if (onlinestudent) {\n                // eslint-disable-next-line no-undef\n                signalingSocket = io(externalserver);\n                signalingSocket.on('connect', function() {\n                // Retrieve the session state from localStorage\n                var storedSession = localStorage.getItem('sessionState');\n                var sessionState = storedSession ? JSON.parse(storedSession) : null;\n                setupLocalMedia(cmid, mainimage, verifyduringattempt, attemptid,\n                teacher, enablestudentvideo, setinterval,\n                serviceoption, quizid, function() {\n                    // Once User gives access to mic/cam, join the channel and start peering up\n                    var teacherroom = getTeacherroom();\n                    var typet = {\"type\": (teacherroom === 'teacher') ? 'teacher' : 'student'};\n                    var fullname = userfullname;\n                    var domain = studenthexstring;\n\n                    signalingSocket.emit('join', {\"room\": quizid, \"userdata\": {'quizid': quizid,\n                        'type': typet, 'fullname': fullname, 'domain': domain}});\n\n                    // Restore the session state if available\n                    if (sessionState) {\n                        restoreSessionState(sessionState);\n                    }\n                });\n            });\n\n        signalingSocket.on('disconnect', function() {\n            /* Tear down all of our peer connections and remove all\n             * media divs when we disconnect */\n\n            for (peerId in peerMediaElements) {\n                peerMediaElements[peerId].remove();\n            }\n            for (peerId in peers) {\n                peers[peerId].close();\n            }\n\n            peers = {};\n            peerMediaElements = {};\n        });\n\n        signalingSocket.on('addPeer', function(config) {\n            if (!config.studentData || config.studentData.length === 0) {\n                // No studentData received or it is empty\n            } else {\n                cachedStudentData = config.studentData;\n            }\n            if (cachedStudentData) {\n                const existingStudent = cachedStudentData.find(student => student.id === config.peer_id);\n                if (!existingStudent) {\n                    cachedStudentData.push({id: config.peer_id, fullname: config.fullname});\n                }\n            } else {\n                cachedStudentData = [];\n            }\n            var peerId = config.peer_id;\n\n            if (peerId in peers) {\n                return;\n            }\n\n            var peerConnection = new RTCPeerConnection(\n                {\"iceServers\": ICE_SERVERS},\n                {\"optional\": [{\"DtlsSrtpKeyAgreement\": true}]}\n            );\n            peers[peerId] = peerConnection;\n            // Add peer to the connectedPeers object\n            connectedPeers[peerId] = {\n                stream: new MediaStream()\n            };\n\n            peerConnection.onicecandidate = function(event) {\n                if (event.candidate) {\n                    signalingSocket.emit('relayICECandidate', {\n                        'peer_id': peerId,\n                        'ice_candidate': {\n                            'sdpMLineIndex': event.candidate.sdpMLineIndex,\n                            'candidate': event.candidate.candidate\n                        }\n                    });\n                }\n            };\n\n            //     // Update connectedPeers stream\n            //     connectedPeers[peerId].stream.addTrack(event.track);\n            //     var remoteMedia;\n\n            //     if (peerMediaElements[peerId]) {\n            //         remoteMedia = peerMediaElements[peerId];\n            //     } else {\n            //         remoteMedia = USE_VIDEO ? $(\"<video>\") : $(\"<audio>\");\n            //         remoteMedia.attr(\"autoplay\", \"autoplay\");\n            //         remoteMedia.prop(\"controls\", true);\n            //         remoteMedia.addClass(\"quizaccess_quizproctoring\");\n            //         remoteMedia.prop(\"muted\", true);\n            //         if ($('#region-main-box .videos-container').length === 0) {\n            //             $('#region-main-box').append($(\"<div>\").addClass(\"videos-container\"));\n            //         }\n\n            //         var studentContainer = $(\"<div>\").addClass(\"student-container\");\n            //         const studentData = cachedStudentData.find(sd => sd.id === peerId);\n            //         const studentNameText = studentData ? studentData.fullname :\n            //         config.fullname || \"\";\n            //         const studentName = $(\"<span>\").addClass(\"student-name\").text(studentNameText);\n            //         studentContainer.append(remoteMedia);\n            //         studentContainer.append(studentName);\n\n            //         peerMediaElements[peerId] = remoteMedia;\n            //         var teacherroom = getTeacherroom();\n            //         if (teacherroom === 'teacher') {\n            //             total = total + 1;\n            //             $('.videos-container').append(studentContainer);\n            //             remoteMedia[0].srcObject = connectedPeers[peerId].stream;\n            //         }\n            //     }\n            // };\n            peerConnection.ontrack = function (event) {\n                // Update connectedPeers stream\n                connectedPeers[peerId].stream.addTrack(event.track);\n                var remoteMedia;\n                if (peerMediaElements[peerId]) {\n                  remoteMedia = peerMediaElements[peerId];\n                } else {\n                  remoteMedia = USE_VIDEO ? $(\"<video>\") : $(\"<audio>\");\n                  remoteMedia.attr(\"autoplay\", \"autoplay\");\n                  remoteMedia.prop(\"controls\", true);\n                  remoteMedia.addClass(\"quizaccess_quizproctoring\");\n                  remoteMedia.prop(\"muted\", true);\n                  if ($(\"#region-main-box .videos-container\").length === 0) {\n                    $(\"#region-main-box\").append($(\"<div>\").addClass(\"videos-container\"));\n                  }\n                  var studentContainer = $(\"<div>\").addClass(\"student-container\");\n                  const studentData = cachedStudentData.find((sd) => sd.id === peerId);\n                  const studentNameText = studentData ? studentData.fullname : config.fullname || \"\";\n                  if (studentNameText) {\n                    const studentName = $(\"<span>\").addClass(\"student-name\").text(studentNameText);\n                    studentContainer.append(remoteMedia);\n                    studentContainer.append(studentName);\n                    peerMediaElements[peerId] = remoteMedia;\n                    var teacherroom = getTeacherroom();\n                    if (teacherroom === \"teacher\") {\n                      total = total + 1;\n                      $(\".videos-container\").append(studentContainer);\n                      remoteMedia[0].srcObject = connectedPeers[peerId].stream;\n                      if (USE_VIDEO && event.track.kind === \"video\") {\n                        const videoElement = remoteMedia[0];\n                        videoElement.onloadedmetadata = () => {\n                          if (videoElement.videoWidth === 0 || videoElement.videoHeight === 0) {\n                            studentContainer.css(\"display\", \"none\");\n                          }\n                        };\n                        setTimeout(() => {\n                          if (videoElement.videoWidth === 0 || videoElement.videoHeight === 0) {\n                            studentContainer.css(\"display\", \"none\");\n                          }\n                        }, 2000);\n                      }\n                    }\n                  }\n                }\n              };\n            // Add our local stream\n            console.log(\"local stream \",localMediaStream);\n            console.log(\"no student online\",noStudentOnlineDiv)\n            if (localMediaStream) {\n                if (noStudentOnlineDiv) {\n                    noStudentOnlineDiv.style.display = 'none';\n                }\n                peerConnection.addStream(localMediaStream);\n            }\n            if (config.should_create_offer) {\n                peerConnection.createOffer(\n                    function(localDescription) {\n                        peerConnection.setLocalDescription(localDescription,\n                            function() {\n                                signalingSocket.emit('relaySessionDescription',\n                                    {'peer_id': peerId, 'session_description': localDescription});\n                            }\n                        );\n                    },\n                    function() {\n                        // Error handling will be implemented later\n                    }\n                );\n            }\n        });\n\n                /**\n                 * Peers exchange session descriptions which contains information\n                 * about their audio / video settings and that sort of stuff. First\n                 * the 'offerer' sends a description to the 'answerer' (with type\n                 * \"offer\"), then the answerer sends one back (with type \"answer\").\n                 */\n                signalingSocket.on('sessionDescription', function(config) {\n                    var peerId = config.peer_id;\n                    var peer = peers[peerId];\n                    var remoteDescription = config.session_description;\n                    var desc = new RTCSessionDescription(remoteDescription);\n                    peer.setRemoteDescription(desc)\n                    .then(function() {\n                        if (remoteDescription.type === \"offer\") {\n                            return peer.createAnswer();\n                        }\n                        return null;\n                    })\n                    .then(function(localDescription) {\n                        if (localDescription) {\n                            return peer.setLocalDescription(localDescription);\n                        }\n                        return null;\n                    })\n                    .then(function() {\n                        if (peer.localDescription) {\n                            signalingSocket.emit('relaySessionDescription', {\n                                'peer_id': peerId,\n                                'session_description': peer.localDescription\n                            });\n                        }\n                        return null;\n                    })\n                    .catch(function(error) {\n                        throw error;\n                    });\n                });\n\n                /**\n                 * The offerer will send a number of ICE Candidate blobs to the answerer so they\n                 * can begin trying to find the best path to one another on the net.\n                 */\n                signalingSocket.on('iceCandidate', function(config) {\n                    var peer = peers[config.peer_id];\n                    var iceCandidate = config.ice_candidate;\n                    peer.addIceCandidate(new RTCIceCandidate(iceCandidate));\n                });\n                /**\n                 * When a user leaves a channel (or is disconnected from the\n                 * signaling server) everyone will recieve a 'removePeer' message\n                 * telling them to trash the media channels they have open for those\n                 * that peer. If it was this client that left a channel, they'll also\n                 * receive the removePeers. If this client was disconnected, they\n                 * wont receive removePeers, but rather the\n                 * signalingSocket.on('disconnect') code will kick in and tear down\n                 * all the peer sessions.\n                 */\n                    signalingSocket.on('removePeer', function(config) {\n                    var peerId = config.peer_id;\n\n                    if (!(peerId in peers)) {\n                        return;\n                    }\n\n                    // Close the peer connection\n                    peers[peerId].removeStream(connectedPeers[peerId].stream);\n                    peers[peerId].close();\n\n                    // Remove the peer from connectedPeers\n                    delete connectedPeers[peerId];\n\n                    var remoteMedia = peerMediaElements[peerId];\n                    if (remoteMedia) {\n                        total = total - 1;\n                        if (total === 0) {\n                            noStudentOnlineDiv.style.display = 'block';\n                        }\n                        remoteMedia.closest('.student-container').remove();\n                    }\n                    // Remove references\n                    delete peers[peerId];\n                    delete peerMediaElements[peerId];\n                });\n        } else {\n            setupLocalMedia(cmid, mainimage, verifyduringattempt, attemptid,\n            teacher, enablestudentvideo, setinterval,\n            serviceoption, quizid);\n        }\n    }\n\n    };\n    return {\n        init: init\n    };\n\n    /**\n     * Setup Local Media\n     *\n     * @param {int} cmid - cmid\n     * @param {boolean} mainimage - boolean value\n     * @param {boolean} verifyduringattempt - boolean value\n     * @param {int} attemptid - Attempt Id\n     * @param {boolean} teacher - boolean value\n     * @param {boolean} enablestudentvideo - boolean value\n     * @param {bigint} setinterval - int value\n     * @param {Longtext} serviceoption - string value\n     * @param {int} quizid - int value\n     * @param {function} callback - The callback function to execute after setting up the media stream.\n     * @return {void}\n     */\n    function setupLocalMedia(cmid, mainimage, verifyduringattempt, attemptid,\n        teacher, enablestudentvideo,\n        setinterval, serviceoption, quizid, callback) {\n        require(['core/ajax'], function() {\n            if (localMediaStream !== null) {\n                if (callback) {\n                    callback();\n                }\n                return;\n            }\n            var teacherroom = getTeacherroom();\n            if (teacherroom !== 'teacher') {\n                navigator.getUserMedia = (\n                    navigator.getUserMedia ||\n                    navigator.webkitGetUserMedia ||\n                    navigator.mozGetUserMedia ||\n                    navigator.msGetUserMedia\n                );\n\n                attachMediaStream = function(element, stream) {\n                    element.srcObject = stream;\n                };\n\n                navigator.mediaDevices.getUserMedia({\"audio\": USE_AUDIO, \"video\": USE_VIDEO})\n                .then(function(stream) {\n                    localMediaStream = stream;\n                    if (verifyduringattempt) {\n                        $('<canvas>').attr({id: 'canvas', width: '280',\n                            height: '240', 'style': 'display: none;'}).appendTo('body');\n                        $('<video>').attr({\n                            'id': 'video',\n                            'class': 'quizaccess_quizproctoring-video',\n                            'width': '280',\n                            'height': '240',\n                            'autoplay': 'autoplay'\n                        }).css('display', enablestudentvideo ? 'block' : 'none')\n                          .appendTo('body');\n                        document.addEventListener('visibilitychange', function() {\n                            if (document.visibilityState === 'visible') {\n                                var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                                var leftwarnings = Math.max(warningsl - 1, 0);\n                                localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                                var message = \"Do not move away from active tab.\";\n                                if (leftwarnings === 1) {\n                                    message = `Do not move away from active tab. You have only ${leftwarnings} warning left.`;\n                                } else if (leftwarnings > 1) {\n                                    message = `Do not move away from active tab. You have only ${leftwarnings} warnings left.`;\n                                }\n                                $(document).trigger('popup', message);\n                                $.ajax({\n                                url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n                                method: 'POST',\n                                data: {cmid: cmid, attemptid: attemptid, mainimage: mainimage, tab: true},\n                                    success: function(response) {\n                                        if (response.redirect && response.url) {\n                                            window.onbeforeunload = null;\n                                            $(document).trigger('popup', response.msg);\n                                            setTimeout(function() {\n                                                window.location.href = encodeURI(response.url);\n                                            }, 3000);\n                                        }\n                                    }\n                                });\n                            }\n                        });\n                        var camera = new Camera(cmid, mainimage, attemptid, quizid);\n                        camera.startcamera();\n                        setInterval(camera.proctoringimage.bind(camera), setinterval * 1000);\n                    }\n                    return stream;\n                })\n                .catch(function(error) {\n                    // Handle the case where permission is denied\n                    if (verifyduringattempt) {\n                        var teacherroom = getTeacherroom();\n                        if (teacherroom !== 'teacher') {\n                            var camera = new Camera(cmid, mainimage, attemptid, quizid);\n                            camera.startcamera();\n                            setInterval(camera.proctoringimage.bind(camera), setinterval * 1000);\n                        }\n                    }\n                    throw error;\n                })\n                .finally(function() {\n                    if (callback) {\n                        callback();\n                    }\n                });\n            } else {\n                localMediaStream = createDummyMediaStream();\n                if (callback) {\n                    callback();\n                }\n            }\n        });\n    }\n\n    /**\n     * Create Dummy Media Stream\n     *\n     * @return {string} dummyStream\n     */\n     function createDummyMediaStream() {\n        const audioContext = new AudioContext();\n        const dummyAudio = audioContext.createMediaStreamDestination();\n        const dummyVideo = document.createElement('canvas').captureStream(0);\n\n        // Combine audio and video into a dummy MediaStream\n        const dummyStream = new MediaStream();\n        dummyStream.addTrack(dummyAudio.stream.getAudioTracks()[0]);\n        dummyStream.addTrack(dummyVideo.getVideoTracks()[0]);\n        return dummyStream;\n    }\n\n    /**\n     * Get Teacher room\n     *\n     * @return {string} teacher\n     */\n    function getTeacherroom() {\n        var urlParams = new URLSearchParams(window.location.search);\n        var teacher = urlParams.get('teacher');\n        return teacher;\n    }\n\n/**\n * RestoreSessionState\n *\n * @param {Longtext} sessionState sessionState\n */\nfunction restoreSessionState(sessionState) {\n    for (var peerId in sessionState.connectedPeers) {\n        if (sessionState.connectedPeers.hasOwnProperty(peerId)) {\n            var peer = sessionState.connectedPeers[peerId];\n\n            // Create RTCPeerConnection and add track\n            var peerConnection = new RTCPeerConnection(\n                {\"iceServers\": ICE_SERVERS},\n                {\"optional\": [{\"DtlsSrtpKeyAgreement\": true}]}\n            );\n\n            peers[peerId] = peerConnection;\n\n            setupPeerConnection(peerConnection, peerId, peer);\n        }\n    }\n}\n\n/**\n * SetupPeerConnection\n *\n * @param {Longtext} peerConnection peerConnection\n * @param {Longtext} peerId peerId\n * @param {Longtext} peer peer\n */\nfunction setupPeerConnection(peerConnection, peerId, peer) {\n    peerConnection.onicecandidate = function(event) {\n        if (event.candidate) {\n            signalingSocket.emit('relayICECandidate', {\n                'peer_id': peerId,\n                'ice_candidate': {\n                    'sdpMLineIndex': event.candidate.sdpMLineIndex,\n                    'candidate': event.candidate.candidate\n                }\n            });\n        }\n    };\n\n    peerConnection.ontrack = function(event) {\n        // Update connectedPeers stream\n        peer.stream.addTrack(event.track);\n\n        var remoteMedia;\n\n        if (peerMediaElements[peerId]) {\n            remoteMedia = peerMediaElements[peerId];\n        } else {\n            remoteMedia = USE_VIDEO ? $(\"<video>\") : $(\"<audio>\");\n            remoteMedia.attr(\"autoplay\", \"autoplay\");\n\n            if (MUTE_AUDIO_BY_DEFAULT) {\n                remoteMedia.attr(\"muted\", \"true\");\n            }\n            remoteMedia.attr(\"controls\", \"\");\n            peerMediaElements[peerId] = remoteMedia;\n            var teacherroom = getTeacherroom();\n            if (teacherroom === 'teacher') {\n                $('#region-main-box').append(remoteMedia);\n                attachMediaStream(remoteMedia[0], stream);\n            }\n        }\n        attachMediaStream(remoteMedia[0], peer.stream);\n    };\n\n    // Add our local stream\n    peerConnection.addStream(localMediaStream);\n\n    // Add existing tracks to the new connection\n    for (var track of peer.stream.getTracks()) {\n        peerConnection.addTrack(track, peer.stream);\n    }\n\n    // Create an offer\n    peerConnection.createOffer(\n        function(localDescription) {\n            peerConnection.setLocalDescription(localDescription,\n                function() {\n                    signalingSocket.emit('relaySessionDescription', {\n                        'peer_id': peerId,\n                        'session_description': localDescription\n                    });\n                }\n            );\n        });\n}\n\n/**\n * Restore Video Position\n *\n * @param {HTMLElement} element - The video element whose position should be restored.\n * @return {void}\n */\nfunction restoreVideoPosition(element) {\n    const savedPosition = localStorage.getItem('videoPosition');\n    if (savedPosition) {\n        const {left, top} = JSON.parse(savedPosition);\n        element.style.left = `${left}px`;\n        element.style.top = `${top}px`;\n    }\n}\n\n/**\n * Draggable Video Position\n *\n * @param {HTMLElement} element - The video element\n * @return {void}\n */\nfunction makeDraggable(element) {\n    let offsetX = 0;\n    let offsetY = 0;\n    let isDragging = false;\n    element.addEventListener('mousedown', function(e) {\n        isDragging = true;\n        offsetX = e.clientX - element.getBoundingClientRect().left;\n        offsetY = e.clientY - element.getBoundingClientRect().top;\n        element.style.cursor = 'grabbing';\n    });\n    document.addEventListener('mousemove', function(e) {\n    if (!isDragging) {\n        return;\n    }\n         requestAnimationFrame(() => {\n            let newLeft = e.clientX - offsetX;\n            let newTop = e.clientY - offsetY;\n            const maxLeft = window.innerWidth - element.offsetWidth;\n            const maxTop = window.innerHeight - element.offsetHeight;\n            newLeft = Math.max(0, Math.min(newLeft, maxLeft));\n            newTop = Math.max(0, Math.min(newTop, maxTop));\n            if (element.style.position !== 'fixed') {\n                element.style.position = 'fixed';\n            }\n             element.style.left = `${newLeft}px`;\n            element.style.top = `${newTop}px`;\n        });\n    });\n    document.addEventListener('mouseup', function() {\n        if (isDragging) {\n            isDragging = false;\n            element.style.cursor = 'grab';\n            localStorage.setItem('videoPosition', JSON.stringify({\n                left: parseInt(element.style.left, 10),\n                top: parseInt(element.style.top, 10)\n            }));\n        }\n    });\n}\n\n/**\n * Realtime Detection Ajax call\n *\n * @param {int} cmid - cmid\n * @param {int} attemptid - Attempt Id\n * @param {boolean} mainimage - boolean value\n * @param {string} face string value\n * @param {Longtext} data video\n * @return {void}\n */\nfunction realtimeDetection(cmid, attemptid, mainimage, face, data) {\n    var requestData = {\n        cmid: cmid,\n        attemptid: attemptid,\n        mainimage: mainimage,\n        validate: face,\n        imgBase64: data,\n    };\n    $.ajax({\n        url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax_realtime.php',\n        method: 'POST',\n        data: requestData,\n        success: function(response) {\n            if (response && response.errorcode) {\n                var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                var leftwarnings = Math.max(warningsl - 1, 0);\n                localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                $(document).trigger('popup', response.error);\n            } else {\n                if (response.redirect && response.url) {\n                    window.onbeforeunload = null;\n                    $(document).trigger('popup', response.msg);\n                    setTimeout(function() {\n                        window.location.href = encodeURI(response.url);\n                    }, 3000);\n                }\n            }\n        }\n    });\n}\n/**\n * Setup show Custom Modal\n *\n * @param {Longtext} message - string value\n * @return {void}\n */\nfunction showCustomModal(message) {\n    $('.custom-modal').remove();\n    const modalHtml = `\n        <div class=\"custom-modal show\" role=\"dialog\" aria-modal=\"true\" tabindex=\"-1\">\n            <div class=\"custom-modal-dialog modal-dialog-scrollable\">\n                <div class=\"custom-modal-content\">\n                    <div class=\"custom-modal-header\">\n                        <h5 class=\"custom-modal-title\"></h5>\n                        <button type=\"button\" class=\"custom-close-btn\" aria-label=\"Close\">&times;</button>\n                    </div>\n                    <div class=\"custom-modal-body\">\n                        ${message}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n    $('body').append(modalHtml);\n    $('.custom-modal').fadeIn();\n    $('.custom-close-btn').click(function() {\n        closeCustomModal();\n    });\n    $(document).on('click', function(e) {\n        const $modalContent = $('.custom-modal-content');\n        if (!$modalContent.is(e.target) && $modalContent.has(e.target).length === 0) {\n            closeCustomModal();\n        }\n    });\n    $(document).on('keydown', function(e) {\n        if (e.key === 'Escape') {\n            closeCustomModal();\n        }\n    });\n}\n\n/**\n * Setup close Custom Modal\n *\n * @return {void}\n */\nfunction closeCustomModal() {\n    $('.custom-modal').fadeOut(function() {\n        $(this).remove();\n    });\n    $(document).off('click');\n    $(document).off('keydown');\n}\n});\n"],"names":["window","addEventListener","event","stopImmediatePropagation","returnValue","define","$","str","ModalFactory","prop","Camera","cmid","mainimage","attemptid","quizid","docElement","document","video","getElementById","this","videoid","canvas","canvasid","on","showpopup","bind","is","val","prototype","width","height","takepictureid","retakeid","startcamera","takePictureButton","navigator","mediaDevices","getUserMedia","audio","then","stream","videoElement","srcObject","muted","playsinline","localMediaStream","play","e","preventDefault","getVideoTracks","onended","trigger","audioTrack","getAudioTracks","element","savedPosition","localStorage","getItem","left","top","JSON","parse","style","restoreVideoPosition","offsetX","offsetY","isDragging","clientX","getBoundingClientRect","clientY","cursor","requestAnimationFrame","newLeft","newTop","maxLeft","innerWidth","offsetWidth","maxTop","innerHeight","offsetHeight","Math","max","min","position","setItem","stringify","parseInt","makeDraggable","catch","takepicture","getContext","drawImage","data","toDataURL","hide","show","ajax","url","M","cfg","wwwroot","method","imgBase64","success","response","errorcode","error","proctoringimage","requestData","warningsl","leftwarnings","redirect","onbeforeunload","msg","setTimeout","location","href","encodeURI","resetcamera","clearRect","signalingSocket","externalserver","peers","peerId","peerMediaElements","connectedPeers","attachMediaStream","total","cachedStudentData","ICE_SERVERS","urls","retake","message","activeModal","destroy","create","body","modal","remove","modalHtml","append","fadeIn","click","closeCustomModal","$modalContent","target","has","length","key","showCustomModal","stopcamera","getTracks","forEach","track","stop","init","verifyduringattempt","teacher","serviceoption","studenthexstring","onlinestudent","securewindow","userfullname","enablestudentvideo","setinterval","warnings","noStudentOnlineDiv","ctrlKey","metaKey","waitForElements","setInterval","vElement","cElement","clearInterval","setupFaceMesh","result","status","realtimeDetection","io","storedSession","sessionState","setupLocalMedia","typet","getTeacherroom","fullname","domain","emit","restoreSessionState","close","config","studentData","find","student","id","peer_id","push","peerConnection","RTCPeerConnection","MediaStream","onicecandidate","candidate","sdpMLineIndex","ontrack","remoteMedia","addTrack","attr","addClass","studentContainer","sd","studentNameText","studentName","text","kind","onloadedmetadata","videoWidth","videoHeight","css","console","log","display","addStream","should_create_offer","createOffer","localDescription","setLocalDescription","peer","remoteDescription","session_description","desc","RTCSessionDescription","setRemoteDescription","type","createAnswer","iceCandidate","ice_candidate","addIceCandidate","RTCIceCandidate","removeStream","closest","camera","readyState","removeItem","includes","callback","require","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","appendTo","visibilityState","tab","finally","dummyAudio","AudioContext","createMediaStreamDestination","dummyVideo","createElement","captureStream","dummyStream","createDummyMediaStream","URLSearchParams","search","get","hasOwnProperty","setupPeerConnection","face","validate","fadeOut","off"],"mappings":"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"}