{"version":3,"file":"response_proctoring.min.js","sources":["../src/response_proctoring.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Javascript controller for the \"Grading\" panel at the right of the page\r\n *\r\n * @subpackage quizproctoring\r\n * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport $ from 'jquery';\r\nimport Modal from 'core/modal';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport ModalEvents from 'core/modal_events';\r\nimport ModalProctoring from './modal_proctoring';\r\n\r\n    var ResponsePanel = function(responses) {\r\n        this.responses = responses;\r\n        this.registerEventListeners();\r\n    };\r\n\r\n    ResponsePanel.prototype.qid = null;\r\n    ResponsePanel.prototype.rid = null;\r\n    ResponsePanel.prototype.sec = null;\r\n    ResponsePanel.prototype.courseid = null;\r\n    ResponsePanel.prototype.responses = Array();\r\n    ResponsePanel.prototype.index = 0;\r\n    ResponsePanel.prototype.quizid = 0;\r\n    ResponsePanel.prototype.attemptid = 0;\r\n    ResponsePanel.prototype.userid = 0;\r\n    ResponsePanel.prototype.currentpage = 1;\r\n    ResponsePanel.prototype.firstPage = 1;\r\n    ResponsePanel.prototype.lastPage = 0;\r\n    ResponsePanel.prototype.tempindex = 0;\r\n    ResponsePanel.prototype.prevpage = 0;\r\n    ResponsePanel.prototype.temarrayprev = Array();\r\n    ResponsePanel.prototype.temarraynext = Array();\r\n    /**\r\n     * Register event listeners for the grade panel.\r\n     *\r\n     * @method registerEventListeners\r\n     */\r\n    ResponsePanel.prototype.registerEventListeners = function() {\r\n        var docElement = $(document);\r\n        docElement.on('next', this._getNextUser.bind(this));\r\n        docElement.on('prev', this._getPreviousUser.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Reset buttons method\r\n     */\r\n    ResponsePanel.prototype._reset = function() {\r\n        if (this.responses.length) {\r\n            var isFirst = this.index === 0;\r\n            var isLast = this.responses.length === this.index + 1;\r\n            if (isFirst) {\r\n                if (this.firstPage == this.currentpage) {\r\n                    $('[data-action=\"previous\"]').prop(\"disabled\", \"disabled\");\r\n                } else {\r\n                    $('[data-action=\"previous\"]').prop(\"disabled\", false);\r\n                }\r\n                $('[data-action=\"next\"]').prop(\"disabled\", false);\r\n            } else if (isLast) {\r\n                if (this.currentpage == this.lastpage) {\r\n                    $('[data-action=\"next\"]').prop(\"disabled\", \"disabled\");\r\n                } else {\r\n                    $('[data-action=\"next\"]').prop(\"disabled\", false);\r\n                }\r\n                $('[data-action=\"previous\"]').prop(\"disabled\", false);\r\n            } else {\r\n                $('[data-action=\"previous\"]').prop(\"disabled\", false);\r\n                $('[data-action=\"next\"]').prop(\"disabled\", false);\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * First page settings\r\n     *\r\n     */\r\n     ResponsePanel.prototype._isFirstPage = function() {\r\n        var insidethid = this;\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax_report.php',\r\n            data: {\r\n                attemptid: this.attemptid,\r\n                userid: this.userid,\r\n                quizid: this.quizid,\r\n                currentpage: (this.currentpage - 2)\r\n            },\r\n            dataType: 'json',\r\n            success: function(response) {\r\n                var images = JSON.parse(JSON.stringify(response));\r\n                insidethid.temarrayprev = images;\r\n                insidethid.prevpage = 1;\r\n            }\r\n        });\r\n     };\r\n\r\n     /**\r\n      * Last page settings\r\n      *\r\n      */\r\n    ResponsePanel.prototype._isLastPage = function() {\r\n        var insidethid = this;\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax_report.php',\r\n            data: {\r\n                attemptid: this.attemptid,\r\n                userid: this.userid,\r\n                quizid: this.quizid,\r\n                currentpage: this.currentpage\r\n            },\r\n            dataType: 'json',\r\n            success: function(response) {\r\n                var images = JSON.parse(JSON.stringify(response));\r\n                insidethid.temarraynext = images;\r\n                if (images[0]) {\r\n                    insidethid.tempindex = 1;\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Get next user to process\r\n     *\r\n     * @method _getNextUser\r\n     */\r\n    ResponsePanel.prototype._getNextUser = function() {\r\n        if (this.tempindex) {\r\n            this.index = -1;\r\n            this.responses = this.temarraynext;\r\n            this.currentpage += 1;\r\n        }\r\n        this.tempindex = 0;\r\n        this.prevpage = 0;\r\n        this.index += 1;\r\n        this._reset();\r\n        var res = this.responses[this.index];\r\n        if (res) {\r\n            $(\".imgheading\").html(res.title);\r\n            $(\".userimg\").attr(\"src\", res.img);\r\n        }\r\n        var isFirst = this.index === 0;\r\n        if (isFirst) {\r\n            this._isFirstPage();\r\n        }\r\n        var isLast = this.responses.length === this.index + 1;\r\n        if (isLast) {\r\n            this._isLastPage();\r\n        }\r\n\r\n    };\r\n\r\n    /**\r\n     * Get previous user to process\r\n     *\r\n     * @method _getNextUser\r\n     */\r\n    ResponsePanel.prototype._getPreviousUser = function() {\r\n        if (this.tempindex) {\r\n            this.index = 18;\r\n        } else {\r\n            this.index -= 1;\r\n        }\r\n\r\n        if (this.prevpage) {\r\n            this.index = 19;\r\n            this.responses = this.temarrayprev;\r\n            this.currentpage -= 1;\r\n        }\r\n        this.prevpage = 0;\r\n        this.tempindex = 0;\r\n        this._reset();\r\n        var res = this.responses[this.index];\r\n        if (res) {\r\n            $(\".imgheading\").html(res.title);\r\n            $(\".userimg\").attr(\"src\", res.img);\r\n        }\r\n        var isFirst = this.index === 0;\r\n        if (isFirst) {\r\n            this._isFirstPage();\r\n        }\r\n\r\n        var isLast = this.responses.length === this.index + 1;\r\n        if (isLast) {\r\n            this._isLastPage();\r\n        }\r\n\r\n    };\r\n\r\nexport default class ModalAddProctoringImage extends Modal {\r\n    static TYPE = 'quizaccess_quizproctoring-response';\r\n    static TEMPLATE = 'quizaccess_quizproctoring/response_modal';\r\n\r\n    /**\r\n     * Create the add random question modal.\r\n     *\r\n     * @param  {Number} contextId Current context id.\r\n     * @param  {string} category Category id and category context id comma separated.\r\n     * @param  {string} returnUrl URL to return to after form submission.\r\n     * @param  {Number} cmid Current course module id.\r\n     * @param  {boolean} showNewCategory Display the New category tab when selecting random questions.\r\n     */\r\n    static init(attemptid = null, quizid = null, userid = null, useridentity = null, $proctoringimageshow) {\r\n        var docElement = $(document);\r\n        docElement.ready(function() {\r\n            if ($proctoringimageshow == 1) {\r\n                let btn = document.createElement(\"button\");\r\n                btn.innerHTML = M.util.get_string('proctoringimages', 'quizaccess_quizproctoring');\r\n                btn.setAttribute(\"type\", \"button\");\r\n                btn.setAttribute(\"value\", \"proctoringimage\");\r\n                btn.setAttribute(\"class\", \"proctoringimage btn btn-primary\");\r\n                btn.setAttribute(\"data-attemptid\", attemptid);\r\n                btn.setAttribute(\"data-quizid\", quizid);\r\n                btn.setAttribute(\"data-userid\", userid);\r\n                document.getElementById(\"page-content\").prepend(btn);\r\n            }\r\n            if (useridentity && useridentity != 0) {\r\n                let btnidentity = document.createElement(\"button\");\r\n                btnidentity.innerHTML = M.util.get_string('proctoringidentity', 'quizaccess_quizproctoring');\r\n                btnidentity.setAttribute(\"type\", \"button\");\r\n                btnidentity.setAttribute(\"value\", \"proctoridentity\");\r\n                btnidentity.setAttribute(\"class\", \"proctoridentity btn btn-primary\");\r\n                btnidentity.setAttribute(\"data-attemptid\", attemptid);\r\n                btnidentity.setAttribute(\"data-quizid\", quizid);\r\n                btnidentity.setAttribute(\"data-userid\", userid);\r\n                document.getElementById(\"page-content\").prepend(btnidentity);\r\n            }\r\n        });\r\n\r\n        docElement.on('click', 'button.proctoringimage', function(e) {\r\n            e.preventDefault();\r\n            var quizid = $(this).data('quizid');\r\n            var userid = $(this).data('userid');\r\n            var attemptid = $(this).data('attemptid');\r\n            $.ajax({\r\n                url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax_report.php',\r\n                data: {\r\n                    attemptid: $(this).data('attemptid'),\r\n                    userid: $(this).data('userid'),\r\n                    quizid: $(this).data('quizid')\r\n                },\r\n                dataType: 'json',\r\n                success: function(response) {\r\n                    console.log(response);\r\n                    var images = JSON.parse(JSON.stringify(response));\r\n                    if (images.length > 0) {\r\n                        var rp = new ResponsePanel(images);\r\n                        rp.quizid = quizid;\r\n                        rp.userid = userid;\r\n                        rp.attemptid = attemptid;\r\n                        rp.lastpage = rp.responses[rp.index].totalpage;console.log(rp.responses[rp.index]);\r\n                        return ModalAddProctoringImage.create({\r\n                            type: ModalProctoring.TYPE,\r\n                        }).then(function(modal) {\r\n                            modal.getRoot().on(ModalEvents.hidden, modal.destroy.bind(modal));\r\n                            modal.setTitle('User Images');\r\n                            modal.show();\r\n                            $(\".imgheading\").html(rp.responses[rp.index].title);\r\n                            $(\".userimg\").attr(\"src\", rp.responses[rp.index].img);\r\n                            if (rp.responses[rp.index].total == 1) {\r\n                                $('[data-action=\"next\"]').prop(\"disabled\", \"disabled\");\r\n                            }\r\n                            return null;\r\n                        });\r\n                    } else {\r\n                        var message = M.util.get_string('noimageswarning', 'quizaccess_quizproctoring');\r\n                        return ModalFactory.create({\r\n                            type: ModalFactory.types.DEFAULT,\r\n                            body: message,\r\n                        }).then(function(modal) {\r\n                            modal.getRoot().on(ModalEvents.hidden, modal.destroy.bind(modal));\r\n                            modal.show();\r\n                            return null;\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\n\r\nModalAddProctoringImage.registerModalType();\r\n"],"names":["ResponsePanel","responses","registerEventListeners","prototype","qid","rid","sec","courseid","Array","index","quizid","attemptid","userid","currentpage","firstPage","lastPage","tempindex","prevpage","temarrayprev","temarraynext","docElement","document","on","this","_getNextUser","bind","_getPreviousUser","_reset","length","isFirst","isLast","prop","lastpage","_isFirstPage","insidethid","ajax","url","M","cfg","wwwroot","data","dataType","success","response","images","JSON","parse","stringify","_isLastPage","res","html","title","attr","img","ModalAddProctoringImage","Modal","useridentity","$proctoringimageshow","ready","btn","createElement","innerHTML","util","get_string","setAttribute","getElementById","prepend","btnidentity","e","preventDefault","console","log","rp","totalpage","create","type","ModalProctoring","TYPE","then","modal","getRoot","ModalEvents","hidden","destroy","setTitle","show","total","message","ModalFactory","types","DEFAULT","body","registerModalType"],"mappings":"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"}