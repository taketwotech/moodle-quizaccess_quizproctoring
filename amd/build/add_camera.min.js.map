{"version":3,"file":"add_camera.min.js","sources":["../src/add_camera.js"],"sourcesContent":["/**\r\n * JavaScript class for Camera\r\n *\r\n * @subpackage quizproctoring\r\n * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'core/str', 'core/modal_factory'],\r\nfunction($, str, ModalFactory) {\r\n    var Camera = function(cmid, mainimage = false, attemptid = null) {\r\n        var docElement = $(document);\r\n        this.video = document.getElementById(this.videoid);\r\n        this.canvas = document.getElementById(this.canvasid);\r\n        this.cmid = cmid;\r\n        this.mainimage = mainimage;\r\n        this.attemptid = attemptid;\r\n        docElement.on('popup', this.showpopup.bind(this));\r\n        setTimeout(navigator.mediaDevices.getUserMedia({video: true, audio: false})\r\n            .then(function(stream) {\r\n                if (this.video) {\r\n                  this.video.srcObject = stream;\r\n                  this.video.play();\r\n                  return true;\r\n                }\r\n            })\r\n        .catch(function() {\r\n            // Console.log(err);\r\n        }), 10000);\r\n    };\r\n    /** @type Tag element contain video. */\r\n    Camera.prototype.video = false;\r\n    /** @type String video elemend id. */\r\n    Camera.prototype.videoid = 'video';\r\n    /** @type Tag element contain canvas. */\r\n    Camera.prototype.canvas = false;\r\n    /** @type String video elemend id. */\r\n    Camera.prototype.canvasid = 'canvas';\r\n    /** @type int width of canvas object. */\r\n    Camera.prototype.width = 320;\r\n    /** @type int width of canvas object. */\r\n    Camera.prototype.height = 240;\r\n    /** @type String element contain takepicture button. */\r\n    Camera.prototype.takepictureid = 'takepicture';\r\n    /** @type String element contain retake button. */\r\n    Camera.prototype.retakeid = 'retake';\r\n    /** @type int course module id. */\r\n    Camera.prototype.cmid = false;\r\n    /** @type bool whether a main image or compare against an image. */\r\n    Camera.prototype.mainimage = false;\r\n     /** @type int attempt id. */\r\n    Camera.prototype.attemptid = false;\r\n\r\n    Camera.prototype.takepicture = function() {\r\n        // Console.log('takepicture function');\r\n        var context = this.canvas.getContext('2d');\r\n        context.drawImage(this.video, 0, 0, this.width, this.height);\r\n        var data = this.canvas.toDataURL('image/png');\r\n        $('#' + this.videoid).hide();\r\n        $('#' + this.takepictureid).hide();\r\n        $('#' + this.canvasid).show();\r\n        $('#' + this.retakeid).show();\r\n        $(\"input[name='userimg']\").val(data);\r\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\r\n            method: 'POST',\r\n            data: {imgBase64: data, cmid: this.cmid, attemptid: this.attemptid, mainimage: this.mainimage},\r\n            success: function(response) {\r\n                if (response && response.errorcode) {\r\n                    // Console.log(response.errorcode);\r\n                    $(\"input[name='userimg']\").val('');\r\n                    $(document).trigger('popup', response.error);\r\n                } else {\r\n                    $(\"#id_submitbutton\").prop(\"disabled\", false);\r\n                }\r\n            }\r\n        });\r\n    };\r\n    Camera.prototype.proctoringimage = function() {\r\n        // Console.log(this.cmid);\r\n        var context = this.canvas.getContext('2d');\r\n        context.drawImage(this.video, 0, 0, this.width, this.height);\r\n        var data = this.canvas.toDataURL('image/png');\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\r\n            method: 'POST',\r\n            data: {imgBase64: data, cmid: this.cmid, attemptid: this.attemptid, mainimage: this.mainimage},\r\n            success: function(response) {\r\n                if (response && response.errorcode) {\r\n                   // Console.log(response.errorcode);\r\n                    $(document).trigger('popup', response.error);\r\n                } else {\r\n                    if (response.redirect && response.url) {\r\n                        window.onbeforeunload = null;\r\n                        window.location.href = encodeURI(response.url);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    Camera.prototype.retake = function() {\r\n        $(\"input[name='userimg']\").val('');\r\n        $('#' + this.videoid).show(this.cmid);\r\n        $('#' + this.takepictureid).show();\r\n        $('#' + this.canvasid).hide();\r\n        $('#' + this.retakeid).hide();\r\n    };\r\n    Camera.prototype.showpopup = function(event, message) {\r\n        return ModalFactory.create({\r\n            body: message,\r\n        }).then(function(modal) {\r\n            modal.show();\r\n        });\r\n    };\r\n    var init = function(cmid, mainimage, verifyduringattempt = false, attemptid = null, setinterval = 300) {\r\n        var camera;\r\n        if (verifyduringattempt) {\r\n            $('<canvas>').attr({id: 'canvas', width: '280', height: '240', 'style': 'display: none;'}).appendTo('body');\r\n            $('<video>').attr({\r\n                'id': 'video',\r\n                'class': 'quizaccess_quizproctoring-video',\r\n                'width': '280',\r\n                'height': '240',\r\n                'autoplay': 'autoplay'}).appendTo('body');\r\n            camera = new Camera(cmid, mainimage, attemptid);\r\n            setInterval(camera.proctoringimage.bind(camera), setinterval * 1000);\r\n        } else {\r\n            camera = new Camera(cmid, mainimage, attemptid);\r\n            // Take picture on button click\r\n            $('#' + camera.takepictureid).on('click', function(e) {\r\n                e.preventDefault();\r\n                camera.takepicture();\r\n            });\r\n            // Show video again when retake\r\n            $('#' + camera.retakeid).on('click', function(e) {\r\n                e.preventDefault();\r\n                camera.retake();\r\n            });\r\n            $(\"#id_submitbutton\").on('click', function(e) {\r\n                if ($(\"input[name='userimg']\").val() == \"\") {\r\n                    e.preventDefault();\r\n                    return ModalFactory.create({\r\n                        body: str.get_string('clickpicture', 'quizaccess_quizproctoring'),\r\n                    }).then(function(modal) {\r\n                        modal.show();\r\n                    });\r\n                    return true;\r\n                }\r\n            });\r\n        }\r\n    };\r\n    return {\r\n        init: init\r\n    };\r\n});\r\n"],"names":["define","$","str","ModalFactory","Camera","cmid","mainimage","attemptid","docElement","document","video","getElementById","this","videoid","canvas","canvasid","on","showpopup","bind","setTimeout","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","prototype","width","height","takepictureid","retakeid","takepicture","getContext","drawImage","data","toDataURL","hide","show","val","prop","ajax","url","M","cfg","wwwroot","method","imgBase64","success","response","errorcode","trigger","error","proctoringimage","redirect","window","onbeforeunload","location","href","encodeURI","retake","event","message","create","body","modal","init","setinterval","camera","attr","id","appendTo","setInterval","e","preventDefault","get_string"],"mappings":"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"}