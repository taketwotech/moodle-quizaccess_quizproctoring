define("quizaccess_quizproctoring/report",["jquery","core/modal_factory","core/modal_events","core/templates","core/str","core/notification"],(function($,ModalFactory,ModalEvents,Templates,str,notification){return{init:function(){$(document).ready((function(){"undefined"!=typeof lightbox&&lightbox.init()})),$("#proctoringreporttable").on("click",".delete-icon",(function(event){event.preventDefault();var username=$(this).data("username"),cmid=$(this).data("cmid"),quizid=$(this).data("quizid"),userid=$(this).data("userid"),newUrl=M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/proctoringreport.php?delete="+userid+"&cmid="+cmid+"&quizid="+quizid;Promise.all([str.get_string("deleteallimagesuser","quizaccess_quizproctoring",username),str.get_string("confirmation","quizaccess_quizproctoring"),str.get_string("deleteallimages","quizaccess_quizproctoring"),str.get_string("delete","moodle"),str.get_string("cancel","moodle")]).then((function(strings){var message=strings[0],title=strings[1],checkboxtext=strings[2],deleteLabel=strings[3],cancelLabel=strings[4],checkboxHtml='<div><input type="checkbox" id="deleteallimages" /><label class="deleteall">'+checkboxtext+"</label></div>";notification.confirm(title,message+checkboxHtml,deleteLabel,cancelLabel,(function(){$("#deleteallimages").is(":checked")&&(newUrl+="&all=true",window.location.href=newUrl)}),(function(){})),setTimeout((function(){$(".modal-footer").addClass("deletenotifbtn");var deleteButton=$('.modal-footer button[data-action="save"]');deleteButton.prop("disabled",!0),$(document).off("change","#deleteallimages").on("change","#deleteallimages",(function(){deleteButton.prop("disabled",!$(this).is(":checked"))}))}),300)})).catch((function(){}))})),$("#proctoringreporttable").on("click",".delete-aicon",(function(event){event.preventDefault();var username=$(this).data("username"),cmid=$(this).data("cmid"),quizid=$(this).data("quizid"),userid=$(this).data("userid"),newUrl=M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/proctoringreport.php?deleteaudio="+userid+"&cmid="+cmid+"&quizid="+quizid;Promise.all([str.get_string("deleteallaudiosuser","quizaccess_quizproctoring",username),str.get_string("confirmation","quizaccess_quizproctoring"),str.get_string("deleteallaudios","quizaccess_quizproctoring"),str.get_string("delete","moodle"),str.get_string("cancel","moodle")]).then((function(strings){var message=strings[0],title=strings[1],checkboxtext=strings[2],deleteLabel=strings[3],cancelLabel=strings[4],checkboxHtml='<div><input type="checkbox" id="deleteallaudios" /><label class="deleteall">'+checkboxtext+"</label></div>";notification.confirm(title,message+checkboxHtml,deleteLabel,cancelLabel,(function(){$("#deleteallaudios").is(":checked")&&(newUrl+="&all=true",window.location.href=newUrl)}),(function(){})),setTimeout((function(){$(".modal-footer").addClass("deletenotifbtn");var deleteButton=$('.modal-footer button[data-action="save"]');deleteButton.prop("disabled",!0),$(document).off("change","#deleteallaudios").on("change","#deleteallaudios",(function(){deleteButton.prop("disabled",!$(this).is(":checked"))}))}),300)})).catch((function(){}))})),$(".delete-quiz").on("click",(function(event){event.preventDefault();var quizname=$(this).data("quiz"),cmid=$(this).data("cmid"),quizid=$(this).data("quizid"),newUrl=M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/imagesreport.php?cmid="+cmid+"&delete="+quizid;Promise.all([str.get_string("deleteallimagesquiz","quizaccess_quizproctoring",quizname),str.get_string("confirmation","quizaccess_quizproctoring"),str.get_string("deleteallimages","quizaccess_quizproctoring"),str.get_string("delete","moodle"),str.get_string("cancel","moodle")]).then((function(strings){var message=strings[0],title=strings[1],checkboxtext=strings[2],deleteLabel=strings[3],cancelLabel=strings[4],checkboxHtml='<div><input type="checkbox" id="deleteallimage" /><label class="deleteall">'+checkboxtext+"</label></div>";notification.confirm(title,message+checkboxHtml,deleteLabel,cancelLabel,(function(){$("#deleteallimage").is(":checked")&&(newUrl+="&all=true",window.location.href=newUrl)}),(function(){})),setTimeout((function(){$(".modal-footer").addClass("deletenotifbtn");var deleteButton=$('.modal-footer button[data-action="save"]');deleteButton.prop("disabled",!0),$(document).off("change","#deleteallimage").on("change","#deleteallimage",(function(){deleteButton.prop("disabled",!$(this).is(":checked"))}))}),300)})).catch((function(){}))})),$(".delete-audio-quiz").on("click",(function(event){event.preventDefault();var quizname=$(this).data("quiz"),cmid=$(this).data("cmid"),quizid=$(this).data("quizid"),newUrl=M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/imagesreport.php?cmid="+cmid+"&deleteaudioquiz="+quizid;Promise.all([str.get_string("deleteallaudiosquiz","quizaccess_quizproctoring",quizname),str.get_string("confirmation","quizaccess_quizproctoring"),str.get_string("deleteallaudios","quizaccess_quizproctoring"),str.get_string("delete","moodle"),str.get_string("cancel","moodle")]).then((function(strings){var message=strings[0],title=strings[1],checkboxtext=strings[2],deleteLabel=strings[3],cancelLabel=strings[4],checkboxHtml='<div><input type="checkbox" id="deleteallaudio" /><label class="deleteall">'+checkboxtext+"</label></div>";notification.confirm(title,message+checkboxHtml,deleteLabel,cancelLabel,(function(){$("#deleteallaudio").is(":checked")&&(newUrl+="&all=true",window.location.href=newUrl)}),(function(){})),setTimeout((function(){$(".modal-footer").addClass("deletenotifbtn");var deleteButton=$('.modal-footer button[data-action="save"]');deleteButton.prop("disabled",!0),$(document).off("change","#deleteallaudio").on("change","#deleteallaudio",(function(){deleteButton.prop("disabled",!$(this).is(":checked"))}))}),300)})).catch((function(){}))})),$(".delcourseaudio").on("click",(function(event){event.preventDefault();var coursename=$(this).data("course"),cmid=$(this).data("cmid"),courseid=$(this).data("courseid"),newUrl=M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/imagesreport.php?cmid="+cmid+"&deleteaudiocourse="+courseid;Promise.all([str.get_string("deleteallaudioscourse","quizaccess_quizproctoring",coursename),str.get_string("confirmation","quizaccess_quizproctoring"),str.get_string("deleteallaudios","quizaccess_quizproctoring"),str.get_string("delete","moodle"),str.get_string("cancel","moodle")]).then((function(strings){var message=strings[0],title=strings[1],checkboxtext=strings[2],deleteLabel=strings[3],cancelLabel=strings[4],checkboxHtml='<div><input type="checkbox" id="deleteallaudioc" /><label class="deleteall">'+checkboxtext+"</label></div>";notification.confirm(title,message+checkboxHtml,deleteLabel,cancelLabel,(function(){$("#deleteallaudioc").is(":checked")&&(newUrl+="&all=true",window.location.href=newUrl)}),(function(){})),setTimeout((function(){$(".modal-footer").addClass("deletenotifbtn");var deleteButton=$('.modal-footer button[data-action="save"]');deleteButton.prop("disabled",!0),$(document).off("change","#deleteallaudioc").on("change","#deleteallaudioc",(function(){deleteButton.prop("disabled",!$(this).is(":checked"))}))}),300)})).catch((function(){}))})),$(".delcourse").on("click",(function(event){event.preventDefault();var coursename=$(this).data("course"),cmid=$(this).data("cmid"),courseid=$(this).data("courseid"),newUrl=M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/imagesreport.php?cmid="+cmid+"&delcourse="+courseid;Promise.all([str.get_string("deleteallimagescourse","quizaccess_quizproctoring",coursename),str.get_string("confirmation","quizaccess_quizproctoring"),str.get_string("deleteallimages","quizaccess_quizproctoring"),str.get_string("delete","moodle"),str.get_string("cancel","moodle")]).then((function(strings){var message=strings[0],title=strings[1],checkboxtext=strings[2],deleteLabel=strings[3],cancelLabel=strings[4],checkboxHtml='<div><input type="checkbox" id="deleteallimag" /><label class="deleteall">'+checkboxtext+"</label></div>";notification.confirm(title,message+checkboxHtml,deleteLabel,cancelLabel,(function(){$("#deleteallimag").is(":checked")&&(newUrl+="&all=true",window.location.href=newUrl)}),(function(){})),setTimeout((function(){$(".modal-footer").addClass("deletenotifbtn");var deleteButton=$('.modal-footer button[data-action="save"]');deleteButton.prop("disabled",!0),$(document).off("change","#deleteallimag").on("change","#deleteallimag",(function(){deleteButton.prop("disabled",!$(this).is(":checked"))}))}),300)})).catch((function(){}))})),$("#attemptsreporttable").on("click",".proctoringimage",(function(event){event.preventDefault();var checkboxLabel,attemptid=$(this).data("attemptid"),quizid=$(this).data("quizid"),userid=$(this).data("userid"),startdate=$(this).data("startdate"),all=!1,modaltitle=M.util.get_string("proctoringimages","quizaccess_quizproctoring"),storeAllImages=$("#storeallimages").val();str.get_string("viewallimages_checkbox","quizaccess_quizproctoring").then((function(label){return checkboxLabel=label,ModalFactory.create({type:ModalFactory.types.DEFAULT,body:'<div class="image-content"><p>Loading images...</p></div><div class="pagination-controls"></div>',title:modaltitle,large:!0})})).then((function(modal){modal.show(),$(".imgcheckbox").prop("checked",!1);var checkboxContainer='\n                        <div class="checkbox-container" style="display: none;">\n                            <input type="checkbox" class="imgcheckbox">\n                            <label for="checkbox" class="image-checkbox">\n                                '.concat(checkboxLabel,"\n                            </label>\n                        </div>\n                    ");return modal.getBody().prepend(checkboxContainer),modal})).then((function(modal){"1"===storeAllImages?modal.getBody().find(".checkbox-container").show():modal.getBody().find(".checkbox-container").hide();var currentPage=1,totalPages=1;function loadImages(page){$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_report.php",data:{attemptid:attemptid,userid:userid,quizid:quizid,all:all.toString(),page:page,perpage:35},dataType:"json",success:function(response){var images=response.images.map((function(image){return{url:image.img,title:image.title,time:image.timecreated,cssClass:getCssClass(image.imagestatus)}}));totalPages=response.totalPages;var data={attemptdate:startdate,images:images,currentPage:response.currentPage,totalPages:response.totalPages,isFirstPage:1===response.currentPage,isLastPage:response.currentPage===response.totalPages,str:function(key){return M.util.get_string(key,"quizaccess_quizproctoring")}};modal.getBody().find(".image-content").html(""),Templates.render("quizaccess_quizproctoring/response_modal",data).done((function(renderedHtml){modal.getBody().find(".image-content").html(renderedHtml),lightbox.init();var imagesInThisModal=modal.getBody().find(".image-link"),totalImages=imagesInThisModal.length;$(".image-link").on("click",(function(event){event.preventDefault();var index=imagesInThisModal.index($(this));-1!==index&&($(".lb-caption").each((function(){0===$(this).next(".lb-num").length&&$(this).after('<span class="lb-num"></span>')})),$(".lb-num").text("Image "+(index+1)+" of "+totalImages),lightbox.start($(this)),$(".lb-next, .lb-prev").off("click").on("click",(function(event){event.preventDefault(),$(this).hasClass("lb-next")?index=(index+1)%totalImages:$(this).hasClass("lb-prev")&&(index=(index-1+totalImages)%totalImages);var newImageSrc=imagesInThisModal.eq(index).attr("href");$(".lb-image").attr("src",newImageSrc),$(".lb-num").text("Image "+(index+1)+" of "+totalImages)})))})),$(".image-link").on("lightbox:open",(function(){$(this).next(".image-title").hide()})),$(".imgcheckbox").prop("checked",all),images.length>0?modal.getBody().find(".pagination-controls").html(function(currentPage,totalPages){return'<div><button class="prev-page" '+(1===currentPage?"disabled":"")+">Previous</button> Page "+currentPage+" of "+totalPages+' <button class="next-page" '+(currentPage===totalPages?"disabled":"")+">Next</button></div>"}(response.currentPage,response.totalPages)):modal.getBody().find(".pagination-controls").html("")}))},error:function(jqXHR,textStatus){modal.getBody().find(".image-content").html("<p>Error loading images: "+textStatus+"</p>")}})}function getCssClass(status){switch(status.toLowerCase()){case"main image":return"main-image";case"warning":return"warning-image";default:return"green-image"}}modal.getRoot().on("hidden.bs.modal",(function(){$(".imgcheckbox").prop("checked",!1)})),modal.getBody().on("change",".imgcheckbox",(function(){all=$(this).is(":checked"),modaltitle=all?M.util.get_string("allimages","quizaccess_quizproctoring"):M.util.get_string("proctoringimages","quizaccess_quizproctoring"),modal.setTitle(modaltitle),loadImages(currentPage)})),modal.getBody().off("click",".prev-page").on("click",".prev-page",(function(){currentPage>1&&loadImages(--currentPage)})),modal.getBody().off("click",".next-page").on("click",".next-page",(function(){currentPage<totalPages&&loadImages(++currentPage)})),loadImages(currentPage),modal.getBody().on("click",".close",(function(){$(".imgcheckbox").prop("checked",!1)}));let escapePressed=!1;$(document).on("keydown",(function(event){"Escape"!==event.key||escapePressed||(escapePressed=!0,"block"===$(".lb-container").css("display")&&lightbox.end(),void 0!==modal&&modal.isVisible()&&modal.hide(),setTimeout((()=>{escapePressed=!1}),50),event.stopPropagation(),$(".imgcheckbox").prop("checked",!1))}))})).catch((function(){}))})),$("#attemptsreporttable").on("click",".proctoringaudio",(function(event){event.preventDefault();var attemptid=$(this).data("attemptid"),startdate=$(this).data("startdate"),modaltitle=M.util.get_string("proctoringaudio","quizaccess_quizproctoring");ModalFactory.create({type:ModalFactory.types.DEFAULT,body:'<div class="audio-content"><p>Loading audios...</p></div><div class="pagination-controls"></div>',title:modaltitle,large:!0}).then((function(modal){modal.show();var currentPage=1,totalPages=1;function stopAllAudioInModal(){modal.getRoot().find("audio").each((function(){this.pause(),this.currentTime=0}))}function loadAudios(page){$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/audio_report.php",data:{attemptid:attemptid,page:page,perpage:20},dataType:"json",success:function(response){if(!response||!Array.isArray(response.audios))return modal.getBody().find(".audio-content").html("<p>Error: Invalid audio.</p>"),void modal.getBody().find(".pagination-controls").html("");totalPages=response.totalPages;var audios=response.audios.map((function(audio){return{url:audio.audiofile,time:audio.timecreated}})),data={attemptdate:startdate,audios:audios,currentPage:response.currentPage,totalPages:response.totalPages,isFirstPage:1===response.currentPage,isLastPage:response.currentPage===response.totalPages,str:function(key){return M.util.get_string(key,"quizaccess_quizproctoring")}};modal.getBody().find(".audio-content").html(""),Templates.render("quizaccess_quizproctoring/response_audio_modal",data).done((function(renderedHtml){modal.getBody().find(".audio-content").html(renderedHtml),$("audio").on("play",(function(){$("audio").not(this).each((function(){this.pause(),this.currentTime=0}))})),audios.length>0?modal.getBody().find(".pagination-controls").html(function(currentPage,totalPages){return'<div><button class="prev-page" '+(1===currentPage?"disabled":"")+">Previous</button> Page "+currentPage+" of "+totalPages+' <button class="next-page" '+(currentPage===totalPages?"disabled":"")+">Next</button></div>"}(response.currentPage,response.totalPages)):modal.getBody().find(".pagination-controls").html("")}))},error:function(jqXHR,textStatus){modal.getBody().find(".audio-content").html("<p>Error loading audios: "+textStatus+"</p>")}})}modal.getRoot().on(ModalEvents.hidden,(function(){stopAllAudioInModal(),$(document).off("keydown.stopAllAudioOnEsc")})),$(document).on("keydown.stopAllAudioOnEsc",(function(e){"Escape"===e.key&&stopAllAudioInModal()})),modal.getRoot().on("click",".prev-page, .next-page",(function(){stopAllAudioInModal()})),modal.getBody().off("click",".prev-page").on("click",".prev-page",(function(){currentPage>1&&loadAudios(--currentPage)})),modal.getBody().off("click",".next-page").on("click",".next-page",(function(){currentPage<totalPages&&loadAudios(++currentPage)})),loadAudios(currentPage)}))})),$("#attemptsreporttable").on("click",".proctoridentity",(function(event){event.preventDefault(),$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/proctoridentity.php",data:{attemptid:$(this).data("attemptid"),userid:$(this).data("userid"),quizid:$(this).data("quizid")},dataType:"json",success:function(response){var residentity=JSON.parse(JSON.stringify(response));return residentity.success?(window.open(residentity.url,"_blank"),!0):ModalFactory.create({type:ModalFactory.types.DEFAULT,body:residentity.message}).then((function(modal){return modal.getRoot().on(ModalEvents.hidden,modal.destroy.bind(modal)),modal.show(),null}))}})})),$("#attemptsreporttable").on("click",".generate",(function(event){event.preventDefault();const attemptid=$(this).data("attemptid"),quizid=$(this).data("quizid"),userid=$(this).data("userid"),username=encodeURIComponent($(this).data("username")),url="".concat(M.cfg.wwwroot,"/mod/quiz/accessrule/quizproctoring/userreport.php")+"?attemptid=".concat(attemptid)+"&quizid=".concat(quizid)+"&userid=".concat(userid)+"&username=".concat(username);window.open(url,"_blank")})),$(document).on("click",".alert-icon",(function(event){event.preventDefault(),event.stopPropagation();var alertsDataJson=$(this).attr("data-alerts");if(alertsDataJson){var alertsData;try{alertsData=JSON.parse(alertsDataJson)}catch(e){return void str.get_string("error","moodle").catch((function(){return"Error parsing alerts data"})).then((function(errorMsg){notification.addNotification({message:errorMsg,type:"error"})}))}Promise.all([str.get_string("alerts","quizaccess_quizproctoring"),str.get_string("close","moodle")]).then((function(strings){var alertTitle=strings[0],closeLabel=strings[1];function escapeHtml(text){return text?String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function closeAlertsModal(){var modalElement=$("#alertsModal");modalElement.length>0&&(modalElement.removeClass("show"),setTimeout((function(){modalElement.remove(),$(document).off("keydown.alertsModal")}),300))}var existingModal=$("#alertsModal");existingModal.length>0&&(existingModal.remove(),$(document).off("keydown.alertsModal"));var title,alerts,bodyContent,modalHtml=(title=alertTitle,bodyContent="",(alerts=alertsData)&&alerts.length>0?alerts.forEach((function(alert){bodyContent+=function(alert){var message=escapeHtml(alert.message||""),time=escapeHtml(alert.time||""),teacher=escapeHtml(alert.teacher||""),teacherHtml="";return teacher&&(teacherHtml='<div class="alert-teacher"><strong>Teacher:</strong> '+teacher+"</div>"),'<div class="alert-row">'+teacherHtml+'<div class="alert-content"><div class="alert-message">'+message+'</div><div class="alert-time">'+time+"</div></div></div>"}(alert)})):bodyContent='<p class="no-alerts">No alerts found</p>','<div id="alertsModal" class="alerts-modal"><div class="alerts-modal-content"><div class="alerts-modal-header"><h4 class="alerts-modal-title">'+escapeHtml(title)+'</h4><button type="button" class="alerts-close" aria-label="'+escapeHtml(closeLabel)+'"><span aria-hidden="true">&times;</span></button></div><div class="alerts-modal-body">'+bodyContent+"</div></div></div>");$("body").append(modalHtml);var modal=$("#alertsModal");setTimeout((function(){modal.addClass("show")}),10),modal.on("click",".alerts-close",(function(){closeAlertsModal()})),modal.on("click",(function(e){$(e.target).is("#alertsModal")&&closeAlertsModal()})),$(document).on("keydown.alertsModal",(function(e){"Escape"===e.key&&modal.is(":visible")&&closeAlertsModal()}))})).catch((function(){return str.get_string("error","moodle").then((function(errorMsg){notification.addNotification({message:errorMsg,type:"error"})})).catch((function(){notification.addNotification({message:"Error loading alerts",type:"error"})}))}))}})),$("#attemptsreporttable").on("click",".eyetoggle",(function(event){event.preventDefault(),event.stopPropagation();const $checkbox=$(this).find('input[type="checkbox"]'),currentState=$checkbox.is(":checked"),$toggle=$(this),cmid=$toggle.data("cmid"),attemptid=$toggle.data("attemptid"),userid=$toggle.data("userid"),useremail=$toggle.data("useremail"),action=$toggle.data("action");function showEyeToggleError(){return str.get_string("eyeofferror","quizaccess_quizproctoring").then((function(text){notification.addNotification({message:text,type:"error"})})).catch((function(){notification.addNotification({message:"Error occurred",type:"error"})}))}function showConfirmationDialog(checkboxChecked){const messageKey="disable"===action?"disableeyetrackingmessage":"enableeyetrackingmessage";Promise.all([str.get_string(messageKey,"quizaccess_quizproctoring",useremail),str.get_string("disableeyetrackingallquizzes","quizaccess_quizproctoring"),str.get_string("yes","moodle"),str.get_string("cancel","moodle")]).then((function(strings){const message=strings[0],checkboxText=strings[1],confirmLabel=strings[2],cancelLabel=strings[3],checkboxHtml='\n                            <div style="margin-top: 15px;">\n                                <input type="checkbox" id="eyetrackingglobal" '.concat(checkboxChecked?"checked":"",' />\n                                <label for="eyetrackingglobal" style="margin-left: 5px;">\n                                    ').concat(checkboxText,"\n                                </label>\n                            </div>\n                        ");notification.confirm("",message+checkboxHtml,confirmLabel,cancelLabel,(function(){const setGlobal=$("#eyetrackingglobal").is(":checked")?1:0;var setGlobalValue;setGlobalValue=setGlobal,$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_eyetoggle.php",method:"POST",data:{cmid:cmid,attemptid:attemptid,userid:userid,action:action,setglobal:setGlobalValue},dataType:"json",success:function(response){response.success&&(void 0!==window.attemptsReportTable&&window.attemptsReportTable&&void 0!==window.attemptsReportTable.ajax&&"function"==typeof window.attemptsReportTable.ajax.reload?window.attemptsReportTable.ajax.reload(null,!1):window.location.reload())},error:showEyeToggleError})}),(function(){}))})).catch((function(){notification.addNotification({message:"Error loading confirmation dialog",type:"error"})}))}setTimeout((function(){$checkbox.prop("checked",currentState)}),0),$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_eyetoggle.php",method:"POST",data:{cmid:cmid,attemptid:attemptid,userid:userid,action:"getpreference"},dataType:"json",success:function(prefResponse){showConfirmationDialog(null!==prefResponse.globalpreference&&void 0!==prefResponse.globalpreference)},error:function(){showConfirmationDialog(!1)}})}))}}}));

//# sourceMappingURL=report.min.js.map