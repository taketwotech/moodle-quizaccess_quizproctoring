/**
 * Javascript controller for the "Grading" panel at the right of the page
 *
 * @subpackage quizproctoring
 * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("quizaccess_quizproctoring/response_proctoring",["jquery","core/modal_factory","quizaccess_quizproctoring/modal_proctoring","core/modal_events"],(function($,ModalFactory,ModalProctoringImages,ModalEvents){var ResponsePanel=function(responses){this.responses=responses,this.registerEventListeners()};ResponsePanel.prototype.qid=null,ResponsePanel.prototype.rid=null,ResponsePanel.prototype.sec=null,ResponsePanel.prototype.courseid=null,ResponsePanel.prototype.responses=Array(),ResponsePanel.prototype.index=0,ResponsePanel.prototype.quizid=0,ResponsePanel.prototype.attemptid=0,ResponsePanel.prototype.userid=0,ResponsePanel.prototype.currentpage=1,ResponsePanel.prototype.firstPage=1,ResponsePanel.prototype.lastPage=0,ResponsePanel.prototype.tempindex=0,ResponsePanel.prototype.prevpage=0,ResponsePanel.prototype.temarrayprev=Array(),ResponsePanel.prototype.temarraynext=Array(),ResponsePanel.prototype.registerEventListeners=function(){var docElement=$(document);docElement.on("next",this._getNextUser.bind(this)),docElement.on("prev",this._getPreviousUser.bind(this))},ResponsePanel.prototype._reset=function(){if(this.responses.length){var isFirst=0===this.index,isLast=this.responses.length===this.index+1;isFirst?(this.firstPage==this.currentpage?$('[data-action="previous"]').prop("disabled","disabled"):$('[data-action="previous"]').prop("disabled",!1),$('[data-action="next"]').prop("disabled",!1)):isLast?(this.currentpage==this.lastpage?$('[data-action="next"]').prop("disabled","disabled"):$('[data-action="next"]').prop("disabled",!1),$('[data-action="previous"]').prop("disabled",!1)):($('[data-action="previous"]').prop("disabled",!1),$('[data-action="next"]').prop("disabled",!1))}},ResponsePanel.prototype._isFirstPage=function(){var insidethid=this;$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_report.php",data:{attemptid:this.attemptid,userid:this.userid,quizid:this.quizid,currentpage:this.currentpage-2},dataType:"json",success:function(response){var images=JSON.parse(JSON.stringify(response));insidethid.temarrayprev=images,insidethid.prevpage=1}})},ResponsePanel.prototype._isLastPage=function(){var insidethid=this;$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_report.php",data:{attemptid:this.attemptid,userid:this.userid,quizid:this.quizid,currentpage:this.currentpage},dataType:"json",success:function(response){var images=JSON.parse(JSON.stringify(response));insidethid.temarraynext=images,images[0]&&(insidethid.tempindex=1)}})},ResponsePanel.prototype._getNextUser=function(){this.tempindex&&(this.index=-1,this.responses=this.temarraynext,this.currentpage+=1),this.tempindex=0,this.prevpage=0,this.index+=1,this._reset();var res=this.responses[this.index];res&&($(".imgheading").html(res.title),$(".userimg").attr("src",res.img)),0===this.index&&this._isFirstPage(),this.responses.length===this.index+1&&this._isLastPage()},ResponsePanel.prototype._getPreviousUser=function(){this.tempindex?this.index=18:this.index-=1,this.prevpage&&(this.index=19,this.responses=this.temarrayprev,this.currentpage-=1),this.prevpage=0,this.tempindex=0,this._reset();var res=this.responses[this.index];res&&($(".imgheading").html(res.title),$(".userimg").attr("src",res.img)),0===this.index&&this._isFirstPage(),this.responses.length===this.index+1&&this._isLastPage()};return{init:function(){let attemptid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,quizid=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,userid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,useridentity=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,proctoringimageshow=arguments.length>4?arguments[4]:void 0;var docElement=$(document);docElement.ready((function(){if(1==proctoringimageshow){let btn=document.createElement("button");btn.innerHTML=M.util.get_string("proctoringimages","quizaccess_quizproctoring"),btn.setAttribute("type","button"),btn.setAttribute("value","proctoringimage"),btn.setAttribute("class","proctoringimage btn btn-primary"),btn.setAttribute("data-attemptid",attemptid),btn.setAttribute("data-quizid",quizid),btn.setAttribute("data-userid",userid),document.getElementById("page-content").prepend(btn)}if(useridentity&&0!=useridentity){let btnidentity=document.createElement("button");btnidentity.innerHTML=M.util.get_string("proctoringidentity","quizaccess_quizproctoring"),btnidentity.setAttribute("type","button"),btnidentity.setAttribute("value","proctoridentity"),btnidentity.setAttribute("class","proctoridentity btn btn-primary"),btnidentity.setAttribute("data-attemptid",attemptid),btnidentity.setAttribute("data-quizid",quizid),btnidentity.setAttribute("data-userid",userid),document.getElementById("page-content").prepend(btnidentity)}})),docElement.on("click","button.proctoringimage",(function(e){e.preventDefault();var quizid=$(this).data("quizid"),userid=$(this).data("userid"),attemptid=$(this).data("attemptid");$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_report.php",data:{attemptid:$(this).data("attemptid"),userid:$(this).data("userid"),quizid:$(this).data("quizid")},dataType:"json",success:function(response){var images=JSON.parse(JSON.stringify(response));if(images.length>0){var rp=new ResponsePanel(images);return rp.quizid=quizid,rp.userid=userid,rp.attemptid=attemptid,rp.lastpage=rp.responses[rp.index].totalpage,ModalFactory.create({type:ModalProctoringImages.TYPE}).then((function(modal){return modal.getRoot().on(ModalEvents.hidden,modal.destroy.bind(modal)),modal.setTitle("User Images"),modal.show(),$(".imgheading").html(rp.responses[rp.index].title),$(".userimg").attr("src",rp.responses[rp.index].img),1==rp.responses[rp.index].total&&$('[data-action="next"]').prop("disabled","disabled"),null}))}var message=M.util.get_string("noimageswarning","quizaccess_quizproctoring");return ModalFactory.create({type:ModalFactory.types.DEFAULT,body:message}).then((function(modal){return modal.getRoot().on(ModalEvents.hidden,modal.destroy.bind(modal)),modal.show(),null}))}})})),docElement.on("click","button.proctoridentity",(function(e){e.preventDefault(),$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/proctoridentity.php",data:{attemptid:$(this).data("attemptid"),userid:$(this).data("userid"),quizid:$(this).data("quizid")},dataType:"json",success:function(response){var residentity=JSON.parse(JSON.stringify(response));return residentity.success?(window.open(residentity.url,"_blank"),!0):ModalFactory.create({type:ModalFactory.types.DEFAULT,body:residentity.message}).then((function(modal){return modal.getRoot().on(ModalEvents.hidden,modal.destroy.bind(modal)),modal.show(),null}))}})}))}}}));

//# sourceMappingURL=response_proctoring.min.js.map