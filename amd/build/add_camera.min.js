/**
 * JavaScript class for Camera
 *
 * @subpackage quizproctoring
 * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
window.addEventListener("beforeunload",(function(event){event.stopImmediatePropagation(),event.returnValue=""})),define("quizaccess_quizproctoring/add_camera",["jquery","core/str","core/modal_factory"],(function($,str,ModalFactory){$(".quizstartbuttondiv [type=submit]").prop("disabled",!0);var Camera=function(cmid){let mainimage=arguments.length>1&&void 0!==arguments[1]&&arguments[1],attemptid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,quizid=arguments.length>3?arguments[3]:void 0;var docElement=$(document);this.video=document.getElementById(this.videoid),this.canvas=document.getElementById(this.canvasid),this.cmid=cmid,this.quizid=quizid,this.mainimage=mainimage,this.attemptid=attemptid,$("#id_submitbutton").prop("disabled",!0),docElement.on("popup",this.showpopup.bind(this))};Camera.prototype.video=!1,Camera.prototype.videoid="video",Camera.prototype.canvas=!1,Camera.prototype.canvasid="canvas",Camera.prototype.width=320,Camera.prototype.height=240,Camera.prototype.takepictureid="takepicture",Camera.prototype.retakeid="retake",Camera.prototype.cmid=!1,Camera.prototype.mainimage=!1,Camera.prototype.attemptid=!1,Camera.prototype.quizid=!1,Camera.prototype.startcamera=function(){const takePictureButton=$("#"+this.takepictureid);return takePictureButton.prop("disabled",!0),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then((function(stream){const videoElement=document.getElementById("video");if(videoElement){videoElement.srcObject=stream,videoElement.muted=!0,videoElement.playsinline=!0,localMediaStream=stream,videoElement.play(),videoElement.addEventListener("contextmenu",(function(e){e.preventDefault()})),stream.getVideoTracks()[0].onended=function(){takePictureButton.prop("disabled",!0),$(document).trigger("popup","Camera or microphone is disabled. Please enable both to continue.")};const audioTrack=stream.getAudioTracks()[0];audioTrack?audioTrack.onended=function(){$(document).trigger("popup","Camera or microphone is disabled. Please enable both to continue.")}:$(document).trigger("popup","Camera or microphone is disabled. Please enable both to continue.");const savedPosition=JSON.parse(localStorage.getItem("videoPosition"));let offsetX,offsetY;savedPosition&&(videoElement.style.left=savedPosition.left,videoElement.style.top=savedPosition.top);let isDragging=!1;const stopDragging=function(){if(isDragging){isDragging=!1,videoElement.style.zIndex=9999998;const position={left:videoElement.style.left,top:videoElement.style.top};localStorage.setItem("videoPosition",JSON.stringify(position))}};videoElement.addEventListener("mousedown",(function(e){isDragging=!0,offsetX=e.clientX-videoElement.getBoundingClientRect().left,offsetY=e.clientY-videoElement.getBoundingClientRect().top,videoElement.style.zIndex=9999999})),window.addEventListener("mousemove",(function(e){isDragging&&(videoElement.style.left="".concat(e.clientX-offsetX,"px"),videoElement.style.top="".concat(e.clientY-offsetY,"px"))})),window.addEventListener("mouseup",stopDragging),window.addEventListener("mouseout",stopDragging),setInterval((()=>{isDragging&&stopDragging()}),2e3),takePictureButton.prop("disabled",!1)}return videoElement})).catch((function(){takePictureButton.prop("disabled",!0)}))},Camera.prototype.takepicture=function(){this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);var data=this.canvas.toDataURL("image/png");$("#"+this.videoid).hide(),$("#"+this.takepictureid).hide(),$("#"+this.canvasid).show(),$("#"+this.retakeid).show(),$("input[name='userimg']").val(data),$("#id_submitbutton").prop("disabled",!0),$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:{imgBase64:data,cmid:this.cmid,attemptid:this.attemptid,mainimage:this.mainimage},success:function(response){response&&response.errorcode?($("input[name='userimg']").val(""),$(document).trigger("popup",response.error)):$("#id_submitbutton").prop("disabled",!1)}})},Camera.prototype.proctoringimage=function(){var requestData={cmid:this.cmid,attemptid:this.attemptid,mainimage:this.mainimage};if(this.canvas){this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);var data=this.canvas.toDataURL("image/png");requestData.imgBase64=data}$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:requestData,success:function(response){response&&response.errorcode?$(document).trigger("popup",response.error):response.redirect&&response.url&&(window.onbeforeunload=null,$(document).trigger("popup",response.msg),setTimeout((function(){window.location.href=encodeURI(response.url)}),3e3))}})},Camera.prototype.resetcamera=function(){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),$("#"+this.canvasid).hide(),$("#"+this.retakeid).hide(),$("#"+this.videoid).show(),$("#"+this.takepictureid).show(),$("input[name='userimg']").val("")};var signalingSocket=null,localMediaStream=null,peers={},peerId=null,peerMediaElements={},connectedPeers={},attachMediaStream=null,total=0;let gazeDirection=null,gazeTimer=null;let eyeStatus="Open",eyeTimer=null;let lastDetectionTime=Date.now(),cachedStudentData=(Date.now(),null);var ICE_SERVERS=[{urls:"stun:stun.l.google.com:19302"}];Camera.prototype.retake=function(){$("input[name='userimg']").val(""),$("#"+this.videoid).show(this.cmid),$("#"+this.takepictureid).show(),$("#"+this.canvasid).hide(),$("#"+this.retakeid).hide(),$("#id_submitbutton").prop("disabled",!0)},Camera.prototype.showpopup=function(event,message){return this.activeModal&&(this.activeModal.hide(),this.activeModal.destroy()),ModalFactory.create({body:message}).then((modal=>(this.activeModal=modal,modal.show(),null)))},Camera.prototype.stopcamera=function(){localMediaStream&&(localMediaStream.getTracks().forEach((function(track){track.stop()})),localMediaStream=null)};return{init:function(cmid,mainimage){let verifyduringattempt=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],attemptid=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,teacher=arguments.length>4?arguments[4]:void 0,quizid=arguments.length>5?arguments[5]:void 0,serviceoption=arguments.length>6?arguments[6]:void 0,securewindow=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,userfullname=arguments.length>8?arguments[8]:void 0,enablestudentvideo=arguments.length>9&&void 0!==arguments[9]?arguments[9]:1,enablestrictcheck=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,setinterval=arguments.length>11&&void 0!==arguments[11]?arguments[11]:300;const noStudentOnlineDiv=document.getElementById("nostudentonline");var camera;if(verifyduringattempt)document.addEventListener("keydown",(function(event){!event.ctrlKey&&!event.metaKey||"c"!==event.key&&"v"!==event.key||event.preventDefault()})),document.addEventListener("dragstart",(function(event){event.preventDefault()})),document.addEventListener("drop",(function(event){event.preventDefault()})),(signalingSocket=io("https://proctoring.taketwotechnologies.com")).on("connect",(function(){var storedSession=localStorage.getItem("sessionState"),sessionState=storedSession?JSON.parse(storedSession):null;setupLocalMedia(cmid,mainimage,verifyduringattempt,attemptid,teacher,enablestudentvideo,enablestrictcheck,setinterval,serviceoption,quizid,(function(){var typet={type:"teacher"===getTeacherroom()?"teacher":"student"},fullname=userfullname;signalingSocket.emit("join",{room:quizid,userdata:{quizid:quizid,type:typet,fullname:fullname}}),sessionState&&restoreSessionState(sessionState)}))})),signalingSocket.on("disconnect",(function(){for(peerId in peerMediaElements)peerMediaElements[peerId].remove();for(peerId in peers)peers[peerId].close();peers={},peerMediaElements={}})),signalingSocket.on("addPeer",(function(config){if(config.studentData&&0!==config.studentData.length&&(cachedStudentData=config.studentData),cachedStudentData){cachedStudentData.find((student=>student.id===config.peer_id))||cachedStudentData.push({id:config.peer_id,fullname:config.fullname})}else cachedStudentData=[];var peerId=config.peer_id;if(!(peerId in peers)){var peerConnection=new RTCPeerConnection({iceServers:ICE_SERVERS},{optional:[{DtlsSrtpKeyAgreement:!0}]});peers[peerId]=peerConnection,connectedPeers[peerId]={stream:new MediaStream},peerConnection.onicecandidate=function(event){event.candidate&&signalingSocket.emit("relayICECandidate",{peer_id:peerId,ice_candidate:{sdpMLineIndex:event.candidate.sdpMLineIndex,candidate:event.candidate.candidate}})},peerConnection.ontrack=function(event){var remoteMedia;if(connectedPeers[peerId].stream.addTrack(event.track),peerMediaElements[peerId])remoteMedia=peerMediaElements[peerId];else{(remoteMedia=$("<video>")).attr("autoplay","autoplay"),remoteMedia.attr("muted","true"),remoteMedia.attr("controls",""),remoteMedia.attr("class","quizaccess_quizproctoring"),remoteMedia.attr("controls",""),0===$("#region-main-box .videos-container").length&&$("#region-main-box").append($("<div>").addClass("videos-container"));var studentContainer=$("<div>").addClass("student-container");const studentData=cachedStudentData.find((sd=>sd.id===peerId)),studentNameText=studentData?studentData.fullname:config.fullname||"",studentName=$("<span>").addClass("student-name").text(studentNameText);studentContainer.append(remoteMedia),studentContainer.append(studentName),peerMediaElements[peerId]=remoteMedia,"teacher"===getTeacherroom()&&(total+=1,$(".videos-container").append(studentContainer),remoteMedia[0].srcObject=connectedPeers[peerId].stream)}},localMediaStream&&(noStudentOnlineDiv&&(noStudentOnlineDiv.style.display="none"),peerConnection.addStream(localMediaStream)),config.should_create_offer&&peerConnection.createOffer((function(localDescription){peerConnection.setLocalDescription(localDescription,(function(){signalingSocket.emit("relaySessionDescription",{peer_id:peerId,session_description:localDescription})}))}),(function(){}))}})),signalingSocket.on("sessionDescription",(function(config){var peerId=config.peer_id,peer=peers[peerId],remoteDescription=config.session_description,desc=new RTCSessionDescription(remoteDescription);peer.setRemoteDescription(desc).then((function(){return"offer"===remoteDescription.type?peer.createAnswer():null})).then((function(localDescription){return localDescription?peer.setLocalDescription(localDescription):null})).then((function(){return peer.localDescription&&signalingSocket.emit("relaySessionDescription",{peer_id:peerId,session_description:peer.localDescription}),null})).catch((function(error){throw error}))})),signalingSocket.on("iceCandidate",(function(config){var peer=peers[config.peer_id],iceCandidate=config.ice_candidate;peer.addIceCandidate(new RTCIceCandidate(iceCandidate))})),signalingSocket.on("removePeer",(function(config){var peerId=config.peer_id;if(peerId in peers){peers[peerId].removeStream(connectedPeers[peerId].stream),peers[peerId].close(),delete connectedPeers[peerId];var remoteMedia=peerMediaElements[peerId];remoteMedia&&(0===(total-=1)&&(noStudentOnlineDiv.style.display="block"),remoteMedia.closest(".student-container").remove()),delete peers[peerId],delete peerMediaElements[peerId]}}));else if("complete"===document.readyState?$(".quizstartbuttondiv [type=submit]").prop("disabled",!1):$(window).on("load",(function(){$(".quizstartbuttondiv [type=submit]").prop("disabled",!1)})),camera=new Camera(cmid,mainimage,attemptid,quizid),$(".quizstartbuttondiv [type=submit]").on("click",(function(){localStorage.removeItem("videoPosition"),camera.startcamera()})),$("#"+camera.takepictureid).on("click",(function(e){e.preventDefault(),camera.takepicture()})),$("#"+camera.retakeid).on("click",(function(e){e.preventDefault(),camera.retake()})),$("#id_cancel").on("click",(function(){camera.stopcamera(),camera.resetcamera(),$("#id_submitbutton").prop("disabled",!0),localStorage.removeItem("videoPosition")})),$(document).on("click",".closebutton",(function(){void 0!==camera&&"function"==typeof camera.stopcamera&&(camera.stopcamera(),camera.resetcamera(),$("#id_submitbutton").prop("disabled",!0),localStorage.removeItem("videoPosition"))})),document.addEventListener("keydown",(function(event){"Escape"===event.key&&(camera.stopcamera(),camera.resetcamera(),$("#id_submitbutton").prop("disabled",!0),localStorage.removeItem("videoPosition"))})),"securewindow"===securewindow){window.location.href.includes("startattempt.php")&&camera.startcamera()}}};function setupLocalMedia(cmid,mainimage,verifyduringattempt,attemptid,teacher,enablestudentvideo,enablestrictcheck,setinterval,serviceoption,quizid,callback){require(["core/ajax"],(function(){null===localMediaStream?"teacher"!==getTeacherroom()?(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,attachMediaStream=function(element,stream){element.srcObject=stream},navigator.mediaDevices.getUserMedia({audio:true,video:true}).then((function(stream){if(localMediaStream=stream,verifyduringattempt){$("<canvas>").attr({id:"canvas",width:"280",height:"240",style:"display: none;"}).appendTo("body"),$("<video>").attr({id:"video",class:"quizaccess_quizproctoring-video",width:"280",height:"240",autoplay:"autoplay"}).css("display",enablestudentvideo?"block":"none").appendTo("body"),document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:{cmid:cmid,attemptid:attemptid,mainimage:mainimage,tab:!0},success:function(response){response&&response.errorcode?$(document).trigger("popup",response.error):response.redirect&&response.url&&(window.onbeforeunload=null,$(document).trigger("popup",response.msg),setTimeout((function(){window.location.href=encodeURI(response.url)}),3e3))}})}));var camera=new Camera(cmid,mainimage,attemptid,quizid);if(camera.startcamera(),setInterval(camera.proctoringimage.bind(camera),1e3*setinterval),"AWS"!=serviceoption){const videoElement=document.getElementById("video"),canvasElement=document.getElementById("canvas");function processFrame(){videoElement.readyState<2?setTimeout(processFrame,1e3):(!function(videoElement,canvasElement,cmid,attemptid,mainimage,enablestrictcheck){const canvasCtx=canvasElement.getContext("2d"),faceMesh=new FaceMesh({locateFile:file=>"".concat(M.cfg.wwwroot,"/mod/quiz/accessrule/quizproctoring/libraries/facemesh/").concat(file)});faceMesh.setOptions({maxNumFaces:5,refineLandmarks:!0}),faceMesh.onResults((results=>{canvasCtx.save(),canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height),canvasCtx.drawImage(results.image,0,0,canvasElement.width,canvasElement.height);var data=canvasElement.toDataURL("image/png");const currentTime=Date.now();currentTime-lastDetectionTime>=5e3&&(void 0===results.multiFaceLandmarks?realtimeDetection(cmid,attemptid,mainimage,"noface",data):results.multiFaceLandmarks&&results.multiFaceLandmarks.length>1&&realtimeDetection(cmid,attemptid,mainimage,"multiface",data),lastDetectionTime=currentTime),1===enablestrictcheck&&1===results.multiFaceLandmarks.length&&results.multiFaceLandmarks.forEach((landmarks=>{!function(landmarks,cmid,attemptid,mainimage,data){const leftEye=landmarks[33],rightEye=landmarks[263],nose=landmarks[1],eyeMidpointX=(leftEye.x+rightEye.x)/2,noseX=nose.x;let currentDirection="Center";noseX<eyeMidpointX-.02?currentDirection="Right":noseX>eyeMidpointX+.02&&(currentDirection="Left");currentDirection!==gazeDirection&&(gazeDirection=currentDirection,gazeTimer&&(clearTimeout(gazeTimer),gazeTimer=null));"Center"!==gazeDirection?gazeTimer||(gazeTimer=setTimeout((()=>{realtimeDetection(cmid,attemptid,mainimage,""+gazeDirection,data)}),1e3)):gazeTimer&&(clearTimeout(gazeTimer),gazeTimer=null)}(landmarks,cmid,attemptid,mainimage,data),function(landmarks,cmid,attemptid,mainimage,data){const leftEyeUpper=landmarks[159],leftEyeLower=landmarks[145],rightEyeUpper=landmarks[386],rightEyeLower=landmarks[374],leftEyeOpen=Math.abs(leftEyeUpper.y-leftEyeLower.y),rightEyeOpen=Math.abs(rightEyeUpper.y-rightEyeLower.y),EYE_OPEN_THRESHOLD=.018;let currentEyeStatus=leftEyeOpen>EYE_OPEN_THRESHOLD&&rightEyeOpen>EYE_OPEN_THRESHOLD?"Open":"Closed";currentEyeStatus!==eyeStatus&&(eyeStatus=currentEyeStatus,eyeTimer&&(clearTimeout(eyeTimer),eyeTimer=null));"Closed"===eyeStatus?eyeTimer||(eyeTimer=setTimeout((()=>{realtimeDetection(cmid,attemptid,mainimage,"eyesnotopen",data)}),4e3)):eyeTimer&&(clearTimeout(eyeTimer),eyeTimer=null)}(landmarks,cmid,attemptid,mainimage,data)})),canvasCtx.restore()})),faceMesh.send({image:videoElement})}(videoElement,canvasElement,cmid,attemptid,mainimage,enablestrictcheck),setTimeout(processFrame,500))}videoElement&&canvasElement&&videoElement.addEventListener("loadeddata",(()=>{videoElement.play(),processFrame()}))}}return stream})).catch((function(error){if(verifyduringattempt&&"teacher"!==getTeacherroom()){var camera=new Camera(cmid,mainimage,attemptid,quizid);camera.startcamera(),setInterval(camera.proctoringimage.bind(camera),1e3*setinterval)}throw error})).finally((function(){callback&&callback()}))):(localMediaStream=function(){const dummyAudio=(new AudioContext).createMediaStreamDestination(),dummyVideo=document.createElement("canvas").captureStream(0),dummyStream=new MediaStream;return dummyStream.addTrack(dummyAudio.stream.getAudioTracks()[0]),dummyStream.addTrack(dummyVideo.getVideoTracks()[0]),dummyStream}(),callback&&callback()):callback&&callback()}))}function getTeacherroom(){return new URLSearchParams(window.location.search).get("teacher")}function restoreSessionState(sessionState){for(var peerId in sessionState.connectedPeers)if(sessionState.connectedPeers.hasOwnProperty(peerId)){var peer=sessionState.connectedPeers[peerId],peerConnection=new RTCPeerConnection({iceServers:ICE_SERVERS},{optional:[{DtlsSrtpKeyAgreement:!0}]});peers[peerId]=peerConnection,setupPeerConnection(peerConnection,peerId,peer)}}function setupPeerConnection(peerConnection,peerId,peer){for(var track of(peerConnection.onicecandidate=function(event){event.candidate&&signalingSocket.emit("relayICECandidate",{peer_id:peerId,ice_candidate:{sdpMLineIndex:event.candidate.sdpMLineIndex,candidate:event.candidate.candidate}})},peerConnection.ontrack=function(event){var remoteMedia;(peer.stream.addTrack(event.track),peerMediaElements[peerId])?remoteMedia=peerMediaElements[peerId]:((remoteMedia=$("<video>")).attr("autoplay","autoplay"),remoteMedia.attr("muted","true"),remoteMedia.attr("controls",""),peerMediaElements[peerId]=remoteMedia,"teacher"===getTeacherroom()&&($("#region-main-box").append(remoteMedia),attachMediaStream(remoteMedia[0],null)));attachMediaStream(remoteMedia[0],peer.stream)},peerConnection.addStream(localMediaStream),peer.stream.getTracks()))peerConnection.addTrack(track,peer.stream);peerConnection.createOffer((function(localDescription){peerConnection.setLocalDescription(localDescription,(function(){signalingSocket.emit("relaySessionDescription",{peer_id:peerId,session_description:localDescription})}))}))}function realtimeDetection(cmid,attemptid,mainimage,face,data){var requestData={cmid:cmid,attemptid:attemptid,mainimage:mainimage,validate:face,imgBase64:data};$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax_realtime.php",method:"POST",data:requestData,success:function(response){response&&response.errorcode?$(document).trigger("popup",response.error):response.redirect&&response.url&&(window.onbeforeunload=null,$(document).trigger("popup",response.msg),setTimeout((function(){window.location.href=encodeURI(response.url)}),3e3))}})}}));

//# sourceMappingURL=add_camera.min.js.map