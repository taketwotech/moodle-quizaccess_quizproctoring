{"version":3,"file":"report.min.js","sources":["../src/report.js"],"sourcesContent":["define(['jquery', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/str', 'core/notification'],\r\nfunction($, ModalFactory, ModalEvents, Templates, str, notification) {\r\n    return {\r\n        init: function() {\r\n            $(document).ready(function() {\r\n                if (typeof lightbox !== 'undefined') {\r\n                    lightbox.init();\r\n                }\r\n            });\r\n            $('.delete-icon').on('click', function(event) {\r\n                event.preventDefault();\r\n                var username = $(this).data('username');\r\n                var cmid = $(this).data('cmid');\r\n                var quizid = $(this).data('quizid');\r\n                var userid = $(this).data('userid');\r\n                var newUrl = M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/proctoringreport.php?delete='\r\n                + userid + '&cmid=' + cmid + '&quizid=' + quizid;\r\n                Promise.all([\r\n                    str.get_string('deleteallimagesuser', 'quizaccess_quizproctoring', username),\r\n                    str.get_string('confirmation', 'quizaccess_quizproctoring'),\r\n                    str.get_string('deleteallimages', 'quizaccess_quizproctoring'),\r\n                    str.get_string('delete', 'moodle'),\r\n                    str.get_string('cancel', 'moodle'),\r\n                ]).then(function(strings) {\r\n                    var message = strings[0];\r\n                    var title = strings[1];\r\n                    var checkboxtext = strings[2];\r\n                    var deleteLabel = strings[3];\r\n                    var cancelLabel = strings[4];\r\n                    var checkboxHtml = '<div><input type=\"checkbox\" id=\"deleteallimages\" /><label class=\"deleteall\">'\r\n                    + checkboxtext + '</label></div>';\r\n                    notification.confirm(\r\n                        title,\r\n                        message + checkboxHtml,\r\n                        deleteLabel,\r\n                        cancelLabel,\r\n                        function() {\r\n                            var allImages = $('#deleteallimages').is(':checked');\r\n                            if (allImages) {\r\n                                newUrl += '&all=true';\r\n                            }\r\n                            window.location.href = newUrl;\r\n                        },\r\n                        function() {\r\n                            // Do nothing on 'Cancel'\r\n                        }\r\n                    );\r\n                });\r\n            });\r\n\r\n            $('.delete-quiz').on('click', function(event) {\r\n                event.preventDefault();\r\n                var quizname = $(this).data('quiz');\r\n                var cmid = $(this).data('cmid');\r\n                var quizid = $(this).data('quizid');\r\n                var newUrl = M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/imagesreport.php?cmid='\r\n                + cmid + '&delete=' + quizid;\r\n                Promise.all([\r\n                    str.get_string('deleteallimagesquiz', 'quizaccess_quizproctoring', quizname),\r\n                    str.get_string('confirmation', 'quizaccess_quizproctoring'),\r\n                    str.get_string('deleteallimages', 'quizaccess_quizproctoring'),\r\n                    str.get_string('delete', 'moodle'),\r\n                    str.get_string('cancel', 'moodle'),\r\n                ]).then(function(strings) {\r\n                    var message = strings[0];\r\n                    var title = strings[1];\r\n                    var checkboxtext = strings[2];\r\n                    var deleteLabel = strings[3];\r\n                    var cancelLabel = strings[4];\r\n                    var checkboxHtml = '<div><input type=\"checkbox\" id=\"deleteallimages\" /><label class=\"deleteall\">'\r\n                    + checkboxtext + '</label></div>';\r\n                    notification.confirm(\r\n                        title,\r\n                        message + checkboxHtml,\r\n                        deleteLabel,\r\n                        cancelLabel,\r\n                        function() {\r\n                            var allImages = $('#deleteallimages').is(':checked');\r\n                            if (allImages) {\r\n                                newUrl += '&all=true';\r\n                            }\r\n                            window.location.href = newUrl;\r\n                        },\r\n                        function() {\r\n                            // Do nothing on 'Cancel'\r\n                        }\r\n                    );\r\n                });\r\n            });\r\n\r\n            $('.delcourse').on('click', function(event) {\r\n                event.preventDefault();\r\n                var coursename = $(this).data('course');\r\n                var cmid = $(this).data('cmid');\r\n                var courseid = $(this).data('courseid');\r\n                var newUrl = M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/imagesreport.php?cmid='\r\n                + cmid + '&delcourse=' + courseid;\r\n                Promise.all([\r\n                    str.get_string('deleteallimagescourse', 'quizaccess_quizproctoring', coursename),\r\n                    str.get_string('confirmation', 'quizaccess_quizproctoring'),\r\n                    str.get_string('deleteallimages', 'quizaccess_quizproctoring'),\r\n                    str.get_string('delete', 'moodle'),\r\n                    str.get_string('cancel', 'moodle'),\r\n                ]).then(function(strings) {\r\n                    var message = strings[0];\r\n                    var title = strings[1];\r\n                    var checkboxtext = strings[2];\r\n                    var deleteLabel = strings[3];\r\n                    var cancelLabel = strings[4];\r\n                    var checkboxHtml = '<div><input type=\"checkbox\" id=\"deleteallimages\" /><label class=\"deleteall\">'\r\n                    + checkboxtext + '</label></div>';\r\n                    notification.confirm(\r\n                        title,\r\n                        message + checkboxHtml,\r\n                        deleteLabel,\r\n                        cancelLabel,\r\n                        function() {\r\n                            var allImages = $('#deleteallimages').is(':checked');\r\n                            if (allImages) {\r\n                                newUrl += '&all=true';\r\n                            }\r\n                            window.location.href = newUrl;\r\n                        },\r\n                        function() {\r\n                            // Do nothing on 'Cancel'\r\n                        }\r\n                    );\r\n                });\r\n            });\r\n\r\n            $('.proctoringimage').on('click', function(event) {\r\n                event.preventDefault();\r\n                var attemptid = $(this).data('attemptid');\r\n                var quizid = $(this).data('quizid');\r\n                var userid = $(this).data('userid');\r\n                var startdate = $(this).data('startdate');\r\n                var all = $('#storeallimages').is(':checked') ? 'true' : 'false';\r\n\r\n                var modaltitle = all === 'true' ? M.util.get_string('allimages', 'quizaccess_quizproctoring') :\r\n                    M.util.get_string('proctoringimages', 'quizaccess_quizproctoring');\r\n\r\n                ModalFactory.create({\r\n                    type: ModalFactory.types.DEFAULT,\r\n                    body: '<div class=\"image-content\"><p>Loading images...</p></div><div class=\"pagination-controls\"></div>',\r\n                    title: modaltitle,\r\n                    large: true,\r\n                }).then(function(modal) {\r\n                    modal.show();\r\n\r\n                    var perpage = 50;\r\n                    var currentPage = 1;\r\n\r\n                    function loadImages(page) {\r\n                        $.ajax({\r\n                            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax_report.php',\r\n                            data: {\r\n                                attemptid: attemptid,\r\n                                userid: userid,\r\n                                quizid: quizid,\r\n                                all: all,\r\n                                page: page,\r\n                                perpage: perpage,\r\n                            },\r\n                            dataType: 'json',\r\n                            success: function(response) {\r\n                                var images = response.images.map(function(image) {\r\n                                    return {\r\n                                        url: image.img,\r\n                                        title: image.title,\r\n                                        time: image.timecreated,\r\n                                        cssClass: getCssClass(image.imagestatus)\r\n                                    };\r\n                                });\r\n\r\n                                var data = {\r\n                                    attemptdate: startdate,\r\n                                    images: images,\r\n                                    currentPage: response.currentPage,\r\n                                    totalPages: response.totalPages,\r\n                                    isFirstPage: response.currentPage === 1,\r\n                                    isLastPage: response.currentPage === response.totalPages,\r\n                                    str: function(key) { return M.util.get_string(key, 'quizaccess_quizproctoring'); }\r\n                                };\r\n\r\n                                Templates.render('quizaccess_quizproctoring/response_modal', data)\r\n                                    .done(function(renderedHtml) {\r\n                                        modal.getBody().find('.image-content').html(renderedHtml);\r\n                                        lightbox.init();\r\n\r\n                                        $('.image-link').on('click', function() {\r\n                                            var titleElement = $(this).next('.image-title');\r\n                                            var timeElement = $(this).next('.image-time');\r\n                                            titleElement.show();\r\n                                            timeElement.show();\r\n                                            lightbox.start($(this)[0]);\r\n                                        });\r\n                                        $('.image-link').on('lightbox:open', function() {\r\n                                            $(this).next('.image-title').hide();\r\n                                        });\r\n\r\n                                        modal.getBody().find('.pagination-controls').\r\n                                        html(getPaginationControls(response.currentPage, response.totalPages));\r\n                                    });\r\n                            },\r\n                            error: function(jqXHR, textStatus, errorThrown) {\r\n                                modal.getBody().find('.image-content').html('<p>Error loading images: '\r\n                                    + textStatus + '</p>');\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    function getCssClass(status) {\r\n                        switch (status.toLowerCase()) {\r\n                            case 'main image':\r\n                                return 'main-image';\r\n                            case 'warning':\r\n                                return 'warning-image';\r\n                            default:\r\n                                return 'green-image';\r\n                        }\r\n                    }\r\n\r\n                    function getPaginationControls(currentPage, totalPages) {\r\n                        var prevButton = '<button class=\"prev-page\" ' +\r\n                        (currentPage === 1 ? 'disabled' : '') + '>Previous</button>';\r\n                        var nextButton = '<button class=\"next-page\" ' +\r\n                        (currentPage === totalPages ? 'disabled' : '') + '>Next</button>';\r\n\r\n                        return '<div>' + prevButton + ' Page ' + currentPage\r\n                        + ' of ' + totalPages + ' ' + nextButton + '</div>';\r\n                    }\r\n                    \r\n                    modal.getBody().off('click', '.prev-page').on('click', '.prev-page', function() {\r\n                        if (currentPage > 1) {\r\n                            currentPage--;\r\n                            loadImages(currentPage);\r\n                        }\r\n                    });\r\n\r\n                    modal.getBody().off('click', '.next-page').on('click', '.next-page', function() {\r\n                        if (currentPage < response.totalPages) {\r\n                            currentPage++;\r\n                            loadImages(currentPage);\r\n                        }\r\n                    });\r\n                    loadImages(currentPage);\r\n                });\r\n            });\r\n            $('.proctoridentity').on('click', function(event) {\r\n                event.preventDefault();\r\n                $.ajax({\r\n                    url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/proctoridentity.php',\r\n                    data: {\r\n                        attemptid: $(this).data('attemptid'),\r\n                        userid: $(this).data('userid'),\r\n                        quizid: $(this).data('quizid')\r\n                    },\r\n                    dataType: 'json',\r\n                    success: function(response) {\r\n                        var residentity = JSON.parse(JSON.stringify(response));\r\n                        if (residentity.success) {\r\n                            window.open(residentity.url, \"_blank\");\r\n                        } else {\r\n                            return ModalFactory.create({\r\n                                type: ModalFactory.types.DEFAULT,\r\n                                body: residentity.message,\r\n                            }).then(function(modal) {\r\n                                modal.getRoot().on(ModalEvents.hidden, modal.destroy.bind(modal));\r\n                                modal.show();\r\n                                return null;\r\n                            });\r\n                        }\r\n                        return true;\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","ModalFactory","ModalEvents","Templates","str","notification","init","document","ready","lightbox","on","event","preventDefault","username","this","data","cmid","quizid","userid","newUrl","M","cfg","wwwroot","Promise","all","get_string","then","strings","message","title","checkboxtext","deleteLabel","cancelLabel","checkboxHtml","confirm","is","window","location","href","quizname","coursename","courseid","attemptid","startdate","modaltitle","util","create","type","types","DEFAULT","body","large","modal","show","currentPage","loadImages","page","ajax","url","perpage","dataType","success","response","images","map","image","img","time","timecreated","cssClass","getCssClass","imagestatus","attemptdate","totalPages","isFirstPage","isLastPage","key","render","done","renderedHtml","getBody","find","html","titleElement","next","timeElement","start","hide","getPaginationControls","error","jqXHR","textStatus","errorThrown","status","toLowerCase","off","residentity","JSON","parse","stringify","open","getRoot","hidden","destroy","bind"],"mappings":"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"}