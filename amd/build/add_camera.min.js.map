{"version":3,"file":"add_camera.min.js","sources":["../src/add_camera.js"],"sourcesContent":["/**\n * JavaScript class for Camera\n *\n * @subpackage quizproctoring\n * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nwindow.addEventListener('beforeunload', function(event) {\n    event.stopImmediatePropagation();\n    event.returnValue = '';\n});\ndefine(['jquery', 'core/str', 'core/modal_factory'],\nfunction($, str, ModalFactory) {\n    $('.quizstartbuttondiv [type=submit]').prop(\"disabled\", true);\n    var Camera = function(cmid, mainimage = false, attemptid = null, quizid) {\n        var docElement = $(document);\n        this.video = document.getElementById(this.videoid);\n        this.canvas = document.getElementById(this.canvasid);\n        this.cmid = cmid;\n        this.quizid = quizid;\n        this.mainimage = mainimage;\n        this.attemptid = attemptid;\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n        docElement.on('popup', this.showpopup.bind(this));\n    };\n\n    $('#id_consentcheckbox').on('change', function() {\n        if (!$(this).is(':checked')) {\n            $(\"#id_submitbutton\").prop(\"disabled\", true);\n        } else if ($(this).is(':checked') && $('#userimageset').val() == 0) {\n            $(\"#id_submitbutton\").prop(\"disabled\", true);\n        } else if ($(this).is(':checked') && $('#userimageset').val() == 1) {\n            $(\"#id_submitbutton\").prop(\"disabled\", false);\n        }\n    });\n\n    /** @type Tag element contain video. */\n    Camera.prototype.video = false;\n    /** @type String video elemend id. */\n    Camera.prototype.videoid = 'video';\n    /** @type Tag element contain canvas. */\n    Camera.prototype.canvas = false;\n    /** @type String video elemend id. */\n    Camera.prototype.canvasid = 'canvas';\n    /** @type int width of canvas object. */\n    Camera.prototype.width = 320;\n    /** @type int width of canvas object. */\n    Camera.prototype.height = 240;\n    /** @type String element contain takepicture button. */\n    Camera.prototype.takepictureid = 'takepicture';\n    /** @type String element contain retake button. */\n    Camera.prototype.retakeid = 'retake';\n    /** @type int course module id. */\n    Camera.prototype.cmid = false;\n    /** @type bool whether a main image or compare against an image. */\n    Camera.prototype.mainimage = false;\n     /** @type int attempt id. */\n    Camera.prototype.attemptid = false;\n     /** @type int quiz id. */\n    Camera.prototype.quizid = false;\n\n    Camera.prototype.startcamera = function() {\n        const takePictureButton = $('#' + this.takepictureid);\n        takePictureButton.prop('disabled', true);\n        return navigator.mediaDevices.getUserMedia({video: true, audio: true})\n            .then(function(stream) {\n                const videoElement = document.getElementById('video');\n                if (videoElement) {\n                    videoElement.srcObject = stream;\n                    videoElement.muted = true;\n                    videoElement.playsinline = true;\n                    localMediaStream = stream;\n                    videoElement.play();\n\n                    videoElement.addEventListener('contextmenu', function(e) {\n                        e.preventDefault();\n                    });\n\n                    stream.getVideoTracks()[0].onended = function() {\n                        takePictureButton.prop('disabled', true);\n                        $(document).trigger('popup', 'Camera or microphone is disabled. Please enable both to continue.');\n                    };\n\n                    const audioTrack = stream.getAudioTracks()[0];\n                    if (audioTrack) {\n                        audioTrack.onended = function() {\n                            $(document).trigger('popup', 'Camera or microphone is disabled. Please enable both to continue.');\n                        };\n                    } else {\n                        $(document).trigger('popup', 'Camera or microphone is disabled. Please enable both to continue.');\n                    }\n                    restoreVideoPosition(videoElement);\n                    makeDraggable(videoElement);\n                    takePictureButton.prop('disabled', false);\n                }\n                return videoElement;\n            })\n            .catch(function() {\n                takePictureButton.prop('disabled', true);\n            });\n    };\n\n    Camera.prototype.takepicture = function() {\n        var context = this.canvas.getContext('2d');\n        context.drawImage(this.video, 0, 0, this.width, this.height);\n        var data = this.canvas.toDataURL('image/png');\n        $('#' + this.videoid).hide();\n        $('#' + this.takepictureid).hide();\n        $('#' + this.canvasid).show();\n        $('#' + this.retakeid).show();\n        $('#userimageset').val(1);\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n        $.ajax({\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n            method: 'POST',\n            data: {imgBase64: data, cmid: this.cmid, attemptid: this.attemptid, mainimage: this.mainimage},\n            success: function(response) {\n                if (response && response.errorcode) {\n                    $('#userimageset').val(0);\n                    $(document).trigger('popup', response.error);\n                } else {\n                    if ($('#id_consentcheckbox').is(':checked')) {\n                        $(\"#id_submitbutton\").prop(\"disabled\", false);\n                    }\n                }\n            }\n        });\n    };\n    Camera.prototype.proctoringimage = function() {\n        var requestData = {\n            cmid: this.cmid,\n            attemptid: this.attemptid,\n            mainimage: this.mainimage\n        };\n        if (this.canvas) {\n            var context = this.canvas.getContext('2d');\n            context.drawImage(this.video, 0, 0, this.width, this.height);\n            var data = this.canvas.toDataURL('image/png');\n            requestData.imgBase64 = data;\n        }\n        $.ajax({\n            url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n            method: 'POST',\n            data: requestData,\n            success: function(response) {\n                if (response && response.errorcode) {\n                    var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                    var leftwarnings = Math.max(warningsl - 1, 0);\n                    localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                    $(document).trigger('popup', response.error);\n                } else {\n                    if (response.redirect && response.url) {\n                        window.onbeforeunload = null;\n                        $(document).trigger('popup', response.msg);\n                        setTimeout(function() {\n                            window.location.href = encodeURI(response.url);\n                        }, 3000);\n                    }\n                }\n            }\n        });\n    };\n\n    Camera.prototype.resetcamera = function() {\n        var context = this.canvas.getContext('2d');\n        context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n        $('#' + this.canvasid).hide();\n        $('#' + this.retakeid).hide();\n        $('#' + this.videoid).show();\n        $('#' + this.takepictureid).show();\n        $('#userimageset').val(0);\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n    };\n\n    var externalserver = 'https://stream.proctorlink.com/';\n    var localMediaStream = null;\n    var USE_AUDIO = true;\n    var USE_VIDEO = true;\n\n    Camera.prototype.retake = function() {\n        $('#userimageset').val(0);\n        $('#' + this.videoid).show(this.cmid);\n        $('#' + this.takepictureid).show();\n        $('#' + this.canvasid).hide();\n        $('#' + this.retakeid).hide();\n        $(\"#id_submitbutton\").prop(\"disabled\", true);\n    };\n    Camera.prototype.showpopup = function(event, message) {\n        if (this.activeModal) {\n            this.activeModal.hide();\n            this.activeModal.destroy();\n        }\n        return ModalFactory.create({\n            body: message,\n        }).then((modal) => {\n            this.activeModal = modal;\n            modal.show();\n            return null;\n        }).catch(() => {\n            showCustomModal(message);\n        });\n    };\n\n    Camera.prototype.stopcamera = function() {\n        if (localMediaStream) {\n            localMediaStream.getTracks().forEach(function(track) {\n                track.stop();\n            });\n            localMediaStream = null;\n        }\n    };\n\n    var init = function(cmid, mainimage, verifyduringattempt = true, attemptid = null,\n        teacher, quizid, enableeyecheckreal, studenthexstring,\n        onlinestudent = 0, securewindow = null, userfullname,\n        enablestudentvideo = 1, setinterval = 300,\n        warnings = 0) {\n        if (!verifyduringattempt) {\n            var camera;\n            if (document.readyState === 'complete') {\n                $('.quizstartbuttondiv [type=submit]').prop(\"disabled\", false);\n            } else {\n                $(window).on('load', function() {\n                    $('.quizstartbuttondiv [type=submit]').prop(\"disabled\", false);\n                });\n            }\n            camera = new Camera(cmid, mainimage, attemptid, quizid);\n            $('.quizstartbuttondiv [type=submit]').on('click', function() {\n                localStorage.removeItem('videoPosition');\n                camera.startcamera();\n            });\n            // Take picture on button click\n            $('#' + camera.takepictureid).on('click', function(e) {\n                e.preventDefault();\n                camera.takepicture();\n            });\n            // Show video again when retake\n            $('#' + camera.retakeid).on('click', function(e) {\n                e.preventDefault();\n                camera.retake();\n            });\n            $('#id_cancel').on('click', function() {\n                camera.stopcamera();\n                camera.resetcamera();\n                $(\"#id_submitbutton\").prop(\"disabled\", true);\n                localStorage.removeItem('videoPosition');\n            });\n            $(document).on('click', '.closebutton', function() {\n                if (typeof camera !== 'undefined' && typeof camera.stopcamera === 'function') {\n                    camera.stopcamera();\n                    camera.resetcamera();\n                    $(\"#id_submitbutton\").prop(\"disabled\", true);\n                    localStorage.removeItem('videoPosition');\n                }\n            });\n            document.addEventListener('keydown', function(event) {\n                if (event.key === 'Escape') {\n                    camera.stopcamera();\n                    camera.resetcamera();\n                    $(\"#id_submitbutton\").prop(\"disabled\", true);\n                    localStorage.removeItem('videoPosition');\n                }\n            });\n            if (securewindow === 'securewindow') {\n                const currentUrl = window.location.href;\n                if (currentUrl.includes('startattempt.php')) {\n                    camera.startcamera();\n                }\n            }\n        } else {\n            localStorage.setItem('warningThreshold', JSON.stringify(warnings));\n            document.addEventListener('keydown', function(event) {\n                if ((event.ctrlKey || event.metaKey) && (event.key === 'c' || event.key === 'v')) {\n                    event.preventDefault();\n                }\n            });\n            document.addEventListener('dragstart', function(event) {\n                event.preventDefault();\n            });\n\n            document.addEventListener('drop', function(event) {\n                event.preventDefault();\n            });\n\n            document.addEventListener('contextmenu', function(event) {\n                event.preventDefault();\n            });\n            if (enableeyecheckreal) {\n                const waitForElements = setInterval(() => {\n                    const vElement = document.getElementById('video');\n                    const cElement = document.getElementById('canvas');\n\n                    if (vElement && cElement) {\n                        clearInterval(waitForElements);\n                        if (typeof setupFaceMesh !== 'undefined') {\n                            // eslint-disable-next-line no-undef\n                            setupFaceMesh(vElement, cElement, function(result) {\n                                if (result.status) {\n                                    realtimeDetection(cmid, attemptid, mainimage,\n                                        result.status, result.data);\n                                }\n                            });\n                        }\n                    }\n                }, 500);\n            }\n            if (onlinestudent) {\n                // Add iframe for student view\n                const iframeContainer = $(\"<div>\").addClass(\"student-iframe-container\");\n                const baseUrl = `${externalserver}/student`;\n                const params = new URLSearchParams({\n                    id: studenthexstring + Math.floor(Math.random() * 10) + 1,\n                    name: userfullname + Math.floor(Math.random() * 100000) + 1,\n                    examId: quizid\n                });\n                const iframeUrl = `${baseUrl}?${params.toString()}`;\n                const iframe = $(\"<iframe>\")\n                    .attr({\n                        'src': iframeUrl,\n                        'width': '100%',\n                        'height': '480',\n                        'frameborder': '0',\n                        'allow': 'camera; microphone',\n                        'style': 'position: fixed; bottom: 20px; right: 20px; z-index: 9999; ' +\n                                'width: 320px; height: 240px; border-radius: 8px; ' +\n                                'box-shadow: 0 2px 10px rgba(0,0,0,0.2);'\n                    })\n                    .on('load', function() {\n                        console.log('Iframe loaded, sending initial message');\n                        // Send initial message to establish connection\n                        try {\n                            iframe[0].contentWindow.postMessage({ \n                                type: 'init',\n                                timestamp: Date.now()\n                            }, externalserver);\n                        } catch (error) {\n                            console.error('Error sending initial message:', error);\n                        }\n                    });\n                iframeContainer.append(iframe);\n                $('body').append(iframeContainer);\n\n                // Make iframe draggable\n                makeDraggable(iframeContainer[0]);\n\n                if (verifyduringattempt) {\n                    // Add canvas for proctoring\n                    $('<canvas>').attr({\n                        id: 'canvas',\n                        width: '280',\n                        height: '240',\n                        'style': 'display: none;'\n                    }).appendTo('body');\n\n                    // Handle visibility change\n                    document.addEventListener('visibilitychange', function() {\n                        if (document.visibilityState === 'visible') {\n                            var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                            var leftwarnings = Math.max(warningsl - 1, 0);\n                            localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                            var message = \"Do not move away from active tab.\";\n                            if (leftwarnings === 1) {\n                                message = `Do not move away from active tab. You have only ${leftwarnings} warning left.`;\n                            } else if (leftwarnings > 1) {\n                                message = `Do not move away from active tab. You have only ${leftwarnings} warnings left.`;\n                            }\n                            $(document).trigger('popup', message);\n                            \n                            // Send tab switch event to server\n                            $.ajax({\n                                url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n                                method: 'POST',\n                                data: {\n                                    cmid: cmid,\n                                    attemptid: attemptid,\n                                    mainimage: mainimage,\n                                    tab: true\n                                },\n                                success: function(response) {\n                                    if (response.redirect && response.url) {\n                                        window.onbeforeunload = null;\n                                        $(document).trigger('popup', response.msg);\n                                        setTimeout(function() {\n                                            window.location.href = encodeURI(response.url);\n                                        }, 3000);\n                                    }\n                                }\n                            });\n                        }\n                    });\n\n                    // Initialize camera and start proctoring\n                    var camera = new Camera(cmid, mainimage, attemptid, quizid);\n                    let iframeReady = false;\n\n                    // Add message listener for iframe communication\n                    window.addEventListener('message', function(event) {\n                        console.log('Received message:', {\n                            origin: event.origin,\n                            expectedOrigin: externalserver,\n                            data: event.data\n                        });\n                        \n                        if (event.origin === externalserver) {\n                            const data = event.data;\n                            if (data.type === 'ready') {\n                                console.log('Iframe is ready for communication');\n                                iframeReady = true;\n                            } else if (data.type === 'proctoring_image') {\n                                console.log('Received proctoring image from iframe');\n                                // Process the image from iframe\n                                var context = camera.canvas.getContext('2d');\n                                var img = new Image();\n                                img.onload = function() {\n                                    context.drawImage(img, 0, 0, camera.width, camera.height);\n                                    var imageData = camera.canvas.toDataURL('image/png');\n                                    $.ajax({\n                                        url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n                                        method: 'POST',\n                                        data: {\n                                            imgBase64: imageData,\n                                            cmid: camera.cmid,\n                                            attemptid: camera.attemptid,\n                                            mainimage: camera.mainimage\n                                        },\n                                        success: function(response) {\n                                            if (response && response.errorcode) {\n                                                var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                                                var leftwarnings = Math.max(warningsl - 1, 0);\n                                                localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                                                $(document).trigger('popup', response.error);\n                                            } else if (response.redirect && response.url) {\n                                                window.onbeforeunload = null;\n                                                $(document).trigger('popup', response.msg);\n                                                setTimeout(function() {\n                                                    window.location.href = encodeURI(response.url);\n                                                }, 3000);\n                                            }\n                                        }\n                                    });\n                                };\n                                img.src = data.imageData;\n                            }\n                        } else {\n                            console.log('Message origin mismatch:', {\n                                received: event.origin,\n                                expected: externalserver\n                            });\n                        }\n                    });\n\n                    // Start sending messages only after iframe is ready\n                    setInterval(function() {\n                        if (iframeReady) {\n                            console.log('Sending get_proctoring_image message to iframe');\n                            try {\n                                iframe[0].contentWindow.postMessage({ \n                                    type: 'get_proctoring_image',\n                                    timestamp: Date.now()\n                                }, externalserver);\n                            } catch (error) {\n                                console.error('Error sending message to iframe:', error);\n                                iframeReady = false; // Reset ready state on error\n                            }\n                        } else {\n                            console.log('Iframe not ready, sending init message');\n                            try {\n                                iframe[0].contentWindow.postMessage({ \n                                    type: 'init',\n                                    timestamp: Date.now()\n                                }, externalserver);\n                            } catch (error) {\n                                console.error('Error sending init message:', error);\n                            }\n                        }\n                    }, setinterval * 1000);\n                }\n            } else {\n                setupLocalMedia(cmid, mainimage, verifyduringattempt, attemptid,\n                    teacher, enablestudentvideo, setinterval,\n                    quizid);\n            }\n        }\n    };\n\n    return {\n        init: init\n    };\n\n    /**\n     * Setup Local Media\n     *\n     * @param {int} cmid - cmid\n     * @param {boolean} mainimage - boolean value\n     * @param {boolean} verifyduringattempt - boolean value\n     * @param {int} attemptid - Attempt Id\n     * @param {boolean} teacher - boolean value\n     * @param {boolean} enablestudentvideo - boolean value\n     * @param {bigint} setinterval - int value\n     * @param {int} quizid - int value\n     * @param {function} callback - The callback function to execute after setting up the media stream.\n     * @return {void}\n     */\n    function setupLocalMedia(cmid, mainimage, verifyduringattempt, attemptid,\n        teacher, enablestudentvideo,\n        setinterval, quizid, callback) {\n        require(['core/ajax'], function() {\n            if (localMediaStream !== null) {\n                if (callback) {\n                    callback();\n                }\n                return;\n            }\n            var teacherroom = getTeacherroom();\n            if (teacherroom !== 'teacher') {\n                navigator.getUserMedia = (\n                    navigator.getUserMedia ||\n                    navigator.webkitGetUserMedia ||\n                    navigator.mozGetUserMedia ||\n                    navigator.msGetUserMedia\n                );\n\n                attachMediaStream = function(element, stream) {\n                    element.srcObject = stream;\n                };\n\n                navigator.mediaDevices.getUserMedia({\"audio\": USE_AUDIO, \"video\": USE_VIDEO})\n                .then(function(stream) {\n                    localMediaStream = stream;\n                    if (verifyduringattempt) {\n                        $('<canvas>').attr({id: 'canvas', width: '280',\n                            height: '240', 'style': 'display: none;'}).appendTo('body');\n                        $('<video>').attr({\n                            'id': 'video',\n                            'class': 'quizaccess_quizproctoring-video',\n                            'width': '280',\n                            'height': '240',\n                            'autoplay': 'autoplay'\n                        }).css('display', enablestudentvideo ? 'block' : 'none')\n                          .appendTo('body');\n                        document.addEventListener('visibilitychange', function() {\n                            if (document.visibilityState === 'visible') {\n                                var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                                var leftwarnings = Math.max(warningsl - 1, 0);\n                                localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                                var message = \"Do not move away from active tab.\";\n                                if (leftwarnings === 1) {\n                                    message = `Do not move away from active tab. You have only ${leftwarnings} warning left.`;\n                                } else if (leftwarnings > 1) {\n                                    message = `Do not move away from active tab. You have only ${leftwarnings} warnings left.`;\n                                }\n                                $(document).trigger('popup', message);\n                                $.ajax({\n                                url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax.php',\n                                method: 'POST',\n                                data: {cmid: cmid, attemptid: attemptid, mainimage: mainimage, tab: true},\n                                    success: function(response) {\n                                        if (response.redirect && response.url) {\n                                            window.onbeforeunload = null;\n                                            $(document).trigger('popup', response.msg);\n                                            setTimeout(function() {\n                                                window.location.href = encodeURI(response.url);\n                                            }, 3000);\n                                        }\n                                    }\n                                });\n                            }\n                        });\n                        var camera = new Camera(cmid, mainimage, attemptid, quizid);\n                        camera.startcamera();\n                        setInterval(camera.proctoringimage.bind(camera), setinterval * 1000);\n                    }\n                    return stream;\n                })\n                .catch(function(error) {\n                    // Handle the case where permission is denied\n                    if (verifyduringattempt) {\n                        var teacherroom = getTeacherroom();\n                        if (teacherroom !== 'teacher') {\n                            var camera = new Camera(cmid, mainimage, attemptid, quizid);\n                            camera.startcamera();\n                            setInterval(camera.proctoringimage.bind(camera), setinterval * 1000);\n                        }\n                    }\n                    throw error;\n                })\n                .finally(function() {\n                    if (callback) {\n                        callback();\n                    }\n                });\n            } else {\n                localMediaStream = createDummyMediaStream();\n                if (callback) {\n                    callback();\n                }\n            }\n        });\n    }\n\n    /**\n     * Create Dummy Media Stream\n     *\n     * @return {string} dummyStream\n     */\n     function createDummyMediaStream() {\n        const audioContext = new AudioContext();\n        const dummyAudio = audioContext.createMediaStreamDestination();\n        const dummyVideo = document.createElement('canvas').captureStream(0);\n\n        // Combine audio and video into a dummy MediaStream\n        const dummyStream = new MediaStream();\n        dummyStream.addTrack(dummyAudio.stream.getAudioTracks()[0]);\n        dummyStream.addTrack(dummyVideo.getVideoTracks()[0]);\n        return dummyStream;\n    }\n\n    /**\n     * Get Teacher room\n     *\n     * @return {string} teacher\n     */\n    function getTeacherroom() {\n        var urlParams = new URLSearchParams(window.location.search);\n        var teacher = urlParams.get('teacher');\n        return teacher;\n    }\n\n/**\n * RestoreVideoPosition\n *\n * @param {HTMLElement} element - The video element whose position should be restored.\n * @return {void}\n */\nfunction restoreVideoPosition(element) {\n    const savedPosition = localStorage.getItem('videoPosition');\n    if (savedPosition) {\n        const {left, top} = JSON.parse(savedPosition);\n        element.style.left = `${left}px`;\n        element.style.top = `${top}px`;\n    }\n}\n\n/**\n * DraggableVideoPosition\n *\n * @param {HTMLElement} element - The video element\n * @return {void}\n */\nfunction makeDraggable(element) {\n    let offsetX = 0;\n    let offsetY = 0;\n    let isDragging = false;\n    element.addEventListener('mousedown', function(e) {\n        isDragging = true;\n        offsetX = e.clientX - element.getBoundingClientRect().left;\n        offsetY = e.clientY - element.getBoundingClientRect().top;\n        element.style.cursor = 'grabbing';\n    });\n    document.addEventListener('mousemove', function(e) {\n    if (!isDragging) {\n        return;\n    }\n         requestAnimationFrame(() => {\n            let newLeft = e.clientX - offsetX;\n            let newTop = e.clientY - offsetY;\n            const maxLeft = window.innerWidth - element.offsetWidth;\n            const maxTop = window.innerHeight - element.offsetHeight;\n            newLeft = Math.max(0, Math.min(newLeft, maxLeft));\n            newTop = Math.max(0, Math.min(newTop, maxTop));\n            if (element.style.position !== 'fixed') {\n                element.style.position = 'fixed';\n            }\n             element.style.left = `${newLeft}px`;\n            element.style.top = `${newTop}px`;\n        });\n    });\n    document.addEventListener('mouseup', function() {\n        if (isDragging) {\n            isDragging = false;\n            element.style.cursor = 'grab';\n            localStorage.setItem('videoPosition', JSON.stringify({\n                left: parseInt(element.style.left, 10),\n                top: parseInt(element.style.top, 10)\n            }));\n        }\n    });\n}\n\n/**\n * RealtimeDetectionAjaxCall\n *\n * @param {int} cmid - cmid\n * @param {int} attemptid - Attempt Id\n * @param {boolean} mainimage - boolean value\n * @param {string} face string value\n * @param {Longtext} data video\n * @return {void}\n */\nfunction realtimeDetection(cmid, attemptid, mainimage, face, data) {\n    var requestData = {\n        cmid: cmid,\n        attemptid: attemptid,\n        mainimage: mainimage,\n        validate: face,\n        imgBase64: data,\n    };\n    $.ajax({\n        url: M.cfg.wwwroot + '/mod/quiz/accessrule/quizproctoring/ajax_realtime.php',\n        method: 'POST',\n        data: requestData,\n        success: function(response) {\n            if (response && response.errorcode) {\n                var warningsl = JSON.parse(localStorage.getItem('warningThreshold')) || 0;\n                var leftwarnings = Math.max(warningsl - 1, 0);\n                localStorage.setItem('warningThreshold', JSON.stringify(leftwarnings));\n                $(document).trigger('popup', response.error);\n            } else {\n                if (response.redirect && response.url) {\n                    window.onbeforeunload = null;\n                    $(document).trigger('popup', response.msg);\n                    setTimeout(function() {\n                        window.location.href = encodeURI(response.url);\n                    }, 3000);\n                }\n            }\n        }\n    });\n}\n/**\n * Setup show Custom Modal\n *\n * @param {Longtext} message - string value\n * @return {void}\n */\nfunction showCustomModal(message) {\n    $('.custom-modal').remove();\n    const modalHtml = `\n        <div class=\"custom-modal show\" role=\"dialog\" aria-modal=\"true\" tabindex=\"-1\">\n            <div class=\"custom-modal-dialog modal-dialog-scrollable\">\n                <div class=\"custom-modal-content\">\n                    <div class=\"custom-modal-header\">\n                        <h5 class=\"custom-modal-title\"></h5>\n                        <button type=\"button\" class=\"custom-close-btn\" aria-label=\"Close\">&times;</button>\n                    </div>\n                    <div class=\"custom-modal-body\">\n                        ${message}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n    $('body').append(modalHtml);\n    $('.custom-modal').fadeIn();\n    $('.custom-close-btn').click(function() {\n        closeCustomModal();\n    });\n    $(document).on('click', function(e) {\n        const $modalContent = $('.custom-modal-content');\n        if (!$modalContent.is(e.target) && $modalContent.has(e.target).length === 0) {\n            closeCustomModal();\n        }\n    });\n    $(document).on('keydown', function(e) {\n        if (e.key === 'Escape') {\n            closeCustomModal();\n        }\n    });\n}\n\n/**\n * Setup close Custom Modal\n *\n * @return {void}\n */\nfunction closeCustomModal() {\n    $('.custom-modal').fadeOut(function() {\n        $(this).remove();\n    });\n    $(document).off('click');\n    $(document).off('keydown');\n}\n});\n"],"names":["window","addEventListener","event","stopImmediatePropagation","returnValue","define","$","str","ModalFactory","prop","Camera","cmid","mainimage","arguments","length","undefined","attemptid","quizid","docElement","document","this","video","getElementById","videoid","canvas","canvasid","on","showpopup","bind","is","val","prototype","width","height","takepictureid","retakeid","startcamera","takePictureButton","navigator","mediaDevices","getUserMedia","audio","then","stream","videoElement","srcObject","muted","playsinline","localMediaStream","play","e","preventDefault","getVideoTracks","onended","trigger","audioTrack","getAudioTracks","element","savedPosition","localStorage","getItem","left","top","JSON","parse","style","restoreVideoPosition","makeDraggable","catch","takepicture","getContext","drawImage","data","toDataURL","hide","show","ajax","url","M","cfg","wwwroot","method","imgBase64","success","response","errorcode","error","proctoringimage","requestData","warningsl","leftwarnings","Math","max","setItem","stringify","redirect","onbeforeunload","msg","setTimeout","location","href","encodeURI","resetcamera","clearRect","externalserver","retake","message","activeModal","destroy","create","body","modal","remove","modalHtml","append","fadeIn","click","closeCustomModal","$modalContent","target","has","key","showCustomModal","stopcamera","getTracks","forEach","track","stop","init","verifyduringattempt","enableeyecheckreal","studenthexstring","onlinestudent","securewindow","userfullname","enablestudentvideo","setinterval","warnings","ctrlKey","metaKey","waitForElements","setInterval","vElement","cElement","clearInterval","setupFaceMesh","result","status","face","validate","realtimeDetection","iframeContainer","addClass","iframeUrl","URLSearchParams","id","floor","random","name","examId","toString","iframe","attr","src","frameborder","allow","console","log","contentWindow","postMessage","type","timestamp","Date","now","appendTo","visibilityState","tab","camera","iframeReady","origin","expectedOrigin","context","img","Image","onload","imageData","received","expected","teacher","callback","require","getTeacherroom","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","attachMediaStream","class","autoplay","css","finally","dummyAudio","AudioContext","createMediaStreamDestination","dummyVideo","createElement","captureStream","dummyStream","MediaStream","addTrack","createDummyMediaStream","setupLocalMedia","readyState","removeItem","includes","search","get","offsetX","offsetY","isDragging","clientX","getBoundingClientRect","clientY","cursor","requestAnimationFrame","newLeft","newTop","maxLeft","innerWidth","offsetWidth","maxTop","innerHeight","offsetHeight","min","position","parseInt","fadeOut","off"],"mappings":";;;;;;;AAOAA,OAAOC,iBAAiB,gBAAgB,SAASC,OAC7CA,MAAMC,2BACND,MAAME,YAAc,EACxB,IACAC,OAAO,uCAAA,CAAC,SAAU,WAAY,uBAC9B,SAASC,EAAGC,IAAKC,cACbF,EAAE,qCAAqCG,KAAK,YAAY,GACxD,IAAIC,OAAS,SAASC,MAAmD,IAA7CC,UAASC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,IAAAA,UAAA,GAAUG,UAASH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,KAAMI,OAAMJ,UAAAC,OAAAD,EAAAA,kBAAAE,EACnE,IAAIG,WAAaZ,EAAEa,UACnBC,KAAKC,MAAQF,SAASG,eAAeF,KAAKG,SAC1CH,KAAKI,OAASL,SAASG,eAAeF,KAAKK,UAC3CL,KAAKT,KAAOA,KACZS,KAAKH,OAASA,OACdG,KAAKR,UAAYA,UACjBQ,KAAKJ,UAAYA,UACjBV,EAAE,oBAAoBG,KAAK,YAAY,GACvCS,WAAWQ,GAAG,QAASN,KAAKO,UAAUC,KAAKR,QAG/Cd,EAAE,uBAAuBoB,GAAG,UAAU,WAC7BpB,EAAEc,MAAMS,GAAG,YAELvB,EAAEc,MAAMS,GAAG,aAA2C,GAA5BvB,EAAE,iBAAiBwB,MACpDxB,EAAE,oBAAoBG,KAAK,YAAY,GAChCH,EAAEc,MAAMS,GAAG,aAA2C,GAA5BvB,EAAE,iBAAiBwB,OACpDxB,EAAE,oBAAoBG,KAAK,YAAY,GAJvCH,EAAE,oBAAoBG,KAAK,YAAY,EAM/C,IAGAC,OAAOqB,UAAUV,OAAQ,EAEzBX,OAAOqB,UAAUR,QAAU,QAE3Bb,OAAOqB,UAAUP,QAAS,EAE1Bd,OAAOqB,UAAUN,SAAW,SAE5Bf,OAAOqB,UAAUC,MAAQ,IAEzBtB,OAAOqB,UAAUE,OAAS,IAE1BvB,OAAOqB,UAAUG,cAAgB,cAEjCxB,OAAOqB,UAAUI,SAAW,SAE5BzB,OAAOqB,UAAUpB,MAAO,EAExBD,OAAOqB,UAAUnB,WAAY,EAE7BF,OAAOqB,UAAUf,WAAY,EAE7BN,OAAOqB,UAAUd,QAAS,EAE1BP,OAAOqB,UAAUK,YAAc,WAC3B,MAAMC,kBAAoB/B,EAAE,IAAMc,KAAKc,eAEvC,OADAG,kBAAkB5B,KAAK,YAAY,GAC5B6B,UAAUC,aAAaC,aAAa,CAACnB,OAAO,EAAMoB,OAAO,IAC3DC,MAAK,SAASC,QACX,MAAMC,aAAezB,SAASG,eAAe,SAC7C,GAAIsB,aAAc,CACdA,aAAaC,UAAYF,OACzBC,aAAaE,OAAQ,EACrBF,aAAaG,aAAc,EAC3BC,iBAAmBL,OACnBC,aAAaK,OAEbL,aAAa3C,iBAAiB,eAAe,SAASiD,GAClDA,EAAEC,gBACN,IAEAR,OAAOS,iBAAiB,GAAGC,QAAU,WACjChB,kBAAkB5B,KAAK,YAAY,GACnCH,EAAEa,UAAUmC,QAAQ,QAAS,sEAGjC,MAAMC,WAAaZ,OAAOa,iBAAiB,GACvCD,WACAA,WAAWF,QAAU,WACjB/C,EAAEa,UAAUmC,QAAQ,QAAS,sEAGjChD,EAAEa,UAAUmC,QAAQ,QAAS,qEAiiBrD,SAA8BG,SAC1B,MAAMC,cAAgBC,aAAaC,QAAQ,iBAC3C,GAAIF,cAAe,CACf,MAAMG,KAACA,KAAIC,IAAEA,KAAOC,KAAKC,MAAMN,eAC/BD,QAAQQ,MAAMJ,KAAO,GAAGA,SACxBJ,QAAQQ,MAAMH,IAAM,GAAGA,OAC3B,CACJ,CAtiBoBI,CAAqBtB,cACrBuB,cAAcvB,cACdP,kBAAkB5B,KAAK,YAAY,EACvC,CACA,OAAOmC,YACX,IACCwB,OAAM,WACH/B,kBAAkB5B,KAAK,YAAY,EACvC,KAGRC,OAAOqB,UAAUsC,YAAc,WACbjD,KAAKI,OAAO8C,WAAW,MAC7BC,UAAUnD,KAAKC,MAAO,EAAG,EAAGD,KAAKY,MAAOZ,KAAKa,QACrD,IAAIuC,KAAOpD,KAAKI,OAAOiD,UAAU,aACjCnE,EAAE,IAAMc,KAAKG,SAASmD,OACtBpE,EAAE,IAAMc,KAAKc,eAAewC,OAC5BpE,EAAE,IAAMc,KAAKK,UAAUkD,OACvBrE,EAAE,IAAMc,KAAKe,UAAUwC,OACvBrE,EAAE,iBAAiBwB,IAAI,GACvBxB,EAAE,oBAAoBG,KAAK,YAAY,GACvCH,EAAEsE,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,+CACrBC,OAAQ,OACRT,KAAM,CAACU,UAAWV,KAAM7D,KAAMS,KAAKT,KAAMK,UAAWI,KAAKJ,UAAWJ,UAAWQ,KAAKR,WACpFuE,QAAS,SAASC,UACVA,UAAYA,SAASC,WACrB/E,EAAE,iBAAiBwB,IAAI,GACvBxB,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASE,QAElChF,EAAE,uBAAuBuB,GAAG,aAC5BvB,EAAE,oBAAoBG,KAAK,YAAY,EAGnD,KAGRC,OAAOqB,UAAUwD,gBAAkB,WAC/B,IAAIC,YAAc,CACd7E,KAAMS,KAAKT,KACXK,UAAWI,KAAKJ,UAChBJ,UAAWQ,KAAKR,WAEpB,GAAIQ,KAAKI,OAAQ,CACCJ,KAAKI,OAAO8C,WAAW,MAC7BC,UAAUnD,KAAKC,MAAO,EAAG,EAAGD,KAAKY,MAAOZ,KAAKa,QACrD,IAAIuC,KAAOpD,KAAKI,OAAOiD,UAAU,aACjCe,YAAYN,UAAYV,IAC5B,CACAlE,EAAEsE,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,+CACrBC,OAAQ,OACRT,KAAMgB,YACNL,QAAS,SAASC,UACd,GAAIA,UAAYA,SAASC,UAAW,CAChC,IAAII,UAAY1B,KAAKC,MAAML,aAAaC,QAAQ,sBAAwB,EACpE8B,aAAeC,KAAKC,IAAIH,UAAY,EAAG,GAC3C9B,aAAakC,QAAQ,mBAAoB9B,KAAK+B,UAAUJ,eACxDpF,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASE,MAC1C,MACQF,SAASW,UAAYX,SAASP,MAC9B7E,OAAOgG,eAAiB,KACxB1F,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASa,KACtCC,YAAW,WACPlG,OAAOmG,SAASC,KAAOC,UAAUjB,SAASP,IAC7C,GAAE,KAGf,KAIRnE,OAAOqB,UAAUuE,YAAc,WACblF,KAAKI,OAAO8C,WAAW,MAC7BiC,UAAU,EAAG,EAAGnF,KAAKI,OAAOQ,MAAOZ,KAAKI,OAAOS,QACvD3B,EAAE,IAAMc,KAAKK,UAAUiD,OACvBpE,EAAE,IAAMc,KAAKe,UAAUuC,OACvBpE,EAAE,IAAMc,KAAKG,SAASoD,OACtBrE,EAAE,IAAMc,KAAKc,eAAeyC,OAC5BrE,EAAE,iBAAiBwB,IAAI,GACvBxB,EAAE,oBAAoBG,KAAK,YAAY,IAG3C,IAAI+F,eAAiB,kCACjBxD,iBAAmB,KAIvBtC,OAAOqB,UAAU0E,OAAS,WACtBnG,EAAE,iBAAiBwB,IAAI,GACvBxB,EAAE,IAAMc,KAAKG,SAASoD,KAAKvD,KAAKT,MAChCL,EAAE,IAAMc,KAAKc,eAAeyC,OAC5BrE,EAAE,IAAMc,KAAKK,UAAUiD,OACvBpE,EAAE,IAAMc,KAAKe,UAAUuC,OACvBpE,EAAE,oBAAoBG,KAAK,YAAY,IAE3CC,OAAOqB,UAAUJ,UAAY,SAASzB,MAAOwG,SAKzC,OAJItF,KAAKuF,cACLvF,KAAKuF,YAAYjC,OACjBtD,KAAKuF,YAAYC,WAEdpG,aAAaqG,OAAO,CACvBC,KAAMJ,UACPhE,MAAMqE,QACL3F,KAAKuF,YAAcI,MACnBA,MAAMpC,OACC,QACRP,OAAM,MAyhBjB,SAAyBsC,SACrBpG,EAAE,iBAAiB0G,SACnB,MAAMC,UAAY,iiBASIP,wGAMtBpG,EAAE,QAAQ4G,OAAOD,WACjB3G,EAAE,iBAAiB6G,SACnB7G,EAAE,qBAAqB8G,OAAM,WACzBC,kBACJ,IACA/G,EAAEa,UAAUO,GAAG,SAAS,SAASwB,GAC7B,MAAMoE,cAAgBhH,EAAE,yBACnBgH,cAAczF,GAAGqB,EAAEqE,SAAkD,IAAvCD,cAAcE,IAAItE,EAAEqE,QAAQzG,QAC3DuG,kBAER,IACA/G,EAAEa,UAAUO,GAAG,WAAW,SAASwB,GACjB,WAAVA,EAAEuE,KACFJ,kBAER,GACJ,CAzjBYK,CAAgBhB,QAAQ,KAIhChG,OAAOqB,UAAU4F,WAAa,WACtB3E,mBACAA,iBAAiB4E,YAAYC,SAAQ,SAASC,OAC1CA,MAAMC,MACV,IACA/E,iBAAmB,OAqR3B,MAAO,CACHgF,KAlRO,SAASrH,KAAMC,WAIR,IAJmBqH,sBAAmBpH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,KAAAA,UAAA,GAASG,UAASH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,KAChEI,OAAMJ,UAAAC,OAAAD,EAAAA,kBAAAE,EAAEmH,mBAAkBrH,UAAAC,OAAAD,EAAAA,kBAAAE,EAAEoH,iBAAgBtH,UAAAC,OAAAD,EAAAA,kBAAAE,EACrDqH,cAAavH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,EAAGwH,aAAYxH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,KAAMyH,aAAYzH,UAAAC,OAAAD,GAAAA,mBAAAE,EACpDwH,mBAAkB1H,UAAAC,OAAA,SAAAC,IAAAF,UAAA,IAAAA,UAAA,IAAG,EAAG2H,YAAW3H,UAAAC,OAAA,SAAAC,IAAAF,UAAA,IAAAA,UAAA,IAAG,IACtC4H,SAAQ5H,UAAAC,OAAA,SAAAC,IAAAF,UAAA,IAAAA,UAAA,IAAG,EACX,GAAKoH,oBAoDE,CAkBH,GAjBAtE,aAAakC,QAAQ,mBAAoB9B,KAAK+B,UAAU2C,WACxDtH,SAASlB,iBAAiB,WAAW,SAASC,QACrCA,MAAMwI,UAAWxI,MAAMyI,SAA2B,MAAdzI,MAAMuH,KAA6B,MAAdvH,MAAMuH,KAChEvH,MAAMiD,gBAEd,IACAhC,SAASlB,iBAAiB,aAAa,SAASC,OAC5CA,MAAMiD,gBACV,IAEAhC,SAASlB,iBAAiB,QAAQ,SAASC,OACvCA,MAAMiD,gBACV,IAEAhC,SAASlB,iBAAiB,eAAe,SAASC,OAC9CA,MAAMiD,gBACV,IACI+E,mBAAoB,CACpB,MAAMU,gBAAkBC,aAAY,KAChC,MAAMC,SAAW3H,SAASG,eAAe,SACnCyH,SAAW5H,SAASG,eAAe,UAErCwH,UAAYC,WACZC,cAAcJ,iBACe,oBAAlBK,eAEPA,cAAcH,SAAUC,UAAU,SAASG,QACnCA,OAAOC,QAkZ3C,SAA2BxI,KAAMK,UAAWJ,UAAWwI,KAAM5E,MACzD,IAAIgB,YAAc,CACd7E,KAAMA,KACNK,UAAWA,UACXJ,UAAWA,UACXyI,SAAUD,KACVlE,UAAWV,MAEflE,EAAEsE,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,wDACrBC,OAAQ,OACRT,KAAMgB,YACNL,QAAS,SAASC,UACd,GAAIA,UAAYA,SAASC,UAAW,CAChC,IAAII,UAAY1B,KAAKC,MAAML,aAAaC,QAAQ,sBAAwB,EACpE8B,aAAeC,KAAKC,IAAIH,UAAY,EAAG,GAC3C9B,aAAakC,QAAQ,mBAAoB9B,KAAK+B,UAAUJ,eACxDpF,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASE,MAC1C,MACQF,SAASW,UAAYX,SAASP,MAC9B7E,OAAOgG,eAAiB,KACxB1F,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASa,KACtCC,YAAW,WACPlG,OAAOmG,SAASC,KAAOC,UAAUjB,SAASP,IAC7C,GAAE,KAGf,GAER,CA9aoCyE,CAAkB3I,KAAMK,UAAWJ,UAC/BsI,OAAOC,OAAQD,OAAO1E,KAElC,IAER,GACD,IACP,CACA,GAAI4D,cAAe,CAEf,MAAMmB,gBAAkBjJ,EAAE,SAASkJ,SAAS,4BAOtCC,UAAY,GANF,GAAGjD,4BACJ,IAAIkD,gBAAgB,CAC/BC,GAAIxB,iBAAmBxC,KAAKiE,MAAsB,GAAhBjE,KAAKkE,UAAiB,EACxDC,KAAMxB,aAAe3C,KAAKiE,MAAsB,IAAhBjE,KAAKkE,UAAqB,EAC1DE,OAAQ9I,SAE2B+I,aACjCC,OAAS3J,EAAE,YACZ4J,KAAK,CACFC,IAAOV,UACPzH,MAAS,OACTC,OAAU,MACVmI,YAAe,IACfC,MAAS,qBACTpG,MAAS,wJAIZvC,GAAG,QAAQ,WACR4I,QAAQC,IAAI,0CAEZ,IACIN,OAAO,GAAGO,cAAcC,YAAY,CAChCC,KAAM,OACNC,UAAWC,KAAKC,OACjBrE,eACN,CAAC,MAAOlB,OACLgF,QAAQhF,MAAM,iCAAkCA,MACpD,CACJ,IAOJ,GANAiE,gBAAgBrC,OAAO+C,QACvB3J,EAAE,QAAQ4G,OAAOqC,iBAGjBpF,cAAcoF,gBAAgB,IAE1BtB,oBAAqB,CAErB3H,EAAE,YAAY4J,KAAK,CACfP,GAAI,SACJ3H,MAAO,MACPC,OAAQ,MACRgC,MAAS,mBACV6G,SAAS,QAGZ3J,SAASlB,iBAAiB,oBAAoB,WAC1C,GAAiC,YAA7BkB,SAAS4J,gBAA+B,CACxC,IAAItF,UAAY1B,KAAKC,MAAML,aAAaC,QAAQ,sBAAwB,EACpE8B,aAAeC,KAAKC,IAAIH,UAAY,EAAG,GAC3C9B,aAAakC,QAAQ,mBAAoB9B,KAAK+B,UAAUJ,eACxD,IAAIgB,QAAU,oCACO,IAAjBhB,aACAgB,QAAU,mDAAmDhB,6BACtDA,aAAe,IACtBgB,QAAU,mDAAmDhB,+BAEjEpF,EAAEa,UAAUmC,QAAQ,QAASoD,SAG7BpG,EAAEsE,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,+CACrBC,OAAQ,OACRT,KAAM,CACF7D,KAAMA,KACNK,UAAWA,UACXJ,UAAWA,UACXoK,KAAK,GAET7F,QAAS,SAASC,UACVA,SAASW,UAAYX,SAASP,MAC9B7E,OAAOgG,eAAiB,KACxB1F,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASa,KACtCC,YAAW,WACPlG,OAAOmG,SAASC,KAAOC,UAAUjB,SAASP,IAC7C,GAAE,KAEX,GAER,CACJ,IAGIoG,OAAS,IAAIvK,OAAOC,KAAMC,UAAWI,UAAWC,QACpD,IAAIiK,aAAc,EAGlBlL,OAAOC,iBAAiB,WAAW,SAASC,OAOxC,GANAoK,QAAQC,IAAI,oBAAqB,CAC7BY,OAAQjL,MAAMiL,OACdC,eAAgB5E,eAChBhC,KAAMtE,MAAMsE,OAGZtE,MAAMiL,SAAW3E,eAAgB,CACjC,MAAMhC,KAAOtE,MAAMsE,KACnB,GAAkB,UAAdA,KAAKkG,KACLJ,QAAQC,IAAI,qCACZW,aAAc,OACX,GAAkB,qBAAd1G,KAAKkG,KAA6B,CACzCJ,QAAQC,IAAI,yCAEZ,IAAIc,QAAUJ,OAAOzJ,OAAO8C,WAAW,MACnCgH,IAAM,IAAIC,MACdD,IAAIE,OAAS,WACTH,QAAQ9G,UAAU+G,IAAK,EAAG,EAAGL,OAAOjJ,MAAOiJ,OAAOhJ,QAClD,IAAIwJ,UAAYR,OAAOzJ,OAAOiD,UAAU,aACxCnE,EAAEsE,KAAK,CACHC,IAAKC,EAAEC,IAAIC,QAAU,+CACrBC,OAAQ,OACRT,KAAM,CACFU,UAAWuG,UACX9K,KAAMsK,OAAOtK,KACbK,UAAWiK,OAAOjK,UAClBJ,UAAWqK,OAAOrK,WAEtBuE,QAAS,SAASC,UACd,GAAIA,UAAYA,SAASC,UAAW,CAChC,IAAII,UAAY1B,KAAKC,MAAML,aAAaC,QAAQ,sBAAwB,EACpE8B,aAAeC,KAAKC,IAAIH,UAAY,EAAG,GAC3C9B,aAAakC,QAAQ,mBAAoB9B,KAAK+B,UAAUJ,eACxDpF,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASE,MACzC,MAAUF,SAASW,UAAYX,SAASP,MACrC7E,OAAOgG,eAAiB,KACxB1F,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASa,KACtCC,YAAW,WACPlG,OAAOmG,SAASC,KAAOC,UAAUjB,SAASP,IAC7C,GAAE,KAEX,KAGRyG,IAAInB,IAAM3F,KAAKiH,SACnB,CACJ,MACInB,QAAQC,IAAI,2BAA4B,CACpCmB,SAAUxL,MAAMiL,OAChBQ,SAAUnF,gBAGtB,IAGAqC,aAAY,WACR,GAAIqC,YAAa,CACbZ,QAAQC,IAAI,kDACZ,IACIN,OAAO,GAAGO,cAAcC,YAAY,CAChCC,KAAM,uBACNC,UAAWC,KAAKC,OACjBrE,eACN,CAAC,MAAOlB,OACLgF,QAAQhF,MAAM,mCAAoCA,OAClD4F,aAAc,CAClB,CACJ,KAAO,CACHZ,QAAQC,IAAI,0CACZ,IACIN,OAAO,GAAGO,cAAcC,YAAY,CAChCC,KAAM,OACNC,UAAWC,KAAKC,OACjBrE,eACN,CAAC,MAAOlB,OACLgF,QAAQhF,MAAM,8BAA+BA,MACjD,CACJ,CACJ,GAAiB,IAAdkD,YACP,CACJ,MA0BR,SAAyB7H,KAAMC,UAAWqH,oBAAqBjH,UAC3D4K,QAASrD,mBACTC,YAAavH,OAAQ4K,UACrBC,QAAQ,CAAC,cAAc,WACM,OAArB9I,iBAOgB,YADF+I,kBAEdzJ,UAAUE,aACNF,UAAUE,cACVF,UAAU0J,oBACV1J,UAAU2J,iBACV3J,UAAU4J,eAGdC,kBAAoB,SAAS1I,QAASd,QAClCc,QAAQZ,UAAYF,QAGxBL,UAAUC,aAAaC,aAAa,CAACC,MA9VjC,KA8VqDpB,MA7VrD,OA8VHqB,MAAK,SAASC,QAEX,GADAK,iBAAmBL,OACfsF,oBAAqB,CACrB3H,EAAE,YAAY4J,KAAK,CAACP,GAAI,SAAU3H,MAAO,MACrCC,OAAQ,MAAOgC,MAAS,mBAAmB6G,SAAS,QACxDxK,EAAE,WAAW4J,KAAK,CACdP,GAAM,QACNyC,MAAS,kCACTpK,MAAS,MACTC,OAAU,MACVoK,SAAY,aACbC,IAAI,UAAW/D,mBAAqB,QAAU,QAC9CuC,SAAS,QACZ3J,SAASlB,iBAAiB,oBAAoB,WAC1C,GAAiC,YAA7BkB,SAAS4J,gBAA+B,CACxC,IAAItF,UAAY1B,KAAKC,MAAML,aAAaC,QAAQ,sBAAwB,EACpE8B,aAAeC,KAAKC,IAAIH,UAAY,EAAG,GAC3C9B,aAAakC,QAAQ,mBAAoB9B,KAAK+B,UAAUJ,eACxD,IAAIgB,QAAU,oCACO,IAAjBhB,aACAgB,QAAU,mDAAmDhB,6BACtDA,aAAe,IACtBgB,QAAU,mDAAmDhB,+BAEjEpF,EAAEa,UAAUmC,QAAQ,QAASoD,SAC7BpG,EAAEsE,KAAK,CACPC,IAAKC,EAAEC,IAAIC,QAAU,+CACrBC,OAAQ,OACRT,KAAM,CAAC7D,KAAMA,KAAMK,UAAWA,UAAWJ,UAAWA,UAAWoK,KAAK,GAChE7F,QAAS,SAASC,UACVA,SAASW,UAAYX,SAASP,MAC9B7E,OAAOgG,eAAiB,KACxB1F,EAAEa,UAAUmC,QAAQ,QAAS8B,SAASa,KACtCC,YAAW,WACPlG,OAAOmG,SAASC,KAAOC,UAAUjB,SAASP,IAC7C,GAAE,KAEX,GAER,CACJ,IACA,IAAIoG,OAAS,IAAIvK,OAAOC,KAAMC,UAAWI,UAAWC,QACpDgK,OAAO7I,cACPyG,YAAYoC,OAAO1F,gBAAgB3D,KAAKqJ,QAAuB,IAAdzC,YACrD,CACA,OAAO7F,MACX,IACCyB,OAAM,SAASkB,OAEZ,GAAI2C,qBAEoB,YADF8D,iBACa,CAC3B,IAAId,OAAS,IAAIvK,OAAOC,KAAMC,UAAWI,UAAWC,QACpDgK,OAAO7I,cACPyG,YAAYoC,OAAO1F,gBAAgB3D,KAAKqJ,QAAuB,IAAdzC,YACrD,CAEJ,MAAMlD,KACV,IACCiH,SAAQ,WACDV,UACAA,UAER,MAEA7I,iBAaX,WACG,MACMwJ,YADe,IAAIC,cACOC,+BAC1BC,WAAaxL,SAASyL,cAAc,UAAUC,cAAc,GAG5DC,YAAc,IAAIC,YAGxB,OAFAD,YAAYE,SAASR,WAAW7J,OAAOa,iBAAiB,IACxDsJ,YAAYE,SAASL,WAAWvJ,iBAAiB,IAC1C0J,WACX,CAvB+BG,GACfpB,UACAA,YAtFAA,UACAA,UAwFZ,GACJ,CAxHYqB,CAAgBvM,KAAMC,UAAWqH,oBAAqBjH,UAClD4K,EAASrD,mBAAoBC,YAC7BvH,OAEZ,KAzQ0B,CACtB,IAAIgK,OA6CJ,GA5C4B,aAAxB9J,SAASgM,WACT7M,EAAE,qCAAqCG,KAAK,YAAY,GAExDH,EAAEN,QAAQ0B,GAAG,QAAQ,WACjBpB,EAAE,qCAAqCG,KAAK,YAAY,EAC5D,IAEJwK,OAAS,IAAIvK,OAAOC,KAAMC,UAAWI,UAAWC,QAChDX,EAAE,qCAAqCoB,GAAG,SAAS,WAC/CiC,aAAayJ,WAAW,iBACxBnC,OAAO7I,aACX,IAEA9B,EAAE,IAAM2K,OAAO/I,eAAeR,GAAG,SAAS,SAASwB,GAC/CA,EAAEC,iBACF8H,OAAO5G,aACX,IAEA/D,EAAE,IAAM2K,OAAO9I,UAAUT,GAAG,SAAS,SAASwB,GAC1CA,EAAEC,iBACF8H,OAAOxE,QACX,IACAnG,EAAE,cAAcoB,GAAG,SAAS,WACxBuJ,OAAOtD,aACPsD,OAAO3E,cACPhG,EAAE,oBAAoBG,KAAK,YAAY,GACvCkD,aAAayJ,WAAW,gBAC5B,IACA9M,EAAEa,UAAUO,GAAG,QAAS,gBAAgB,gBACd,IAAXuJ,QAAuD,mBAAtBA,OAAOtD,aAC/CsD,OAAOtD,aACPsD,OAAO3E,cACPhG,EAAE,oBAAoBG,KAAK,YAAY,GACvCkD,aAAayJ,WAAW,iBAEhC,IACAjM,SAASlB,iBAAiB,WAAW,SAASC,OACxB,WAAdA,MAAMuH,MACNwD,OAAOtD,aACPsD,OAAO3E,cACPhG,EAAE,oBAAoBG,KAAK,YAAY,GACvCkD,aAAayJ,WAAW,iBAEhC,IACqB,iBAAjB/E,aAAiC,CACdrI,OAAOmG,SAASC,KACpBiH,SAAS,qBACpBpC,OAAO7I,aAEf,CACJ,IAiWJ,SAAS2J,iBAGL,OAFgB,IAAIrC,gBAAgB1J,OAAOmG,SAASmH,QAC5BC,IAAI,UAEhC,CAuBJ,SAASpJ,cAAcV,SACnB,IAAI+J,QAAU,EACVC,QAAU,EACVC,YAAa,EACjBjK,QAAQxD,iBAAiB,aAAa,SAASiD,GAC3CwK,YAAa,EACbF,QAAUtK,EAAEyK,QAAUlK,QAAQmK,wBAAwB/J,KACtD4J,QAAUvK,EAAE2K,QAAUpK,QAAQmK,wBAAwB9J,IACtDL,QAAQQ,MAAM6J,OAAS,UAC3B,IACA3M,SAASlB,iBAAiB,aAAa,SAASiD,GAC3CwK,YAGAK,uBAAsB,KACnB,IAAIC,QAAU9K,EAAEyK,QAAUH,QACtBS,OAAS/K,EAAE2K,QAAUJ,QACzB,MAAMS,QAAUlO,OAAOmO,WAAa1K,QAAQ2K,YACtCC,OAASrO,OAAOsO,YAAc7K,QAAQ8K,aAC5CP,QAAUrI,KAAKC,IAAI,EAAGD,KAAK6I,IAAIR,QAASE,UACxCD,OAAStI,KAAKC,IAAI,EAAGD,KAAK6I,IAAIP,OAAQI,SACP,UAA3B5K,QAAQQ,MAAMwK,WACdhL,QAAQQ,MAAMwK,SAAW,SAE5BhL,QAAQQ,MAAMJ,KAAO,GAAGmK,YACzBvK,QAAQQ,MAAMH,IAAM,GAAGmK,UAAU,GAEzC,IACA9M,SAASlB,iBAAiB,WAAW,WAC7ByN,aACAA,YAAa,EACbjK,QAAQQ,MAAM6J,OAAS,OACvBnK,aAAakC,QAAQ,gBAAiB9B,KAAK+B,UAAU,CACjDjC,KAAM6K,SAASjL,QAAQQ,MAAMJ,KAAM,IACnCC,IAAK4K,SAASjL,QAAQQ,MAAMH,IAAK,OAG7C,GACJ,CAwFA,SAASuD,mBACL/G,EAAE,iBAAiBqO,SAAQ,WACvBrO,EAAEc,MAAM4F,QACZ,IACA1G,EAAEa,UAAUyN,IAAI,SAChBtO,EAAEa,UAAUyN,IAAI,UACpB,CACA"}