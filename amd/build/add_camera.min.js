/**
 * JavaScript class for Camera
 *
 * @subpackage quizproctoring
 * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("quizaccess_quizproctoring/add_camera",["jquery","core/str","core/modal_factory"],(function($,str,ModalFactory){var Camera=function(cmid){let mainimage=arguments.length>1&&void 0!==arguments[1]&&arguments[1],attemptid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;var docElement=$(document);this.video=document.getElementById(this.videoid),this.canvas=document.getElementById(this.canvasid),this.cmid=cmid,this.mainimage=mainimage,this.attemptid=attemptid,docElement.on("popup",this.showpopup.bind(this)),setTimeout(navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((function(stream){this.video&&(this.video.srcObject=stream,this.video.play())})).catch((function(){})),1e4)};Camera.prototype.video=!1,Camera.prototype.videoid="video",Camera.prototype.canvas=!1,Camera.prototype.canvasid="canvas",Camera.prototype.width=320,Camera.prototype.height=240,Camera.prototype.takepictureid="takepicture",Camera.prototype.retakeid="retake",Camera.prototype.cmid=!1,Camera.prototype.mainimage=!1,Camera.prototype.attemptid=!1,Camera.prototype.takepicture=function(){this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);var data=this.canvas.toDataURL("image/png");$("#"+this.videoid).hide(),$("#"+this.takepictureid).hide(),$("#"+this.canvasid).show(),$("#"+this.retakeid).show(),$("input[name='userimg']").val(data),$("#id_submitbutton").prop("disabled",!0),$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:{imgBase64:data,cmid:this.cmid,attemptid:this.attemptid,mainimage:this.mainimage},success:function(response){response&&response.errorcode?($("input[name='userimg']").val(""),$(document).trigger("popup",response.error)):$("#id_submitbutton").prop("disabled",!1)}})},Camera.prototype.proctoringimage=function(){this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);var data=this.canvas.toDataURL("image/png");$.ajax({url:M.cfg.wwwroot+"/mod/quiz/accessrule/quizproctoring/ajax.php",method:"POST",data:{imgBase64:data,cmid:this.cmid,attemptid:this.attemptid,mainimage:this.mainimage},success:function(response){response&&response.errorcode?$(document).trigger("popup",response.error):response.redirect&&response.url&&(window.onbeforeunload=null,window.location.href=encodeURI(response.url))}})},Camera.prototype.retake=function(){$("input[name='userimg']").val(""),$("#"+this.videoid).show(this.cmid),$("#"+this.takepictureid).show(),$("#"+this.canvasid).hide(),$("#"+this.retakeid).hide()},Camera.prototype.showpopup=function(event,message){ModalFactory.create({body:message}).then((function(modal){modal.show()}))};return{init:function(cmid,mainimage){let attemptid=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,setinterval=arguments.length>4&&void 0!==arguments[4]?arguments[4]:300;var camera;arguments.length>2&&void 0!==arguments[2]&&arguments[2]?($("<canvas>").attr({id:"canvas",width:"280",height:"240",style:"display: none;"}).appendTo("body"),$("<video>").attr({id:"video",class:"quizaccess_quizproctoring-video",width:"280",height:"240",autoplay:"autoplay"}).appendTo("body"),camera=new Camera(cmid,mainimage,attemptid),setInterval(camera.proctoringimage.bind(camera),1e3*setinterval)):(camera=new Camera(cmid,mainimage,attemptid),$("#"+camera.takepictureid).on("click",(function(e){e.preventDefault(),camera.takepicture()})),$("#"+camera.retakeid).on("click",(function(e){e.preventDefault(),camera.retake()})),$("#id_submitbutton").on("click",(function(e){""==$("input[name='userimg']").val()&&(e.preventDefault(),ModalFactory.create({body:str.get_string("clickpicture","quizaccess_quizproctoring")}).then((function(modal){modal.show()})))})))}}}));

//# sourceMappingURL=add_camera.min.js.map